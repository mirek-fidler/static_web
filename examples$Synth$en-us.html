<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML lang="en-us">
<HEAD>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="Generator" CONTENT="U++ HTML Package">
<TITLE>Demos / Synth :: U++</TITLE>
<STYLE TYPE="text/css"><!--
.A{margin:0px 0px 0px 0px;text-indent:0px;text-align:left;color:#000000;font-family:sans-serif;font-size:10pt;font-weight:normal;font-style:normal;}
.B{font-size:12pt;}
.C{margin:0px 0px 0px 0px;text-indent:0px;text-align:left;color:#000000;font-family:serif;font-size:24pt;font-weight:bold;font-style:normal;}
.D{margin:0px 0px 0px 0px;text-indent:0px;text-align:left;color:#000000;font-family:sans-serif;font-size:12pt;font-weight:normal;font-style:normal;}
.E{margin:0px 0px 0px 0px;text-indent:0px;text-align:left;color:#000000;font-family:sans-serif;font-size:16pt;font-weight:bold;font-style:normal;}
.F{margin:0px 0px 0px 0px;text-indent:0px;text-align:left;color:#000000;font-family:monospace;font-size:9pt;font-weight:normal;font-style:normal;}
.G{color:#0000ff;}
.H{margin:0px 0px 0px 0px;text-indent:0px;text-align:left;color:#0000ff;font-family:monospace;font-size:9pt;font-weight:normal;font-style:normal;}
.I{color:#000000;}
a.l1         { text-decoration:none; font-size: 8pt; font-family: sans-serif; font-weight: normal; }
a.l1:link    { color:#000000; }
a.l1:visited { color:#000080; }
a.l1:hover   { color:#9933CC; }
a.l1:active  { color:#000000; }
a.l2         { text-decoration:none; font-size: 12pt; font-family: sans-serif; font-variant: small-caps; }
a.l2:link    { color:#0066FF; }
a.l2:visited { color:#FF6600; }
a.l2:hover   { color:#BC0624; }
a.l2:active  { color:#BC0024; }

-->
</STYLE>
<META NAME="keywords" CONTENT="framework, toolkit, widget, c++, visual, studio, dev-cpp, builder, ide, class, component,wxwidgets, qt, rapid, application, development, rad, mfc, linux, macos, gui, sdl, directx, desktop"><META name="robots" content="index,follow">
<LINK rel="alternate" type="application/rss+xml" title="SVN changes" href="svnchanges.xml">
<LINK rel="shortcut icon" type="image/png" href="favicon.png">
</HEAD><BODY BGCOLOR="#D2D9D2" ALINK="#800000" LINK="#000000" VLINK="#000080"><TABLE BORDER="0" CELLSPACING="0" CELLPADDING="0" WIDTH="100%"><TR><TD COLSPAN="3"><TABLE BORDER="0" CELLSPACING="0" CELLPADDING="0" WIDTH="100%" BGCOLOR="#FFFFFF" style="border: 1px solid #6E89AE;padding-left: 10px;padding-right: 0px;padding-top: 0px;padding-bottom: 0px;"><TR><TD><A HREF="index.html"><IMG SRC="0i.png" ALT="" BORDER="0"></A>
</TD>
<TD ALIGN="RIGHT" VALIGN="BOTTOM" STYLE="padding-bottom: 5px; background-image: url('1i.png')"><span style="font-size: 14pt; font-family: sans-serif;"><script type="text/javascript"><!--
google_ad_client = "pub-1082147624384270";
google_ad_width = 468;
google_ad_height = 60;
google_ad_format = "468x60_as";
google_ad_type = "text_image";
google_ad_channel = "";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_text = "000000";
google_color_url = "008000";
//--></script>
<script type="text/javascript"
  src="https://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
&nbsp;&nbsp;</span>
</TD>
</TR>
</TABLE>
</TD>
</TR>
</TABLE>
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="0" WIDTH="100%"><TR><TD COLSPAN="3" BGCOLOR="#D2D9D2" HEIGHT="6"></TD>
</TR>
<TR><TD VALIGN="TOP" ALIGN="CENTER"><TABLE BORDER="0" CELLSPACING="0" CELLPADDING="0" WIDTH="160"><TR><TD ALIGN="CENTER"><TABLE BORDER="0" CELLSPACING="0" CELLPADDING="0" WIDTH="100%" BGCOLOR="#FFFFFF" style="border-style: solid; border-width: 1px; border-color: #6E89AE;padding: 0px"><TR><TD WIDTH="100%" VALIGN="MIDDLE" STYLE="background-image: url('2i.png'); border: 0px solid black; padding-left:12px; padding-right:0px; padding-top:6px; padding-bottom:6px;"><A HREF="www$uppweb$overview$en-us.html" CLASS="l1">Overview</A>
</TD>
</TR>
<TR><TD WIDTH="100%" VALIGN="MIDDLE" STYLE="background-image: url('2i.png'); border: 0px solid black; padding-left:12px; padding-right:0px; padding-top:6px; padding-bottom:6px; border-top: 1px solid #6E89AE;"><A HREF="www$uppweb$examples$en-us.html" CLASS="l1">Examples</A>
</TD>
</TR>
<TR><TD WIDTH="100%" VALIGN="MIDDLE" STYLE="background-image: url('2i.png'); border: 0px solid black; padding-left:12px; padding-right:0px; padding-top:6px; padding-bottom:6px; border-top: 1px solid #6E89AE;"><A HREF="www$uppweb$ss$en-us.html" CLASS="l1">Screenshots</A>
</TD>
</TR>
<TR><TD WIDTH="100%" VALIGN="MIDDLE" STYLE="background-image: url('2i.png'); border: 0px solid black; padding-left:12px; padding-right:0px; padding-top:6px; padding-bottom:6px; border-top: 1px solid #6E89AE;"><A HREF="www$uppweb$comparison$en-us.html" CLASS="l1">Comparisons</A>
</TD>
</TR>
<TR><TD WIDTH="100%" VALIGN="MIDDLE" STYLE="background-image: url('2i.png'); border: 0px solid black; padding-left:12px; padding-right:0px; padding-top:6px; padding-bottom:6px; border-top: 1px solid #6E89AE;"><A HREF="www$uppweb$apps$en-us.html" CLASS="l1">Applications</A>
</TD>
</TR>
<TR><TD WIDTH="100%" VALIGN="MIDDLE" STYLE="background-image: url('2i.png'); border: 0px solid black; padding-left:12px; padding-right:0px; padding-top:6px; padding-bottom:6px; border-top: 1px solid #6E89AE;"><A HREF="www$uppweb$download$en-us.html" CLASS="l1">Download</A>
</TD>
</TR>
<TR><TD WIDTH="100%" VALIGN="MIDDLE" STYLE="background-image: url('2i.png'); border: 0px solid black; padding-left:12px; padding-right:0px; padding-top:6px; padding-bottom:6px; border-top: 1px solid #6E89AE;"><A HREF="www$uppweb$documentation$en-us.html" CLASS="l1">Documentation</A>
</TD>
</TR>
<TR><TD WIDTH="100%" VALIGN="MIDDLE" STYLE="background-image: url('2i.png'); border: 0px solid black; padding-left:12px; padding-right:0px; padding-top:6px; padding-bottom:6px; border-top: 1px solid #6E89AE;"><A HREF="www$uppweb$Tutorials$en-us.html" CLASS="l1">Tutorials</A>
</TD>
</TR>
<TR><TD WIDTH="100%" VALIGN="MIDDLE" STYLE="background-image: url('2i.png'); border: 0px solid black; padding-left:12px; padding-right:0px; padding-top:6px; padding-bottom:6px; border-top: 1px solid #6E89AE;"><A HREF="app$ide$UppHub$en-us.html" CLASS="l1">UppHub</A>
</TD>
</TR>
<TR><TD WIDTH="100%" VALIGN="MIDDLE" STYLE="background-image: url('2i.png'); border: 0px solid black; padding-left:12px; padding-right:0px; padding-top:6px; padding-bottom:6px; border-top: 1px solid #6E89AE;"><A HREF="www$uppweb$Roadmap$en-us.html" CLASS="l1">Status & Roadmap</A>
</TD>
</TR>
<TR><TD WIDTH="100%" VALIGN="MIDDLE" STYLE="background-image: url('2i.png'); border: 0px solid black; padding-left:12px; padding-right:0px; padding-top:6px; padding-bottom:6px; border-top: 1px solid #6E89AE;"><A HREF="www$uppweb$FAQ$en-us.html" CLASS="l1">FAQ</A>
</TD>
</TR>
<TR><TD WIDTH="100%" VALIGN="MIDDLE" STYLE="background-image: url('2i.png'); border: 0px solid black; padding-left:12px; padding-right:0px; padding-top:6px; padding-bottom:6px; border-top: 1px solid #6E89AE;"><A HREF="app$ide$About$en-us.html" CLASS="l1">Authors & License</A>
</TD>
</TR>
<TR><TD WIDTH="100%" VALIGN="MIDDLE" STYLE="background-image: url('2i.png'); border: 0px solid black; padding-left:12px; padding-right:0px; padding-top:6px; padding-bottom:6px; border-top: 1px solid #6E89AE;"><A HREF="https://www.ultimatepp.org/forums" CLASS="l1">Forums</A>
</TD>
</TR>
<TR><TD WIDTH="100%" VALIGN="MIDDLE" STYLE="background-image: url('2i.png'); border: 0px solid black; padding-left:12px; padding-right:0px; padding-top:6px; padding-bottom:6px; border-top: 1px solid #6E89AE;"><A HREF="www$uppweb$Funding$en-us.html" CLASS="l1">Funding U++</A>
</TD>
</TR>
</TABLE>
<TABLE BORDER="0" WIDTH="100%"><TR><TD></TD>
</TR>
</TABLE>
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="0" WIDTH="100%" BGCOLOR="#FFFFFF" style="border-style: solid; border-width: 1px; border-color: #6E89AE;padding: 0px"><TR><TD WIDTH="100%" VALIGN="MIDDLE" STYLE="background-image: url('3i.png'); border: 0px solid black;padding-left:12px; padding-right:0px; padding-top:1px; padding-bottom:1px;color:#FFFFFF;"><B><span style="font-size: 8pt; font-family: sans-serif;">Search on this site</span>
</B>
</TD>
</TR>
<TR><TD WIDTH="100%" VALIGN="MIDDLE" STYLE="background-image: url('2i.png'); border: 0px solid black; padding-left:6px; padding-right:0px; padding-top:4px; padding-bottom:4px;border-top: 1px solid #6E89AE;"><TABLE BORDER="0" CELLSPACING="0" CELLPADDING="0" WIDTH="100%"><TR><TD><IMG SRC="4i.png" ALT="" BORDER="0"></TD>
<TD><FORM ACTION="https://www.google.com/search" METHOD="GET" STYLE="margin:0px;padding:0px;"><INPUT TYPE="HIDDEN" NAME="ie" VALUE="UTF-8"><INPUT TYPE="HIDDEN" NAME="oe" VALUE="UTF-8"><INPUT TYPE="TEXT" NAME="q" SIZE="15" MAXLENGTH="256" placeholder="Site search"><INPUT TYPE="HIDDEN" NAME="sitesearch" VALUE="ultimatepp.org"></FORM>
</TD>
</TR>
</TABLE>
</TD>
</TR>
</TABLE>
<TABLE BORDER="0" WIDTH="100%"><TR><TD></TD>
</TR>
</TABLE>
<br><div id="fb-root"></div>
<script type="text/javascript">(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

<div class="fb-like" data-href="https://www.facebook.com/pages/Upp-Framework/262346610476027?sk=wall" data-send="false" data-layout="button_count" data-width="160" data-show-faces="false" data-font="arial"></div>
<br><br><script type="text/javascript"><!--
google_ad_client = "pub-1082147624384270";
google_ad_width = 160;
google_ad_height = 600;
google_ad_format = "160x600_as";
google_ad_type = "text_image";
google_ad_channel = "";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_text = "000000";
google_color_url = "008000";
//--></script>
<script type="text/javascript"
  src="https://pagead2.googlesyndication.com/pagead/show_ads.js">
</script><br><br><script type="text/javascript"><!--
google_ad_client = "pub-1082147624384270";
google_ad_width = 160;
google_ad_height = 90;
google_ad_format = "160x90_0ads_al_s";
google_ad_channel = "";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_text = "000000";
google_color_url = "008000";
//--></script>
<script type="text/javascript"
  src="https://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<br><br><br><br><br><br><A HREF="https://sourceforge.net/projects/upp/"><IMG SRC="https://sourceforge.net/sflogo.php?group_id=93970&amp;type=2" ALT="SourceForge.net Logo" BORDER="0" WIDTH="125" HEIGHT="37"></A>
<br><br><A HREF="https://flathub.org/en/apps/org.ultimatepp.TheIDE"><IMG SRC="5i.png" ALT="SourceForge.net Logo" BORDER="0" WIDTH="125" HEIGHT="37"></A>
<br><br><div style="background-color:#ffffff;width:125;height:35"><A HREF="https://github.com/ultimatepp"><IMG SRC="6i.png" ALT="GitHub Logo" BORDER="0" WIDTH="125" HEIGHT="35"></A>
</div><br><div style="background-color:#ffffff;width:125;height:35"><div style="height:5"></div><A HREF="https://discord.gg/8XzqQzXZzb"><IMG SRC="https://assets-global.website-files.com/6257adef93867e50d84d30e2/636e0b5061df29d55a92d945_full_logo_blurple_RGB.svg" ALT="Discord Logo" BORDER="0" WIDTH="125" HEIGHT="25"></A>
</div><br></TD>
</TR>
</TABLE>
</TD>
<TD VALIGN="TOP" BGCOLOR="#D2D9D2"><TABLE BORDER="0" CELLSPACING="0" CELLPADDING="0" WIDTH="6"><TR><TD></TD>
</TR>
</TABLE>
</TD>
<TD VALIGN="TOP" WIDTH="100%" BGCOLOR="#D2D9D2"><TABLE BORDER="0" CELLSPACING="0" CELLPADDING="0" BGCOLOR="#FFFFFF" WIDTH="100%" style="border-style: solid; border-width: 1px; border-color: #6E89AE;padding: 10px;;"><TR><TD><TABLE BORDER="0" CELLSPACING="0" CELLPADDING="0" WIDTH="100%"><TR><TD><p class="C">Synth</p>
<p class="D">&nbsp;</p>
<p class="D">&nbsp;</p>
<p class="A">&nbsp;</p>
<p class="A">&nbsp;</p>
<p class="E">Synth.h</p>
<p class="A">&nbsp;</p>
<p class="F"><span class="G">#ifndef</span> _Synth_Synth_h</p>
<p class="F"><span class="G">#define</span> _Synth_Synth_h</p>
<p class="F">&nbsp;</p>
<p class="H">#include<span class="I"> </span>&lt;<span class="I">Core</span>/<span class="I">Core</span>.<span class="I">h</span>&gt;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">using</span> <span class="G">namespace</span> Upp;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">enum</span> FORMS {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;WAVEFORM_SIN <span class="G">=</span> 0,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;WAVEFORM_SQUARE <span class="G">=</span> 1,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;WAVEFORM_TRIANGLE <span class="G">=</span> 2,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;WAVEFORM_SAWTOOTH <span class="G">=</span> 3,</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;WAVEFORM_FIRSTSAMPLE <span class="G">=</span> 4,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;WAVEFORM_SAXOPHONE <span class="G">=</span> WAVEFORM_FIRSTSAMPLE,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;WAVEFORM_VIOLIN <span class="G">=</span> 5,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;WAVEFORM_DOUBLEBASS <span class="G">=</span> 6,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;WAVEFORM_BANJO <span class="G">=</span> 7,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;WAVEFORM_TRUMPET <span class="G">=</span> 8,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;WAVEFORM_LASTSAMPLE <span class="G">=</span> 8,</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;WAVEFORM_BROWN <span class="G">=</span> 100,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;WAVEFORM_WHITE <span class="G">=</span> 101,</p>
<p class="F">};</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">struct</span> FMOP {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> duration <span class="G">=</span> 99000;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> volume <span class="G">=</span> 0;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> f <span class="G">=</span> 1;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> fdrift <span class="G">=</span> 0;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> attack <span class="G">=</span> 100;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> decay <span class="G">=</span> 100;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> sustain <span class="G">=</span> 100;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> release <span class="G">=</span> 100;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> &nbsp;&nbsp;&nbsp;waveform <span class="G">=</span> WAVEFORM_SIN;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;String Save() <span class="G">const</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">const</span> <span class="G">char</span> <span class="G">*</span>Load(<span class="G">const</span> <span class="G">char</span> <span class="G">*</span>s);</p>
<p class="F">};</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#define</span> OPCOUNT 5</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">struct</span> Sound {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> f <span class="G">=</span> 440;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;FMOP &nbsp;&nbsp;op<span class="G">[</span>OPCOUNT<span class="G">]</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> pan <span class="G">=</span> 0<span class="G">.</span>5;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;String Save() <span class="G">const</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;&nbsp;Load(<span class="G">const</span> <span class="G">char</span> <span class="G">*</span>s);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Sound();</p>
<p class="F">};</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">struct</span> SoundGen {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">struct</span> FMOPGen <span class="G">:</span> FMOP {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> &nbsp;&nbsp;&nbsp;&nbsp;p;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> &nbsp;v;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> &nbsp;n;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> <span class="G">*</span>wave_tab;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;&nbsp;Start() { v <span class="G">=</span> 1e<span class="G">-</span>3; p <span class="G">=</span> 0; n <span class="G">=</span> 0; }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;&nbsp;Comp();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String ToString() <span class="G">const</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> Evaluate(<span class="G">int</span> t, <span class="G">double</span> mf, <span class="G">double</span> mod, <span class="G">double&amp;</span> current_volume);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;};</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serial;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;param_serial;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;id;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;priority;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> &nbsp;&nbsp;f <span class="G">=</span> 440;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">float</span> &nbsp;&nbsp;&nbsp;lpan <span class="G">=</span> 0<span class="G">.</span>5f;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">float</span> &nbsp;&nbsp;&nbsp;rpan <span class="G">=</span> 0<span class="G">.</span>5f;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delay;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;FMOPGen &nbsp;op<span class="G">[</span>OPCOUNT<span class="G">]</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">float</span> &nbsp;&nbsp;&nbsp;feedback<span class="G">[</span>8192<span class="G">]</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> &nbsp;&nbsp;current_volume <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> &nbsp;&nbsp;lfo_mod <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;&nbsp;&nbsp;&nbsp;Start(<span class="G">const</span> Sound<span class="G">&amp;</span> s);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">float</span> &nbsp;&nbsp;&nbsp;Get();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;String &nbsp;&nbsp;ToString() <span class="G">const</span>;</p>
<p class="F">};</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#define</span> CHUNK_SIZE &nbsp;&nbsp;512</p>
<p class="F"><span class="G">#define</span> NUM_CHANNELS 20</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> InitSoundSynth(<span class="G">bool</span> initsdl <span class="G">=</span> <span class="G">true</span>);</p>
<p class="F"><span class="G">void</span> CloseSoundSynth(<span class="G">bool</span> exitsdl <span class="G">=</span> <span class="G">true</span>);</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> SetChannel(<span class="G">int</span> chi, <span class="G">const</span> Sound<span class="G">&amp;</span> c, <span class="G">int</span> priority <span class="G">=</span> INT_MAX, <span class="G">int</span> id <span class="G">=</span> 0);</p>
<p class="F"><span class="G">void</span> SetChannelVolume(<span class="G">int</span> chi, <span class="G">double</span> volume);</p>
<p class="F"><span class="G">void</span> StopChannelById(<span class="G">int</span> id);</p>
<p class="F"><span class="G">int</span> &nbsp;FindChannel(<span class="G">int</span> priority, <span class="G">int</span> from, <span class="G">double</span> new_volume);</p>
<p class="F"><span class="G">void</span> StopChannels(<span class="G">int</span> id);</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> SetGlobalVolume(<span class="G">float</span> vol);</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">struct</span> SoundEvent <span class="G">:</span> Moveable<span class="G">&lt;</span>SoundEvent<span class="G">&gt;</span> {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Sound <span class="G">*</span>snd;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">float</span> &nbsp;duration;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">float</span> &nbsp;frequency;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">float</span> &nbsp;volume;</p>
<p class="F">};</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">struct</span> SoundSequence {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">mutable</span> <span class="G">int</span> &nbsp;at <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> cursor <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> loop <span class="G">=</span> Null;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ArrayMap<span class="G">&lt;</span>String, Sound<span class="G">&gt;</span> &nbsp;&nbsp;&nbsp;bank;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Vector<span class="G">&lt;</span>Vector<span class="G">&lt;</span>SoundEvent<span class="G">&gt;&gt;</span> event;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GetAt(<span class="G">double</span> at) &nbsp;{ <span class="G">return</span> (<span class="G">int</span>)(at <span class="G">*</span> 44100 <span class="G">/</span> 512); }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Vector<span class="G">&lt;</span>SoundEvent<span class="G">&gt;&amp;</span> At(<span class="G">double</span> at) &nbsp;&nbsp;&nbsp;&nbsp;{ <span class="G">return</span> event<span class="G">.</span>At(GetAt(at)); }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LoopAt(<span class="G">double</span> at) { loop <span class="G">=</span> GetAt(at); }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> &nbsp;SoundIndex(<span class="G">const</span> String<span class="G">&amp;</span> s);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> Put(<span class="G">double</span> at, <span class="G">int</span> i,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> volume, <span class="G">double</span> freqency, <span class="G">double</span> duration, <span class="G">bool</span> direct <span class="G">=</span> <span class="G">false</span>);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> Put(<span class="G">double</span> at, <span class="G">const</span> String<span class="G">&amp;</span> snd,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> volume, <span class="G">double</span> freqency, <span class="G">double</span> duration, <span class="G">bool</span> direct <span class="G">=</span> <span class="G">false</span>);</p>
<p class="F">};</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> PlaySequence(<span class="G">const</span> SoundSequence<span class="G">&amp;</span> s);</p>
<p class="F"><span class="G">void</span> PlayTempSequence(SoundSequence<span class="G">&amp;&amp;</span> s);</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> StopSequencer();</p>
<p class="F"><span class="G">bool</span> IsPlayingSequence();</p>
<p class="F">&nbsp;</p>
<p class="F">SoundSequence ParseQSF(<span class="G">const</span> String<span class="G">&amp;</span> data);</p>
<p class="F">&nbsp;</p>
<p class="H">#endif</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="E">QSF.cpp</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#include</span> &quot;Synth<span class="G">.</span>h&quot;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">struct</span> QSFStatus <span class="G">:</span> Moveable<span class="G">&lt;</span>QSFStatus<span class="G">&gt;</span> {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> tempo <span class="G">=</span> 120;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> &nbsp;&nbsp;&nbsp;sound <span class="G">=</span> <span class="G">-</span>1;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> duration <span class="G">=</span> 1;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> &nbsp;&nbsp;&nbsp;shift <span class="G">=</span> 24;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> volume <span class="G">=</span> 1;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> volume_low <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> volume_high <span class="G">=</span> 1;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> volume_start_at <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> volume_mul <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> GetVolume(<span class="G">double</span> at) <span class="G">const</span> { <span class="G">return</span> clamp(volume <span class="G">+</span> (at <span class="G">-</span> volume_start_at) <span class="G">*</span> volume_mul, volume_low, volume_high); }</p>
<p class="F">};</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">struct</span> QSFParser <span class="G">:</span> SoundSequence, QSFStatus {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lineno;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;String &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;line;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">const</span> <span class="G">char</span> <span class="G">*</span>ptr;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;VectorMap<span class="G">&lt;</span>String, String<span class="G">&gt;</span> macro;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;VectorMap<span class="G">&lt;int</span>, String<span class="G">&gt;</span> errors;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> at <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> at0 <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> end <span class="G">=</span> 0;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Vector<span class="G">&lt;</span>QSFStatus<span class="G">&gt;</span> stack;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Vector<span class="G">&lt;double&gt;</span> at_stack;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;&nbsp;Error(<span class="G">const</span> <span class="G">char</span> <span class="G">*</span>s);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;&nbsp;Spaces();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;String ReadID();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;&nbsp;Expand();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;&nbsp;Sound(<span class="G">const</span> <span class="G">char</span> <span class="G">*</span>s);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;&nbsp;Tone(<span class="G">int</span> tone, <span class="G">double</span> duration);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;&nbsp;Process();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;&nbsp;Parse(Stream<span class="G">&amp;</span> s);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;QSFParser() {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sound(&quot;130<span class="G">.</span>81<span class="G">:</span>L250V100R30<span class="G">::::</span>&quot;);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">};</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> QSFParser<span class="G">::</span>Error(<span class="G">const</span> <span class="G">char</span> <span class="G">*</span>s)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;errors<span class="G">.</span>Add(lineno, s);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> QSFParser<span class="G">::</span>Spaces()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">while</span>(IsSpace(<span class="G">*</span>ptr)) ptr<span class="G">++</span>;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">String QSFParser<span class="G">::</span>ReadID()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Spaces();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;String id;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(IsAlpha(<span class="G">*</span>ptr) <span class="G">||</span> <span class="G">*</span>ptr <span class="G">==</span> '_') {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">const</span> <span class="G">char</span> <span class="G">*</span>b <span class="G">=</span> ptr;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">while</span>(IsAlNum(<span class="G">*</span>ptr) <span class="G">||</span> <span class="G">*</span>ptr <span class="G">==</span> '_')</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;id <span class="G">=</span> String(b, ptr);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> id;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> QSFParser<span class="G">::</span>Expand()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">bool</span> expanded;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">auto</span> Error <span class="G">=</span> <span class="G">[&amp;]</span>(<span class="G">const</span> <span class="G">char</span> <span class="G">*</span>s) { errors<span class="G">.</span>Add(lineno, s); };</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Index<span class="G">&lt;int&gt;</span> used_macro;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">do</span> {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expanded <span class="G">=</span> <span class="G">false</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String r;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr <span class="G">=</span> line;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Index<span class="G">&lt;int&gt;</span> pm;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">auto</span> GetMacro <span class="G">=</span> <span class="G">[&amp;]</span>()<span class="G">-&gt;</span>String {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String id <span class="G">=</span> ReadID();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(id<span class="G">.</span>GetCount()) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> q <span class="G">=</span> macro<span class="G">.</span>Find(id);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(q <span class="G">&gt;=</span> 0) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(used_macro<span class="G">.</span>Find(q) <span class="G">&lt;</span> 0) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pm<span class="G">.</span>FindAdd(q);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expanded <span class="G">=</span> <span class="G">true</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> macro<span class="G">[</span>q<span class="G">]</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Error(&quot;recursive macro &quot; <span class="G">+</span> id);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Error(&quot;uknown macro &quot; <span class="G">+</span> id);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Error(&quot;missing macro id&quot;);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> Null;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">while</span>(<span class="G">*</span>ptr) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">==</span> '$') {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Spaces();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(IsDigit(<span class="G">*</span>ptr)) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> n <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">while</span>(IsDigit(<span class="G">*</span>ptr)) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n <span class="G">=</span> 10 <span class="G">*</span> n <span class="G">+</span> <span class="G">*</span>ptr <span class="G">-</span> '0';</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Spaces();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String txt;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> lvl <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">auto</span> Pars <span class="G">=</span> <span class="G">[&amp;]</span>(<span class="G">int</span> l, <span class="G">int</span> r) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">while</span>(<span class="G">*</span>ptr) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">==</span> l)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lvl<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">==</span> r <span class="G">&amp;&amp;</span> lvl<span class="G">--</span> <span class="G">==</span> 0)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">break</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">==</span> '<span class="G">[</span>') {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">const</span> <span class="G">char</span> <span class="G">*</span>b <span class="G">=</span> ptr<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Pars('<span class="G">[</span>', '<span class="G">]</span>');</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr) ptr<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;txt <span class="G">=</span> String(b, ptr);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">==</span> '(') {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">const</span> <span class="G">char</span> <span class="G">*</span>b <span class="G">=</span> <span class="G">++</span>ptr;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Pars('(', ')');</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;txt <span class="G">=</span> String(b, ptr);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr) ptr<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;txt <span class="G">=</span> GetMacro();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(n <span class="G">&gt;</span> 0 <span class="G">&amp;&amp;</span> n <span class="G">&lt;</span> 100000) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">while</span>(n<span class="G">--</span>)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r <span class="G">&lt;&lt;</span> txt <span class="G">&lt;&lt;</span> ' ';</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expanded <span class="G">=</span> <span class="G">true</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Error(&quot;invalid repetition number&quot;);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r <span class="G">&lt;&lt;</span> GetMacro();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r <span class="G">&lt;&lt;</span> <span class="G">*</span>ptr<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;line <span class="G">=</span> r;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> q <span class="G">:</span> pm)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;used_macro<span class="G">.</span>Add(q);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">while</span>(expanded);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> QSFParser<span class="G">::</span>Parse(Stream<span class="G">&amp;</span> src)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">while</span>(<span class="G">!</span>src<span class="G">.</span>IsEof()) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lineno<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;line <span class="G">=</span> src<span class="G">.</span>GetLine();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> q <span class="G">=</span> line<span class="G">.</span>Find(&quot;<span class="G">//</span>&quot;);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(q <span class="G">&gt;=</span> 0)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;line<span class="G">.</span>Trim(q);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;line <span class="G">=</span> TrimBoth(line);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>line <span class="G">==</span> '<span class="G">#</span>') {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr <span class="G">=</span> <span class="G">~</span>line <span class="G">+</span> 1;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String id <span class="G">=</span> ReadID();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Spaces();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(id<span class="G">.</span>GetCount())</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;macro<span class="G">.</span>GetAdd(id) <span class="G">=</span> ptr;</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Error(&quot;missing macro name&quot;);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">else</span> {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Expand();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Process();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> QSFParser<span class="G">::</span>Sound(<span class="G">const</span> <span class="G">char</span> <span class="G">*</span>s)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;sound <span class="G">=</span> SoundIndex(s);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> QSFParser<span class="G">::</span>Tone(<span class="G">int</span> tone, <span class="G">double</span> duration)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;duration <span class="G">=</span> duration <span class="G">/</span> tempo <span class="G">*</span> 240;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(tone <span class="G">==</span> <span class="G">-</span>1)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;At(at);</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Put(at, sound, 100 <span class="G">*</span> GetVolume(at), 65<span class="G">.</span>406 <span class="G">*</span> exp2(tone <span class="G">/</span> 12<span class="G">.</span>0), 1000 <span class="G">*</span> duration, IsNull(tone));</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;at <span class="G">+=</span> duration;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;end <span class="G">=</span> max(at, end);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> QSFParser<span class="G">::</span>Process()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ptr <span class="G">=</span> line;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">auto</span> ReadNumber <span class="G">=</span> <span class="G">[&amp;]</span>() <span class="G">-&gt;</span> <span class="G">double</span> {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CParser p(ptr);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p<span class="G">.</span>NoSkipSpaces()<span class="G">.</span>NoSkipComments();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p<span class="G">.</span>SkipSpaces();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(p<span class="G">.</span>IsDouble()) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> h <span class="G">=</span> p<span class="G">.</span>ReadDouble();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr <span class="G">=</span> p<span class="G">.</span>GetPtr();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> h;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;};</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">auto</span> ReadCNumber <span class="G">=</span> <span class="G">[&amp;]</span>() <span class="G">-&gt;</span> <span class="G">double</span> {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Spaces();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">==</span> '<span class="G">:</span>')</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> ReadNumber();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;};</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">auto</span> DoTone <span class="G">=</span> <span class="G">[&amp;]</span>(<span class="G">int</span> tone) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> ln <span class="G">=</span> 1;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">bool</span> chrd <span class="G">=</span> <span class="G">false</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(;;) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">==</span> '\'' <span class="G">||</span> <span class="G">*</span>ptr <span class="G">==</span> '<span class="G">^</span>')</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tone <span class="G">+=</span> 12;</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">==</span> ',')</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tone <span class="G">-=</span> 12;</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">==</span> '<span class="G">=</span>')</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ln <span class="G">=</span> ln <span class="G">+</span> 1;</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">==</span> '<span class="G">.</span>')</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ln <span class="G">=</span> ln <span class="G">+</span> 0<span class="G">.</span>5;</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">==</span> '<span class="G">:</span>')</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ln <span class="G">=</span> ln <span class="G">+</span> 0<span class="G">.</span>75;</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">==</span> '<span class="G">&amp;</span>')</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chrd <span class="G">=</span> <span class="G">true</span>;</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">!=</span> ' ')</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">break</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> h <span class="G">=</span> at;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Tone(shift <span class="G">+</span> tone, ln <span class="G">*</span> duration);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(chrd)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;at <span class="G">=</span> h;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;};</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">while</span>(<span class="G">*</span>ptr) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">==</span> ';') {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">==</span> ';') {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;at0 <span class="G">=</span> at;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;at <span class="G">=</span> at0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;duration <span class="G">=</span> 1;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shift <span class="G">=</span> 24;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">==</span> '$') {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tempo <span class="G">=</span> ReadNumber();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(tempo <span class="G">&lt;</span> 1) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Error(&quot;invalid tempo value&quot;);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tempo <span class="G">=</span> 600;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">==</span> '<span class="G">+</span>') {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shift <span class="G">+=</span> 12;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">==</span> '<span class="G">-</span>') {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shift <span class="G">-=</span> 12;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">==</span> '@') {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shift <span class="G">+=</span> (<span class="G">int</span>)ReadNumber();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">&gt;=</span> '0' <span class="G">&amp;&amp;</span> <span class="G">*</span>ptr <span class="G">&lt;=</span> '9')</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DoTone(<span class="G">*</span>ptr <span class="G">-</span> '0');</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">==</span> 't')</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DoTone(10);</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">==</span> 'e')</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DoTone(11);</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">==</span> '_') {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Tone(<span class="G">-</span>1, duration);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">==</span> '<span class="G">*</span>') {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Tone(Null, duration);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">==</span> '<span class="G">/</span>') {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;duration <span class="G">=</span> 1<span class="G">.</span>0 <span class="G">/</span> ReadNumber();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">==</span> 'q') {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;duration <span class="G">=</span> 1<span class="G">.</span>0 <span class="G">/</span> 4;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">==</span> 'o' <span class="G">||</span> <span class="G">*</span>ptr <span class="G">==</span> 'w') {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;duration <span class="G">=</span> 1<span class="G">.</span>0 <span class="G">/</span> 8;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">==</span> 'x') {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;duration <span class="G">=</span> 1<span class="G">.</span>0 <span class="G">/</span> 16;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">==</span> 'y') {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;duration <span class="G">=</span> 1<span class="G">.</span>0 <span class="G">/</span> 32;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">==</span> 'm') {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;duration <span class="G">=</span> 1<span class="G">.</span>0 <span class="G">/</span> 2;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">==</span> 'n') {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;duration <span class="G">=</span> 1<span class="G">.</span>0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">==</span> '<span class="G">%</span>') {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;duration <span class="G">*=</span> ReadNumber();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(duration <span class="G">&lt;=</span> 0) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Error(&quot;invalid tone length&quot;);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;duration <span class="G">=</span> 1;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">==</span> '<span class="G">!</span>') {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String snd;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Spaces();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(IsAlpha(<span class="G">*</span>ptr)) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String id <span class="G">=</span> ReadID();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(id <span class="G">==</span> &quot;loop&quot;)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LoopAt(at);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(id <span class="G">==</span> &quot;shift&quot;)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shift <span class="G">+=</span> (<span class="G">int</span>)ReadCNumber();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(id <span class="G">==</span> &quot;volume&quot;) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;volume <span class="G">=</span> ReadCNumber();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;volume_mul <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(id <span class="G">==</span> &quot;volume_to&quot;) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;volume <span class="G">=</span> GetVolume(at);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> v <span class="G">=</span> ReadCNumber();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> len <span class="G">=</span> ReadCNumber();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;volume_low <span class="G">=</span> min(v, volume);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;volume_high <span class="G">=</span> max(v, volume);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;volume_start_at <span class="G">=</span> at;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;volume_mul <span class="G">=</span> (v <span class="G">-</span> volume) <span class="G">/</span> (240 <span class="G">/</span> tempo) <span class="G">/</span> len;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(id <span class="G">==</span> &quot;cursor&quot;)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SoundSequence<span class="G">::</span>cursor <span class="G">=</span> GetAt(at);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(id <span class="G">==</span> &quot;cut&quot;) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;event<span class="G">.</span>Trim(GetAt(at));</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end <span class="G">=</span> at;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(id <span class="G">==</span> &quot;tempo&quot;) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> t <span class="G">=</span> ReadCNumber();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(t <span class="G">&lt;</span> 1 <span class="G">||</span> t <span class="G">&gt;</span> 10000) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Error(&quot;invalid tempo value&quot;);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tempo <span class="G">=</span> t;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">else</span> {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">while</span>(<span class="G">*</span>ptr <span class="G">&amp;&amp;</span> <span class="G">*</span>ptr <span class="G">!=</span> ' ')</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;snd<span class="G">.</span>Cat(<span class="G">*</span>ptr<span class="G">++</span>);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sound(snd);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">==</span> '<span class="G">[</span>') {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(stack<span class="G">.</span>GetCount() <span class="G">&lt;</span> 100)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stack<span class="G">.</span>Add() <span class="G">=</span> <span class="G">*this</span>;</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Error(&quot;stack full&quot;);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">==</span> '<span class="G">]</span>') {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(stack<span class="G">.</span>GetCount())</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(QSFStatus<span class="G">&amp;</span>)<span class="G">*this</span> <span class="G">=</span> stack<span class="G">.</span>Pop();</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Error(&quot;stack empty&quot;);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">==</span> '{') {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(stack<span class="G">.</span>GetCount() <span class="G">&lt;</span> 100) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stack<span class="G">.</span>Add() <span class="G">=</span> <span class="G">*this</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;at_stack<span class="G">.</span>Add(at);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Error(&quot;stack full&quot;);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>ptr <span class="G">==</span> '}') {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(stack<span class="G">.</span>GetCount() <span class="G">&amp;&amp;</span> at_stack<span class="G">.</span>GetCount()) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(QSFStatus<span class="G">&amp;</span>)<span class="G">*this</span> <span class="G">=</span> stack<span class="G">.</span>Pop();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;at <span class="G">=</span> at_stack<span class="G">.</span>Pop();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Error(&quot;stack empty&quot;);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> q <span class="G">=</span> GetAt(end);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(q <span class="G">&gt;</span> 0)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;event<span class="G">.</span>At(q);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">SoundSequence ParseQSF(<span class="G">const</span> String<span class="G">&amp;</span> data)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;StringStream ss(data);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;QSFParser p;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;p<span class="G">.</span>Parse(ss);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> pick(p);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="E">Gen.cpp</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#include</span> &quot;Synth<span class="G">.</span>h&quot;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#include</span> &quot;sample<span class="G">.</span>i&quot;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">double</span> waveform_table<span class="G">[</span>9<span class="G">][</span>4096<span class="G">]</span>;</p>
<p class="F">&nbsp;</p>
<p class="F">INITBLOCK {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> 0; i <span class="G">&lt;</span> 4096; i<span class="G">++</span>) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> arg <span class="G">=</span> M_2PI <span class="G">*</span> i <span class="G">/</span> 4096;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;waveform_table<span class="G">[</span>WAVEFORM_SIN<span class="G">][</span>i<span class="G">]</span> <span class="G">=</span> sin(arg);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;waveform_table<span class="G">[</span>WAVEFORM_SQUARE<span class="G">][</span>i<span class="G">]</span> <span class="G">=</span> sgn(waveform_table<span class="G">[</span>WAVEFORM_SIN<span class="G">][</span>i<span class="G">]</span>);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;waveform_table<span class="G">[</span>WAVEFORM_TRIANGLE<span class="G">][</span>i<span class="G">]</span> <span class="G">=</span> abs(2048 <span class="G">-</span> i) <span class="G">/</span> 1024<span class="G">.</span>0 <span class="G">-</span> 1;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;waveform_table<span class="G">[</span>WAVEFORM_SAWTOOTH<span class="G">][</span>i<span class="G">]</span> <span class="G">=</span> 2 <span class="G">*</span> i <span class="G">/</span> 4096<span class="G">.</span>0 <span class="G">-</span> 1;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> 0; i <span class="G">&lt;</span> 4096; i<span class="G">++</span>) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;waveform_table<span class="G">[</span>4<span class="G">][</span>i<span class="G">]</span> <span class="G">=</span> wave_saxophone<span class="G">[</span>i<span class="G">]</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;waveform_table<span class="G">[</span>5<span class="G">][</span>i<span class="G">]</span> <span class="G">=</span> wave_violin<span class="G">[</span>i<span class="G">]</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;waveform_table<span class="G">[</span>6<span class="G">][</span>i<span class="G">]</span> <span class="G">=</span> wave_doublebass<span class="G">[</span>i<span class="G">]</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;waveform_table<span class="G">[</span>7<span class="G">][</span>i<span class="G">]</span> <span class="G">=</span> wave_banjo<span class="G">[</span>i<span class="G">]</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;waveform_table<span class="G">[</span>8<span class="G">][</span>i<span class="G">]</span> <span class="G">=</span> wave_trumpet<span class="G">[</span>i<span class="G">]</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">double</span> Rate(<span class="G">double</span> x)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> pow(10, (6 <span class="G">*</span> x <span class="G">/</span> 100 <span class="G">-</span> 6));</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> SoundGen<span class="G">::</span>FMOPGen<span class="G">::</span>Comp()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;attack <span class="G">=</span> 1 <span class="G">+</span> Rate(attack);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;decay <span class="G">=</span> 1 <span class="G">-</span> Rate(decay);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;release <span class="G">=</span> 1 <span class="G">-</span> Rate(release);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;duration <span class="G">=</span> 44100 <span class="G">*</span> duration <span class="G">/</span> 1000;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;fdrift <span class="G">=</span> exp2(fdrift <span class="G">/</span> 12 <span class="G">/</span> 44100);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(volume <span class="G">&gt;</span> 0)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;volume <span class="G">=</span> pow(10, (volume <span class="G">-</span> 100) <span class="G">/</span> 40);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(sustain <span class="G">&gt;</span> 0)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sustain <span class="G">=</span> pow(10, (sustain <span class="G">-</span> 100) <span class="G">/</span> 40);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;wave_tab <span class="G">=</span> waveform_table<span class="G">[</span>clamp(waveform, 0, (<span class="G">int</span>)WAVEFORM_LASTSAMPLE)<span class="G">]</span>;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="H"><span class="I">String SoundGen</span>::<span class="I">FMOPGen</span>::<span class="I">ToString() </span>const</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> String() <span class="G">&lt;&lt;</span> &quot;Volume<span class="G">:</span> &quot; <span class="G">&lt;&lt;</span> volume <span class="G">&lt;&lt;</span> &quot;, phase<span class="G">:</span> &quot; <span class="G">&lt;&lt;</span> p <span class="G">&lt;&lt;</span> &quot;, ADSR volume<span class="G">:</span> &quot; <span class="G">&lt;&lt;</span> v;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="H">force_inline</p>
<p class="F"><span class="G">double</span> SoundGen<span class="G">::</span>FMOPGen<span class="G">::</span>Evaluate(<span class="G">int</span> t, <span class="G">double</span> mf, <span class="G">double</span> mod, <span class="G">double&amp;</span> cv)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(volume <span class="G">==</span> 0)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(t <span class="G">&gt;=</span> duration) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v <span class="G">*=</span> release;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cv <span class="G">=</span> v;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">switch</span>(p) {</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;</span>case<span class="I"> 0</span>:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v <span class="G">*=</span> attack;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(v <span class="G">&gt;=</span> 1<span class="G">.</span>0) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v <span class="G">=</span> 1<span class="G">.</span>0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p <span class="G">=</span> 1;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cv <span class="G">=</span> v <span class="G">&gt;</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">break</span>;</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;</span>case<span class="I"> 1</span>:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v <span class="G">*=</span> decay;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(v <span class="G">&lt;</span> sustain) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v <span class="G">=</span> sustain;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p <span class="G">=</span> 2;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cv <span class="G">=</span> v;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">break</span>;</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;</span>default:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cv <span class="G">=</span> v <span class="G">=</span> sustain;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;cv <span class="G">*=</span> volume;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;f <span class="G">*=</span> fdrift;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> fn;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(findarg(waveform, WAVEFORM_BROWN, WAVEFORM_WHITE) <span class="G">&gt;=</span> 0) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> dword state <span class="G">=</span> 1;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state <span class="G">^=</span> state <span class="G">&lt;&lt;</span> 13;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state <span class="G">^=</span> state <span class="G">&gt;&gt;</span> 17;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state <span class="G">^=</span> state <span class="G">&lt;&lt;</span> 5;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fn <span class="G">=</span> 2<span class="G">.</span>0 <span class="G">/</span> 4294967295<span class="G">.</span>0 <span class="G">*</span> state <span class="G">-</span> 1;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(waveform <span class="G">==</span> WAVEFORM_BROWN)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fn <span class="G">=</span> n <span class="G">=</span> clamp(n <span class="G">+</span> 0<span class="G">.</span>06 <span class="G">*</span> fn, <span class="G">-</span>1<span class="G">.</span>0, 1<span class="G">.</span>0);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">else</span> {</p>
<p class="F"><span class="G">#if</span> 0</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> arg <span class="G">=</span> mf <span class="G">*</span> f <span class="G">*</span> t <span class="G">+</span> mod;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(waveform <span class="G">==</span> WAVEFORM_SIN)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fn <span class="G">=</span> sin(arg);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">else</span> {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;arg <span class="G">=</span> fmod(arg, M_2PI);</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fn </span>=<span class="I"> waveform </span>==<span class="I"> WAVEFORM_SQUARE </span>?<span class="I"> sgn(abs(M_PI </span>-<span class="I"> arg) </span>/<span class="I"> (M_PI </span>/<span class="I"> 2) </span>-<span class="I"> 1) </span>:</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;waveform </span>==<span class="I"> WAVEFORM_TRIANGLE </span>?<span class="I"> abs(M_PI </span>-<span class="I"> arg) </span>/<span class="I"> (M_PI </span>/<span class="I"> 2) </span>-<span class="I"> 1 </span>:</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;waveform </span>==<span class="I"> WAVEFORM_SAWTOOTH </span>?<span class="I"> arg </span>/<span class="I"> M_PI </span>-<span class="I"> 1 </span>:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H">#else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> arg <span class="G">=</span> mf <span class="G">*</span> f <span class="G">*</span> t <span class="G">+</span> mod;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fn <span class="G">=</span> wave_tab<span class="G">[</span>dword((4096 <span class="G">/</span> M_2PI) <span class="G">*</span> arg) <span class="G">&amp;</span> 4095<span class="G">]</span>;</p>
<p class="H">#endif</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> volume <span class="G">*</span> v <span class="G">*</span> fn;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> SoundGen<span class="G">::</span>Start(<span class="G">const</span> Sound<span class="G">&amp;</span> s)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> 0; i <span class="G">&lt;</span> OPCOUNT; i<span class="G">++</span>) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(FMOP<span class="G">&amp;</span>)op<span class="G">[</span>i<span class="G">]</span> <span class="G">=</span> s<span class="G">.</span>op<span class="G">[</span>i<span class="G">]</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;op<span class="G">[</span>i<span class="G">].</span>Comp();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;op<span class="G">[</span>i<span class="G">].</span>Start();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;f <span class="G">=</span> s<span class="G">.</span>f <span class="G">/</span> 22100 <span class="G">*</span> M_PI;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;lpan <span class="G">=</span> (<span class="G">float</span>)s<span class="G">.</span>pan;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;rpan <span class="G">=</span> (<span class="G">float</span>)(1 <span class="G">-</span> s<span class="G">.</span>pan);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> 3; i <span class="G">&lt;=</span> 4; i<span class="G">++</span>) <span class="G">//</span> vibrato, tremolo</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;op<span class="G">[</span>i<span class="G">].</span>f <span class="G">=</span> op<span class="G">[</span>i<span class="G">].</span>f <span class="G">/</span> 22100 <span class="G">*</span> M_PI;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;t <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;memset(feedback, 0, <span class="G">sizeof</span>(feedback));</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;current_volume <span class="G">=</span> 1;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;lfo_mod <span class="G">=</span> Randomf() <span class="G">*</span> M_2PI;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">float</span> SoundGen<span class="G">::</span>Get()</p>
<p class="F">{</p>
<p class="F"><span class="G">#if</span> 0</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">float</span> r <span class="G">=</span> op<span class="G">[</span>0<span class="G">].</span>Evaluate(t, f, 0, current_volume);</p>
<p class="H">#else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(current_volume <span class="G">&lt;</span> 0<span class="G">.</span>001)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> dummy;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> lfo1 <span class="G">=</span> op<span class="G">[</span>3<span class="G">].</span>Evaluate(t, 1, lfo_mod, dummy);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> lfo2 <span class="G">=</span> op<span class="G">[</span>4<span class="G">].</span>Evaluate(t, 1, lfo_mod, dummy);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> v <span class="G">=</span> (1 <span class="G">-</span> op<span class="G">[</span>4<span class="G">].</span>volume <span class="G">+</span> lfo2);</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;</span>float<span class="I"> r </span>=</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(</span>float<span class="I">)(v </span>*</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;op<span class="G">[</span>0<span class="G">].</span>Evaluate(t, f, op<span class="G">[</span>1<span class="G">].</span>Evaluate(t, f, lfo1, dummy) <span class="G">+</span> op<span class="G">[</span>2<span class="G">].</span>Evaluate(t, f, lfo1, dummy) <span class="G">+</span> lfo1, current_volume)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;);</p>
<p class="H">#endif</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;t<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> r;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="H"><span class="I">String SoundGen</span>::<span class="I">ToString() </span>const</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;String r;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;r <span class="G">&lt;&lt;</span> &quot;<span class="G">-----</span> Current volume<span class="G">:</span> &quot; <span class="G">&lt;&lt;</span> current_volume <span class="G">&lt;&lt;</span> &quot;, time<span class="G">:</span> &quot; <span class="G">&lt;&lt;</span> t <span class="G">&lt;&lt;</span> '\n';</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> 0; i <span class="G">&lt;</span> OPCOUNT; i<span class="G">++</span>)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r <span class="G">&lt;&lt;</span> i <span class="G">&lt;&lt;</span> &quot;<span class="G">:</span> &quot; <span class="G">&lt;&lt;</span> op<span class="G">[</span>i<span class="G">]</span> <span class="G">&lt;&lt;</span> '\n';</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> r;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="E">Sequencer.cpp</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#include</span> &quot;Synth<span class="G">.</span>h&quot;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> SoundSequence<span class="G">::</span>Put(<span class="G">double</span> at, <span class="G">int</span> i, <span class="G">double</span> volume, <span class="G">double</span> frequency, <span class="G">double</span> duration, <span class="G">bool</span> direct)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;SoundEvent<span class="G">&amp;</span> e <span class="G">=</span> At(at)<span class="G">.</span>Add();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;e<span class="G">.</span>frequency <span class="G">=</span> (<span class="G">float</span>)frequency;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;e<span class="G">.</span>duration <span class="G">=</span> (<span class="G">float</span>)duration;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;e<span class="G">.</span>volume <span class="G">=</span> (<span class="G">float</span>)volume;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;e<span class="G">.</span>snd <span class="G">=</span> <span class="G">&amp;</span>bank<span class="G">[</span>i<span class="G">]</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(direct) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e<span class="G">.</span>duration <span class="G">=</span> (<span class="G">float</span>)e<span class="G">.</span>snd<span class="G">-&gt;</span>op<span class="G">[</span>0<span class="G">].</span>duration;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e<span class="G">.</span>frequency <span class="G">=</span> (<span class="G">float</span>)e<span class="G">.</span>snd<span class="G">-&gt;</span>f;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">int</span> SoundSequence<span class="G">::</span>SoundIndex(<span class="G">const</span> String<span class="G">&amp;</span> s)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> q <span class="G">=</span> bank<span class="G">.</span>Find(s);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(q <span class="G">&lt;</span> 0) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;q <span class="G">=</span> bank<span class="G">.</span>GetCount();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bank<span class="G">.</span>Add(s)<span class="G">.</span>Load(s);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> q;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> SoundSequence<span class="G">::</span>Put(<span class="G">double</span> at, <span class="G">const</span> String<span class="G">&amp;</span> snd, <span class="G">double</span> volume, <span class="G">double</span> frequency, <span class="G">double</span> duration,</p>
<p class="F"> <span class="G">bool</span> direct)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Put(at, SoundIndex(snd), volume, frequency, duration, direct);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">const</span> <span class="G">int</span> SEQUENCER_CHANNEL_ID <span class="G">=</span> <span class="G">-</span>123;</p>
<p class="F">std<span class="G">::</span>atomic<span class="G">&lt;const</span> SoundSequence <span class="G">*&gt;</span> sS;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> PlaySequence(<span class="G">const</span> SoundSequence<span class="G">&amp;</span> s)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;s<span class="G">.</span>at <span class="G">=</span> s<span class="G">.</span>cursor;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;sS <span class="G">=</span> <span class="G">&amp;</span>s;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">bool</span> IsPlayingSequence()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> sS<span class="G">.</span>load();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> StopSequencer()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;sS <span class="G">=</span> NULL;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;StopChannels(SEQUENCER_CHANNEL_ID);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> PlayTempSequence(SoundSequence<span class="G">&amp;&amp;</span> s)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> <span class="G">int</span> ii;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> SoundSequence h<span class="G">[</span>2<span class="G">]</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;h<span class="G">[</span>ii<span class="G">]</span> <span class="G">=</span> pick(s);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;PlaySequence(h<span class="G">[</span>ii<span class="G">]</span>);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ii <span class="G">=</span> <span class="G">!</span>ii;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Sequencer(<span class="G">int</span> chunk_size)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> <span class="G">int</span> ch;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ch <span class="G">+=</span> chunk_size;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(ch <span class="G">&lt;</span> CHUNK_SIZE)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ch <span class="G">-=</span> CHUNK_SIZE;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> PR <span class="G">=</span> 10;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">const</span> SoundSequence <span class="G">*</span>ss <span class="G">=</span> sS<span class="G">.</span>load();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(ss) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(ss<span class="G">-&gt;</span>at <span class="G">&gt;=</span> ss<span class="G">-&gt;</span>event<span class="G">.</span>GetCount()) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">!</span>IsNull(ss<span class="G">-&gt;</span>loop) <span class="G">&amp;&amp;</span> ss<span class="G">-&gt;</span>event<span class="G">.</span>GetCount())</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ss<span class="G">-&gt;</span>at <span class="G">=</span> ss<span class="G">-&gt;</span>loop;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">else</span> {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sS <span class="G">=</span> NULL;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">const</span> Vector<span class="G">&lt;</span>SoundEvent<span class="G">&gt;&amp;</span> e <span class="G">=</span> ss<span class="G">-&gt;</span>event<span class="G">[</span>ss<span class="G">-&gt;</span>at<span class="G">++]</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">const</span> SoundEvent<span class="G">&amp;</span> s <span class="G">:</span> e) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> ii <span class="G">=</span> FindChannel(PR, 1, s<span class="G">.</span>volume);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(ii <span class="G">&gt;=</span> 0) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sound snd <span class="G">=</span> <span class="G">*</span>s<span class="G">.</span>snd;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(s<span class="G">.</span>frequency <span class="G">&gt;</span> 0) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;snd<span class="G">.</span>f <span class="G">=</span> s<span class="G">.</span>frequency;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;snd<span class="G">.</span>op<span class="G">[</span>0<span class="G">].</span>volume <span class="G">*=</span> s<span class="G">.</span>volume <span class="G">/</span> 100;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;snd<span class="G">.</span>op<span class="G">[</span>0<span class="G">].</span>duration <span class="G">=</span> s<span class="G">.</span>duration;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetChannel(ii, snd, 10, SEQUENCER_CHANNEL_ID);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="E">Synth.cpp</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#include</span> &quot;Synth<span class="G">.</span>h&quot;</p>
<p class="F">&nbsp;</p>
<p class="H">#include<span class="I"> </span>&lt;<span class="I">Core</span>/<span class="I">Core</span>.<span class="I">h</span>&gt;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">using</span> <span class="G">namespace</span> Upp;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">enum</span> {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;WAVECOUNT <span class="G">=</span> 2048,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;WAVEMASK <span class="G">=</span> 2047,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;NOISECOUNT <span class="G">=</span> 1024 <span class="G">*</span> 1024 <span class="G">*</span> 4,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;NOISEMASK <span class="G">=</span> NOISECOUNT <span class="G">-</span> 1,</p>
<p class="F">};</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">struct</span> WaveForm {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">float</span> wave<span class="G">[</span>2048<span class="G">]</span>;</p>
<p class="F">};</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">float</span> BrownNoise<span class="G">[</span>NOISECOUNT<span class="G">]</span>;</p>
<p class="F">&nbsp;</p>
<p class="F">INITBLOCK {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">float</span> p;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> 0; i <span class="G">&lt;</span> NOISECOUNT; i<span class="G">++</span>) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p <span class="G">=</span> clamp(p <span class="G">+</span> (0<span class="G">.</span>02 <span class="G">*</span> (Randomf() <span class="G">*</span> 2 <span class="G">-</span> 1)) <span class="G">/</span> 1<span class="G">.</span>02, <span class="G">-</span>1<span class="G">/</span>3<span class="G">.</span>5, 1<span class="G">/</span>3<span class="G">.</span>5);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BrownNoise<span class="G">[</span>i<span class="G">]</span> <span class="G">=</span> p;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> MakeWave(<span class="G">const</span> <span class="G">char</span> <span class="G">*</span>s, WaveForm<span class="G">&amp;</span> h)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> 0; i <span class="G">&lt;</span> WAVECOUNT; i<span class="G">++</span>)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;h<span class="G">.</span>wave<span class="G">[</span>i<span class="G">]</span> <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">try</span> {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CParser p(s);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> harm <span class="G">=</span> 1;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> i <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> a <span class="G">=</span> 1;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">auto</span> fn0 <span class="G">=</span> <span class="G">[&amp;]</span>() <span class="G">-&gt;</span> <span class="G">double</span> { <span class="G">return</span> sin(M_2PI <span class="G">*</span> i <span class="G">*</span> harm <span class="G">/</span> WAVECOUNT); };</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Function<span class="G">&lt;double</span> ()<span class="G">&gt;</span> fn <span class="G">=</span> fn0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(;;) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> ii <span class="G">=</span> (i <span class="G">*</span> harm)<span class="G">/*</span> <span class="G">&amp;</span> WAVEMASK<span class="G">*/</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(p<span class="G">.</span>Char('T'))</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fn <span class="G">=</span> <span class="G">[&amp;]</span>() <span class="G">-&gt;</span> <span class="G">double</span> { <span class="G">return</span> (1024<span class="G">.</span>0 <span class="G">-</span> abs(WAVECOUNT <span class="G">/</span> 2 <span class="G">-</span> ii)) <span class="G">/</span> WAVECOUNT <span class="G">/</span> 4 <span class="G">-</span> 1; };</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(p<span class="G">.</span>Char('t'))</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fn <span class="G">=</span> <span class="G">[&amp;]</span>() <span class="G">-&gt;</span> <span class="G">double</span> { <span class="G">return</span> <span class="G">-</span>(1024<span class="G">.</span>0 <span class="G">-</span> abs(WAVECOUNT <span class="G">/</span> 2 <span class="G">-</span> ii)) <span class="G">/</span> WAVECOUNT <span class="G">/</span> 4 <span class="G">+</span> 1; };</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(p<span class="G">.</span>Char('Z'))</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fn <span class="G">=</span> <span class="G">[&amp;]</span>() <span class="G">-&gt;</span> <span class="G">double</span> { <span class="G">return</span> 2<span class="G">.</span>0f <span class="G">*</span> ii <span class="G">/</span> (WAVECOUNT <span class="G">-</span> 1) <span class="G">-</span> 1; };</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(p<span class="G">.</span>Char('z'))</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fn <span class="G">=</span> <span class="G">[&amp;]</span>() <span class="G">-&gt;</span> <span class="G">double</span> { <span class="G">return</span> <span class="G">-</span>2<span class="G">.</span>0f <span class="G">*</span> ii <span class="G">/</span> (WAVECOUNT <span class="G">-</span> 1) <span class="G">+</span> 1; };</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(p<span class="G">.</span>Char('S'))</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fn <span class="G">=</span> fn0;</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(p<span class="G">.</span>IsDouble()) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> a <span class="G">=</span> p<span class="G">.</span>ReadDouble();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(p<span class="G">.</span>Char('<span class="G">:</span>'))</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;harm <span class="G">=</span> (<span class="G">int</span>)a;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">else</span> {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(i <span class="G">=</span> 0; i <span class="G">&lt;</span> WAVECOUNT; i<span class="G">++</span>)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;h<span class="G">.</span>wave<span class="G">[</span>i<span class="G">]</span> <span class="G">+=</span> (<span class="G">float</span>)(a <span class="G">*</span> fn());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;harm<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">break</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">catch</span>(<span class="G">...</span>) {}</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">float</span> <span class="G">*</span>GetWave(<span class="G">const</span> String<span class="G">&amp;</span> h)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> Mutex _;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Mutex<span class="G">::</span>Lock __(_);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> ArrayMap<span class="G">&lt;</span>String, WaveForm<span class="G">&gt;</span> cache;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> q <span class="G">=</span> cache<span class="G">.</span>Find(h);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(q <span class="G">&gt;=</span> 0)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> cache<span class="G">[</span>q<span class="G">].</span>wave;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;MakeWave(h, cache<span class="G">.</span>Add(h));</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> cache<span class="G">.</span>Top()<span class="G">.</span>wave;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">Instrument<span class="G">::</span>Instrument()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;delay <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;attack <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;decay <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;sustain <span class="G">=</span> 1;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;release <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;wave <span class="G">=</span> &quot;1&quot;;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;mod_wave <span class="G">=</span> &quot;1&quot;;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;mod_amplitude <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;mod_frequency <span class="G">=</span> 1;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;noise_kind <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;noise_amplitude <span class="G">=</span> 1;</p>
<p class="F">};</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">const</span> <span class="G">int</span> TABN <span class="G">=</span> 4096;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">static</span> <span class="G">double</span> table<span class="G">[</span>TABN <span class="G">+</span> 2<span class="G">]</span>;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">double</span> LOGVOL(<span class="G">double</span> x)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> pow(10, x <span class="G">*</span> 60 <span class="G">/</span> 20) <span class="G">/</span> pow(10, 60 <span class="G">/</span> 20);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="H">force_inline</p>
<p class="F"><span class="G">double</span> LogVol(<span class="G">double</span> x)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> id <span class="G">=</span> TABN <span class="G">*</span> x;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> ii <span class="G">=</span> (<span class="G">int</span>)id;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(ii <span class="G">&lt;</span> 0) <span class="G">return</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(ii <span class="G">&gt;</span> TABN) <span class="G">return</span> x;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> f <span class="G">=</span> id <span class="G">-</span> ii;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> (1 <span class="G">-</span> f) <span class="G">*</span> table<span class="G">[</span>ii<span class="G">]</span> <span class="G">+</span> f <span class="G">*</span> table<span class="G">[</span>ii <span class="G">+</span> 1<span class="G">]</span>;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">INITBLOCK {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> 0; i <span class="G">&lt;=</span> TABN; i<span class="G">++</span>) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> q <span class="G">=</span> i <span class="G">/</span> (<span class="G">double</span>)TABN;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;table<span class="G">[</span>i<span class="G">]</span> <span class="G">=</span> LOGVOL(q);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;table<span class="G">[</span>TABN <span class="G">+</span> 1<span class="G">]</span> <span class="G">=</span> (TABN <span class="G">+</span> 1) <span class="G">/</span> 256<span class="G">.</span>0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;table<span class="G">[</span>0<span class="G">]</span> <span class="G">=</span> 0;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">double</span> MakeNoise(<span class="G">int</span> kind)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> dword state <span class="G">=</span> 1;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;state <span class="G">^=</span> state <span class="G">&lt;&lt;</span> 13;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;state <span class="G">^=</span> state <span class="G">&gt;&gt;</span> 17;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;state <span class="G">^=</span> state <span class="G">&lt;&lt;</span> 5;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> white <span class="G">=</span> 2<span class="G">.</span>0 <span class="G">/</span> 4294967295<span class="G">.</span>0 <span class="G">*</span> state <span class="G">-</span> 1;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> <span class="G">double</span> p;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> <span class="G">double</span> b0, b1, b2;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">switch</span>(kind) {</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;</span>case<span class="I"> 1</span>:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> white;</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;</span>case<span class="I"> 2</span>:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b0 <span class="G">=</span> 0<span class="G">.</span>99765 <span class="G">*</span> b0 <span class="G">+</span> white <span class="G">*</span> 0<span class="G">.</span>0990460;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b1 <span class="G">=</span> 0<span class="G">.</span>96300 <span class="G">*</span> b1 <span class="G">+</span> white <span class="G">*</span> 0<span class="G">.</span>2965164;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b2 <span class="G">=</span> 0<span class="G">.</span>57000 <span class="G">*</span> b2 <span class="G">+</span> white <span class="G">*</span> 1<span class="G">.</span>0526913;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> b0 <span class="G">+</span> b1 <span class="G">+</span> b2 <span class="G">+</span> white <span class="G">*</span> 0<span class="G">.</span>1848;</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;</span>case<span class="I"> 3</span>:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p <span class="G">=</span> clamp(p <span class="G">+</span> (0<span class="G">.</span>02 <span class="G">*</span> (Randomf() <span class="G">*</span> 2 <span class="G">-</span> 1)) <span class="G">/</span> 1<span class="G">.</span>02, <span class="G">-</span>1<span class="G">/</span>3<span class="G">.</span>5, 1<span class="G">/</span>3<span class="G">.</span>5);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> p <span class="G">*</span> 3<span class="G">.</span>5;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> 0;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">struct</span> SynthSound <span class="G">:</span> SoundGenerator {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">bool</span> Get(<span class="G">float</span> <span class="G">*</span>data, <span class="G">int</span> len);</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">float</span> &nbsp;volume;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">float</span> &nbsp;fdelta;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">float</span> &nbsp;sustain;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">float</span> &nbsp;mdelta;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">float</span> &nbsp;mod_amp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> &nbsp;&nbsp;&nbsp;duration;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> &nbsp;&nbsp;&nbsp;delay;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> &nbsp;&nbsp;&nbsp;attack;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> &nbsp;&nbsp;&nbsp;decay;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> &nbsp;&nbsp;&nbsp;release;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">float</span> <span class="G">*</span>wave;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">float</span> <span class="G">*</span>mod_wave;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> &nbsp;&nbsp;&nbsp;noise_kind;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">float</span> &nbsp;noise_amplitude;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">float</span> &nbsp;release_from <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">float</span> &nbsp;last <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">float</span> &nbsp;frequency_mul;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">bool</span> &nbsp;&nbsp;has_noise;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">float</span> &nbsp;noise<span class="G">[</span>8<span class="G">]</span>;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">float</span> &nbsp;q <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">float</span> &nbsp;w <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> &nbsp;&nbsp;&nbsp;t <span class="G">=</span> 0;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> SetVolume(<span class="G">float</span> vol) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ volume <span class="G">=</span> vol; }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> SetFrequency(<span class="G">float</span> frequency) { fdelta <span class="G">=</span> (WAVEMASK <span class="G">+</span> 1) <span class="G">*</span> frequency <span class="G">*</span> frequency_mul <span class="G">/</span> 44200; }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> Set(<span class="G">float</span> volume, <span class="G">float</span> frequency, <span class="G">float</span> duration, <span class="G">const</span> Instrument<span class="G">&amp;</span> m);</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;SynthSound(<span class="G">float</span> volume, <span class="G">float</span> frequency, <span class="G">float</span> duration, <span class="G">const</span> Instrument<span class="G">&amp;</span> m) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set(volume, frequency, duration, m);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">};</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> SynthSound<span class="G">::</span>Set(<span class="G">float</span> volume, <span class="G">float</span> frequency, <span class="G">float</span> duration_, <span class="G">const</span> Instrument<span class="G">&amp;</span> m)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;frequency_mul <span class="G">=</span> m<span class="G">.</span>frequency_mul;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;SetVolume(volume);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;SetFrequency(frequency);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;sustain <span class="G">=</span> m<span class="G">.</span>sustain;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;mdelta <span class="G">=</span> (WAVEMASK <span class="G">+</span> 1) <span class="G">*</span> m<span class="G">.</span>mod_frequency <span class="G">/</span> 44200;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;mod_amp <span class="G">=</span> (WAVEMASK <span class="G">+</span> 1) <span class="G">*</span> m<span class="G">.</span>mod_amplitude <span class="G">/</span> 44200;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;duration <span class="G">=</span> <span class="G">int</span>(44200 <span class="G">*</span> duration_);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;delay <span class="G">=</span> <span class="G">int</span>(44200 <span class="G">*</span> m<span class="G">.</span>delay);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;attack <span class="G">=</span> <span class="G">int</span>(44200 <span class="G">*</span> m<span class="G">.</span>attack);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;decay <span class="G">=</span> <span class="G">int</span>(44200 <span class="G">*</span> m<span class="G">.</span>decay);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;release <span class="G">=</span> <span class="G">int</span>(44200 <span class="G">*</span> m<span class="G">.</span>release);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;wave <span class="G">=</span> GetWave(m<span class="G">.</span>wave);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;mod_wave <span class="G">=</span> GetWave(m<span class="G">.</span>mod_wave);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;noise_kind <span class="G">=</span> m<span class="G">.</span>noise_kind;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;noise_amplitude <span class="G">=</span> m<span class="G">.</span>noise_amplitude;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;has_noise <span class="G">=</span> m<span class="G">.</span>has_noise;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> 0; i <span class="G">&lt;</span> 8; i<span class="G">++</span>)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;noise<span class="G">[</span>i<span class="G">]</span> <span class="G">=</span> m<span class="G">.</span>noise<span class="G">[</span>i<span class="G">]</span>;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">bool</span> SynthSound<span class="G">::</span>Get(<span class="G">float</span> <span class="G">*</span>b, <span class="G">int</span> len)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">bool</span> plays <span class="G">=</span> <span class="G">true</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">float</span> sustain_volume <span class="G">=</span> sustain <span class="G">*</span> volume;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> 0; i <span class="G">&lt;</span> len; i<span class="G">++</span>) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(t <span class="G">&lt;</span> delay)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">*</span>b<span class="G">++</span> <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">else</span> {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">float</span> envelope <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(t <span class="G">&lt;</span> delay <span class="G">+</span> attack) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;envelope <span class="G">=</span> (t <span class="G">*</span> volume) <span class="G">/</span> attack;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;release_from <span class="G">=</span> envelope;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last <span class="G">=</span> t;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(t <span class="G">&lt;</span> delay <span class="G">+</span> attack <span class="G">+</span> decay) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;envelope <span class="G">=</span> volume <span class="G">-</span> (volume <span class="G">-</span> sustain_volume) <span class="G">*</span> (t <span class="G">-</span> delay <span class="G">-</span> attack) <span class="G">/</span> decay;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;release_from <span class="G">=</span> envelope;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last <span class="G">=</span> t;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(t <span class="G">&lt;</span> duration <span class="G">||</span> duration <span class="G">&lt;</span> 0) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;envelope <span class="G">=</span> sustain_volume;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;release_from <span class="G">=</span> envelope;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last <span class="G">=</span> t;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(release) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;envelope <span class="G">=</span> release_from <span class="G">-</span> release_from <span class="G">*</span> (t <span class="G">-</span> last) <span class="G">/</span> release;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(envelope <span class="G">&lt;=</span> 0) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;plays <span class="G">=</span> <span class="G">false</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;envelope <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;plays <span class="G">=</span> <span class="G">false</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> a <span class="G">=</span> wave<span class="G">[</span>(<span class="G">int</span>)q <span class="G">&amp;</span> WAVEMASK<span class="G">]</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(has_noise) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a <span class="G">+=</span> BrownNoise<span class="G">[</span>(<span class="G">int</span>)q <span class="G">&amp;</span> NOISEMASK<span class="G">]</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(noise_kind)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a <span class="G">+=</span> noise_amplitude <span class="G">*</span> MakeNoise(noise_kind);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">*</span>b<span class="G">++</span> <span class="G">=</span> envelope <span class="G">*</span> a;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w <span class="G">+=</span> mdelta;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;q <span class="G">+=</span> fdelta <span class="G">+</span> mod_amp <span class="G">*</span> mod_wave<span class="G">[</span>(<span class="G">int</span>)w <span class="G">&amp;</span> WAVEMASK<span class="G">]</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> plays;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">int64 Play(<span class="G">float</span> volume, <span class="G">float</span> frequency, <span class="G">float</span> duration, <span class="G">const</span> Instrument<span class="G">&amp;</span> m)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> AddSound(<span class="G">new</span> SynthSound(volume, frequency, duration, m));</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">int64 Play(<span class="G">float</span> volume, <span class="G">float</span> frequency, <span class="G">const</span> Instrument<span class="G">&amp;</span> m)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> Play(volume, frequency, <span class="G">-</span>1, m);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> SetVolume(int64 id, <span class="G">float</span> volume)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;AlterSound(id, <span class="G">[=]</span>(SoundGenerator <span class="G">*</span>sg) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SynthSound <span class="G">*</span>ss <span class="G">=</span> <span class="G">dynamic_cast&lt;</span>SynthSound <span class="G">*&gt;</span>(sg);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(ss)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ss<span class="G">-&gt;</span>SetVolume(volume);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;});</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> SetFrequency(int64 id, <span class="G">float</span> frequency)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;AlterSound(id, <span class="G">[=]</span>(SoundGenerator <span class="G">*</span>sg) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SynthSound <span class="G">*</span>ss <span class="G">=</span> <span class="G">dynamic_cast&lt;</span>SynthSound <span class="G">*&gt;</span>(sg);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(ss)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ss<span class="G">-&gt;</span>SetFrequency(frequency);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;});</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> StopSound(int64 id)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;AlterSound(id, <span class="G">[=]</span>(SoundGenerator <span class="G">*</span>sg) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SynthSound <span class="G">*</span>ss <span class="G">=</span> <span class="G">dynamic_cast&lt;</span>SynthSound <span class="G">*&gt;</span>(sg);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(ss)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ss<span class="G">-&gt;</span>duration <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;});</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Instrument<span class="G">::</span>Read(CParser<span class="G">&amp;</span> p)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">while</span>(<span class="G">!</span>p<span class="G">.</span>IsEof()) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(p<span class="G">.</span>Char('{')) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">const</span> <span class="G">char</span> <span class="G">*</span>s <span class="G">=</span> p<span class="G">.</span>GetPtr();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(;;) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(p<span class="G">.</span>IsChar('}') <span class="G">||</span> p<span class="G">.</span>IsEof()) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wave <span class="G">=</span> String(s, p<span class="G">.</span>GetPtr());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">break</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p<span class="G">.</span>SkipTerm();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p<span class="G">.</span>Char('}');</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(p<span class="G">.</span>Char('@'))</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;frequency_mul <span class="G">=</span> p<span class="G">.</span>ReadDouble();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(p<span class="G">.</span>Char('<span class="G">[</span>')) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">const</span> <span class="G">char</span> <span class="G">*</span>s <span class="G">=</span> p<span class="G">.</span>GetPtr();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(;;) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(p<span class="G">.</span>IsChar('<span class="G">]</span>') <span class="G">||</span> p<span class="G">.</span>IsEof()) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mod_wave <span class="G">=</span> String(s, p<span class="G">.</span>GetPtr());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">break</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p<span class="G">.</span>SkipTerm();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p<span class="G">.</span>Char('<span class="G">]</span>');</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(;;) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(p<span class="G">.</span>Char('@'))</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mod_amplitude <span class="G">=</span> p<span class="G">.</span>ReadDouble();</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(p<span class="G">.</span>Char('<span class="G">^</span>'))</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mod_frequency <span class="G">=</span> p<span class="G">.</span>ReadDouble();</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">break</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(p<span class="G">.</span>Char('<span class="G">&lt;</span>')) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;has_noise <span class="G">=</span> <span class="G">true</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> ii <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">while</span>(<span class="G">!</span>p<span class="G">.</span>Char('<span class="G">&gt;</span>') <span class="G">&amp;&amp;</span> ii <span class="G">&lt;</span> 8)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;noise<span class="G">[</span>ii<span class="G">++]</span> <span class="G">=</span> p<span class="G">.</span>ReadDouble();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(p<span class="G">.</span>Char('a'))</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;attack <span class="G">=</span> p<span class="G">.</span>ReadDouble();</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(p<span class="G">.</span>Char('d'))</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;decay <span class="G">=</span> p<span class="G">.</span>ReadDouble();</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(p<span class="G">.</span>Char('s'))</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sustain <span class="G">=</span> p<span class="G">.</span>ReadDouble();</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(p<span class="G">.</span>Char('r'))</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;release <span class="G">=</span> p<span class="G">.</span>ReadDouble();</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">break</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Instrument<span class="G">::</span>Read(<span class="G">const</span> <span class="G">char</span> <span class="G">*</span>s)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">try</span> {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CParser p(s);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Read(p);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">catch</span>(<span class="G">...</span>) {}</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="E">Core.cpp</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#include</span> &quot;Synth<span class="G">.</span>h&quot;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#ifdef</span> PLATFORM_POSIX</p>
<p class="H">#include<span class="I"> </span>&lt;<span class="I">SDL2</span>/<span class="I">SDL</span>.<span class="I">h</span>&gt;</p>
<p class="H">#else</p>
<p class="H">#include<span class="I"> </span>&lt;<span class="I">SDL</span>.<span class="I">h</span>&gt;</p>
<p class="H">#endif</p>
<p class="F">&nbsp;</p>
<p class="F">SoundGen app_sch<span class="G">[</span>NUM_CHANNELS<span class="G">]</span>; <span class="G">//</span> to avoid lengthy locking, keep copy under different mutex</p>
<p class="F">SoundGen gen_sch<span class="G">[</span>NUM_CHANNELS<span class="G">]</span>; <span class="G">//</span> <span class="G">this</span> is copied to generator <span class="G">and</span> used to actually generate the sound</p>
<p class="F">&nbsp;</p>
<p class="F">INITBLOCK {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> 0; i <span class="G">&lt;</span> NUM_CHANNELS; i<span class="G">++</span>) <span class="G">//</span> initialize wave_tab</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> j <span class="G">=</span> 0; j <span class="G">&lt;</span> OPCOUNT; j<span class="G">++</span>) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;app_sch<span class="G">[</span>i<span class="G">].</span>op<span class="G">[</span>j<span class="G">].</span>Comp();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gen_sch<span class="G">[</span>i<span class="G">].</span>op<span class="G">[</span>j<span class="G">].</span>Comp();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">int</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in_sch_serial;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#if</span> 1</p>
<p class="F"><span class="G">struct</span> AppSoundLock {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;AppSoundLock() { SDL_LockAudio(); }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">~</span>AppSoundLock() { SDL_UnlockAudio(); }</p>
<p class="F">};</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">struct</span> GenSoundLock {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GenSoundLock() {}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">~</span>GenSoundLock() {}</p>
<p class="F">};</p>
<p class="H">#else</p>
<p class="F">SpinLock s_in_sch_lock;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">struct</span> AppSoundLock {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;AppSoundLock() { s_in_sch_lock<span class="G">.</span>Enter(); }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">~</span>AppSoundLock() { s_in_sch_lock<span class="G">.</span>Leave(); }</p>
<p class="F">};</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">struct</span> GenSoundLock {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GenSoundLock() { s_in_sch_lock<span class="G">.</span>Enter(); }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">~</span>GenSoundLock() { s_in_sch_lock<span class="G">.</span>Leave(); }</p>
<p class="F">};</p>
<p class="H">#endif</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> SetChannel(<span class="G">int</span> chi, <span class="G">const</span> Sound<span class="G">&amp;</span> c, <span class="G">int</span> priority, <span class="G">int</span> id)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;AppSoundLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;SoundGen<span class="G">&amp;</span> ch <span class="G">=</span> app_sch<span class="G">[</span>chi<span class="G">]</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ch<span class="G">.</span>Start(c);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ch<span class="G">.</span>priority <span class="G">=</span> priority;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ch<span class="G">.</span>serial <span class="G">=</span> <span class="G">++</span>in_sch_serial;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ch<span class="G">.</span>id <span class="G">=</span> id;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> StopChannels(<span class="G">int</span> id)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;AppSoundLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> 0; i <span class="G">&lt;</span> NUM_CHANNELS; i<span class="G">++</span>) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SoundGen<span class="G">&amp;</span> ch <span class="G">=</span> app_sch<span class="G">[</span>i<span class="G">]</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(ch<span class="G">.</span>id <span class="G">==</span> id) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ch<span class="G">.</span>serial <span class="G">=</span> <span class="G">++</span>in_sch_serial;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ch<span class="G">.</span>current_volume <span class="G">=</span> app_sch<span class="G">[</span>i<span class="G">].</span>op<span class="G">[</span>0<span class="G">].</span>volume <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> SetChannelVolume(<span class="G">int</span> chi, <span class="G">double</span> volume)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;AppSoundLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;SoundGen<span class="G">&amp;</span> ch <span class="G">=</span> app_sch<span class="G">[</span>chi<span class="G">]</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ch<span class="G">.</span>param_serial <span class="G">=</span> <span class="G">++</span>in_sch_serial;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ch<span class="G">.</span>op<span class="G">[</span>0<span class="G">].</span>volume <span class="G">=</span> pow(10, (volume <span class="G">-</span> 100) <span class="G">/</span> 40);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">int</span> FindChannel(<span class="G">int</span> priority, <span class="G">int</span> from, <span class="G">double</span> new_volume)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;new_volume <span class="G">=</span> pow(10, (new_volume <span class="G">-</span> 100) <span class="G">/</span> 40);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;AppSoundLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> &nbsp;&nbsp;&nbsp;besti <span class="G">=</span> <span class="G">-</span>1;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> &nbsp;&nbsp;&nbsp;best_priority <span class="G">=</span> INT_MAX;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> best_volume <span class="G">=</span> 100;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> from; i <span class="G">&lt;</span> NUM_CHANNELS; i<span class="G">++</span>) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SoundGen<span class="G">&amp;</span> ch <span class="G">=</span> app_sch<span class="G">[</span>i<span class="G">]</span>;</p>
<p class="F"><span class="G">//</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(ch<span class="G">.</span>current_volume <span class="G">&lt;</span> 0<span class="G">.</span>001) {</p>
<p class="F"><span class="G">//</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;besti <span class="G">=</span> i;</p>
<p class="F"><span class="G">//</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">break</span>;</p>
<p class="F"><span class="G">//</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if<span class="I">(</span>/*<span class="I">ch</span>.<span class="I">priority </span>&lt;=<span class="I"> priority </span>&amp;&amp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;(ch<span class="G">.</span>priority <span class="G">&lt;</span> best_priority <span class="G">||</span> ch<span class="G">.</span>priority <span class="G">==</span> best_priority <span class="G">&amp;&amp;</span> <span class="G">*/</span>ch<span class="G">.</span>current_volume <span class="G">&lt;</span> best_volume) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;besti <span class="G">=</span> i;</p>
<p class="F"><span class="G">//</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;best_priority <span class="G">=</span> ch<span class="G">.</span>priority;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;best_volume <span class="G">=</span> ch<span class="G">.</span>current_volume;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F"><span class="G">//</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> besti;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> best_volume <span class="G">&lt;</span> new_volume <span class="G">?</span> besti <span class="G">:</span> <span class="G">-</span>1;</p>
<p class="F"><span class="G">//</span>&nbsp;&nbsp;&nbsp;&nbsp;DDUMP(best_volume);</p>
<p class="F"><span class="G">//</span>&nbsp;&nbsp;&nbsp;&nbsp;DDUMP(besti);</p>
<p class="F"><span class="G">/*</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(besti <span class="G">&lt;</span> 0)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> from; i <span class="G">&lt;</span> NUM_CHANNELS; i<span class="G">++</span>)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(app_sch<span class="G">[</span>i<span class="G">].</span>current_volume <span class="G">&lt;</span> 0<span class="G">.</span>01) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;besti <span class="G">=</span> i;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">break</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;</span>return<span class="I"> besti;</span>*/</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">extern</span> <span class="G">void</span> Sequencer(<span class="G">int</span> chunk_size);</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">float</span> global_volume <span class="G">=</span> 1;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> SetGlobalVolume(<span class="G">float</span> vol)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;AppSoundLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;global_volume <span class="G">=</span> vol;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> MyAudioCallback(<span class="G">void</span> <span class="G">*</span>, Uint8 <span class="G">*</span>stream, <span class="G">int</span> len)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> chunk_size <span class="G">=</span> len <span class="G">/</span> (2 <span class="G">*</span> <span class="G">sizeof</span>(<span class="G">float</span>));</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Sequencer(chunk_size);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;{</p>
<p class="F"><span class="G">#if</span> 0</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RLOG(&quot;<span class="G">====================================</span>&quot;);</p>
<p class="H">#endif</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GenSoundLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> 0; i <span class="G">&lt;</span> NUM_CHANNELS; i<span class="G">++</span>) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(app_sch<span class="G">[</span>i<span class="G">].</span>serial <span class="G">!=</span> gen_sch<span class="G">[</span>i<span class="G">].</span>serial)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gen_sch<span class="G">[</span>i<span class="G">]</span> <span class="G">=</span> app_sch<span class="G">[</span>i<span class="G">]</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(app_sch<span class="G">[</span>i<span class="G">].</span>param_serial <span class="G">!=</span> gen_sch<span class="G">[</span>i<span class="G">].</span>param_serial) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gen_sch<span class="G">[</span>i<span class="G">].</span>op<span class="G">[</span>0<span class="G">].</span>volume <span class="G">=</span> app_sch<span class="G">[</span>i<span class="G">].</span>op<span class="G">[</span>0<span class="G">].</span>volume;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gen_sch<span class="G">[</span>i<span class="G">].</span>current_volume <span class="G">=</span> 1;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;app_sch<span class="G">[</span>i<span class="G">].</span>param_serial <span class="G">=</span> gen_sch<span class="G">[</span>i<span class="G">].</span>param_serial;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F"><span class="G">#if</span> 0</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RLOG(i);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RLOG(gen_sch<span class="G">[</span>i<span class="G">]</span>);</p>
<p class="H">#endif</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">float</span> <span class="G">*</span>d <span class="G">=</span> (<span class="G">float</span> <span class="G">*</span>)stream;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;memset(d, 0, len);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> j <span class="G">=</span> 0; j <span class="G">&lt;</span> NUM_CHANNELS; j<span class="G">++</span>) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SoundGen<span class="G">&amp;</span> ch <span class="G">=</span> gen_sch<span class="G">[</span>j<span class="G">]</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d <span class="G">=</span> (<span class="G">float</span> <span class="G">*</span>)stream;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> v <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> 0; i <span class="G">&lt;</span> chunk_size; i<span class="G">++</span>) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">float</span> h <span class="G">=</span> ch<span class="G">.</span>Get();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">*</span>d<span class="G">++</span> <span class="G">+=</span> ch<span class="G">.</span>lpan <span class="G">*</span> h;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">*</span>d<span class="G">++</span> <span class="G">+=</span> ch<span class="G">.</span>rpan <span class="G">*</span> h;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">float</span> <span class="G">*</span>e <span class="G">=</span> (<span class="G">float</span> <span class="G">*</span>)stream <span class="G">+</span> 2 <span class="G">*</span> chunk_size;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">float</span> <span class="G">*</span>d <span class="G">=</span> (<span class="G">float</span> <span class="G">*</span>)stream; d <span class="G">&lt;</span> e; d<span class="G">++</span>)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">*</span>d <span class="G">=</span> clamp(<span class="G">*</span>d <span class="G">*</span> global_volume, <span class="G">-</span>1<span class="G">.</span>0f, 1<span class="G">.</span>0f);</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GenSoundLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> 0; i <span class="G">&lt;</span> NUM_CHANNELS; i<span class="G">++</span>) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;app_sch<span class="G">[</span>i<span class="G">].</span>current_volume <span class="G">=</span> gen_sch<span class="G">[</span>i<span class="G">].</span>current_volume;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> InitSoundSynth(<span class="G">bool</span> initsdl)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(initsdl <span class="G">&amp;&amp;</span> SDL_Init(SDL_INIT_VIDEO<span class="G">|</span>SDL_INIT_AUDIO) <span class="G">&lt;</span> 0)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;SDL_AudioSpec want;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;memset(<span class="G">&amp;</span>want, 0, <span class="G">sizeof</span>(want));</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;want<span class="G">.</span>freq <span class="G">=</span> 44100;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;want<span class="G">.</span>format <span class="G">=</span> AUDIO_F32SYS;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;want<span class="G">.</span>channels <span class="G">=</span> 2;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;want<span class="G">.</span>samples <span class="G">=</span> CHUNK_SIZE;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;want<span class="G">.</span>callback <span class="G">=</span> MyAudioCallback;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(SDL_OpenAudio(<span class="G">&amp;</span>want, NULL) <span class="G">&lt;</span> 0)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;LOG(&quot;Failed to open audio<span class="G">:</span> &quot; <span class="G">+</span> (String)SDL_GetError());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;SDL_PauseAudio(0);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> CloseSoundSynth(<span class="G">bool</span> exitsdl)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;SDL_CloseAudio();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(exitsdl)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SDL_Quit();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="E">Operator.cpp</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#include</span> &quot;Synth<span class="G">.</span>h&quot;</p>
<p class="F">&nbsp;</p>
<p class="F">Sound<span class="G">::</span>Sound()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;op<span class="G">[</span>0<span class="G">].</span>duration <span class="G">=</span> 250;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;op<span class="G">[</span>0<span class="G">].</span>volume <span class="G">=</span> 100;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">String Aformat(<span class="G">double</span> x)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> (<span class="G">int</span>)x <span class="G">==</span> x <span class="G">?</span> AsString(x) <span class="G">:</span> x <span class="G">&lt;</span> 100000 <span class="G">?</span> Format(&quot;<span class="G">%.</span>2f&quot;, x) <span class="G">:</span> Format(&quot;<span class="G">%</span>g&quot;, x);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="H"><span class="I">String FMOP</span>::<span class="I">Save() </span>const</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;String r;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">auto</span> Put <span class="G">=</span> <span class="G">[&amp;]</span>(<span class="G">char</span> c, <span class="G">double</span> val, <span class="G">double</span> def) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(val <span class="G">!=</span> def)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r <span class="G">&lt;&lt;</span> c <span class="G">&lt;&lt;</span> Aformat(val);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;};</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Put('L', duration, 99000);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Put('V', volume, 0);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Put('f', f, 1);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Put('r', fdrift, 0);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Put('A', attack, 100);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Put('D', decay, 100);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Put('S', sustain, 100);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Put('R', release, 100);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> r <span class="G">+</span> decode(waveform, WAVEFORM_SQUARE, &quot;Q&quot;,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WAVEFORM_TRIANGLE, &quot;T&quot;,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WAVEFORM_SAWTOOTH, &quot;W&quot;,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WAVEFORM_BROWN, &quot;B&quot;,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WAVEFORM_WHITE, &quot;N&quot;,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WAVEFORM_SIN, &quot;&quot;,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">~</span>(&quot;w&quot; <span class="G">+</span> AsString(waveform <span class="G">-</span> WAVEFORM_FIRSTSAMPLE)));</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">const</span> <span class="G">char</span> <span class="G">*</span> FMOP<span class="G">::</span>Load(<span class="G">const</span> <span class="G">char</span> <span class="G">*</span>s)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">auto</span> Get <span class="G">=</span> <span class="G">[&amp;]</span>(<span class="G">double&amp;</span> r) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">try</span> {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CParser p(s);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(p<span class="G">.</span>IsDouble())</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r <span class="G">=</span> p<span class="G">.</span>ReadDouble();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s <span class="G">=</span> p<span class="G">.</span>GetPtr();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">catch</span>(CParser<span class="G">::</span>Error) {}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;};</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">while</span>(<span class="G">*</span>s) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">*</span>s <span class="G">==</span> '<span class="G">:</span>') {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">break</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">switch</span>(<span class="G">*</span>s<span class="G">++</span>) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">case</span> 'L'<span class="G">:</span> Get(duration); <span class="G">break</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">case</span> 'V'<span class="G">:</span> Get(volume); <span class="G">break</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">case</span> 'f'<span class="G">:</span> Get(f); <span class="G">break</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">case</span> 'r'<span class="G">:</span> Get(fdrift); <span class="G">break</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">case</span> 'A'<span class="G">:</span> Get(attack); <span class="G">break</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">case</span> 'D'<span class="G">:</span> Get(decay); <span class="G">break</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">case</span> 'S'<span class="G">:</span> Get(sustain); <span class="G">break</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">case</span> 'R'<span class="G">:</span> Get(release); <span class="G">break</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">case</span> 'Q'<span class="G">:</span> waveform <span class="G">=</span> WAVEFORM_SQUARE; <span class="G">break</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">case</span> 'T'<span class="G">:</span> waveform <span class="G">=</span> WAVEFORM_TRIANGLE; <span class="G">break</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">case</span> 'W'<span class="G">:</span> waveform <span class="G">=</span> WAVEFORM_SAWTOOTH; <span class="G">break</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">case</span> 'B'<span class="G">:</span> waveform <span class="G">=</span> WAVEFORM_BROWN; <span class="G">break</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">case</span> 'N'<span class="G">:</span> waveform <span class="G">=</span> WAVEFORM_WHITE; <span class="G">break</span>;</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>case<span class="I"> 'w'</span>:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> w;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Get(w);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;waveform <span class="G">=</span> clamp(WAVEFORM_FIRSTSAMPLE <span class="G">+</span> (<span class="G">int</span>)w, (<span class="G">int</span>)WAVEFORM_FIRSTSAMPLE, (<span class="G">int</span>)WAVEFORM_LASTSAMPLE);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> s;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="H"><span class="I">String Sound</span>::<span class="I">Save() </span>const</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;String r;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;r <span class="G">&lt;&lt;</span> Aformat(f) <span class="G">&lt;&lt;</span> '<span class="G">:</span>';</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> 0; i <span class="G">&lt;</span> OPCOUNT; i<span class="G">++</span>) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(i)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r <span class="G">&lt;&lt;</span> '<span class="G">:</span>';</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r <span class="G">&lt;&lt;</span> op<span class="G">[</span>i<span class="G">].</span>Save();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> r;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Sound<span class="G">::</span>Load(<span class="G">const</span> <span class="G">char</span> <span class="G">*</span>s)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">try</span> {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CParser p(s);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(p<span class="G">.</span>IsDouble())</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f <span class="G">=</span> p<span class="G">.</span>ReadDouble();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p<span class="G">.</span>Char('<span class="G">:</span>');</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s <span class="G">=</span> p<span class="G">.</span>GetPtr();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> 0; i <span class="G">&lt;</span> OPCOUNT; i<span class="G">++</span>)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s <span class="G">=</span> op<span class="G">[</span>i<span class="G">].</span>Load(s);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">catch</span>(CParser<span class="G">::</span>Error) {}</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="E">FM.cpp</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#include</span> &quot;Synth<span class="G">.</span>h&quot;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">double</span> ADSR<span class="G">::</span>Evaluate(<span class="G">double</span> t, <span class="G">double</span> duration)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(t <span class="G">&lt;</span> delay)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(t <span class="G">&gt;</span> duration) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t <span class="G">-=</span> duration;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(t <span class="G">&gt;</span> release)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> sustain <span class="G">*</span> (release <span class="G">-</span> t) <span class="G">/</span> release;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;t <span class="G">-=</span> delay;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(t <span class="G">&lt;</span> attack)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> t <span class="G">/</span> attack;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;t <span class="G">-=</span> attack;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(t <span class="G">&lt;</span> decay) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> (sustain <span class="G">*</span> t <span class="G">+</span> decay <span class="G">-</span> t) <span class="G">/</span> decay;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> sustain;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">struct</span> FMSound <span class="G">:</span> SoundGenerator, FMPatch {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">bool</span> Get(<span class="G">float</span> <span class="G">*</span>data, <span class="G">int</span> len);</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> &nbsp;volume;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> &nbsp;duration;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> &nbsp;fc, fm1, fm2, fmf;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> &nbsp;&nbsp;&nbsp;&nbsp;ti <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> &nbsp;noisedir <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> &nbsp;noiseval <span class="G">=</span> 0;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> SetVolume(<span class="G">double</span> vol) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ volume <span class="G">=</span> vol; }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> Set(<span class="G">double</span> volume, <span class="G">double</span> frequency, <span class="G">double</span> duration, <span class="G">const</span> FMPatch<span class="G">&amp;</span> m);</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;FMSound(<span class="G">double</span> volume, <span class="G">double</span> frequency, <span class="G">double</span> duration, <span class="G">const</span> FMPatch<span class="G">&amp;</span> m) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set(volume, frequency, duration, m);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">};</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> FMSound<span class="G">::</span>Set(<span class="G">double</span> volume, <span class="G">double</span> frequency, <span class="G">double</span> duration, <span class="G">const</span> FMPatch<span class="G">&amp;</span> m)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;(FMPatch<span class="G">&amp;</span>)<span class="G">*this</span> <span class="G">=</span> m;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">this-&gt;</span>volume <span class="G">=</span> volume;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">this-&gt;</span>duration <span class="G">=</span> duration;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;fc <span class="G">=</span> frequency;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;fm1 <span class="G">=</span> fc <span class="G">*</span> m1;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;fm2 <span class="G">=</span> fc <span class="G">*</span> m2;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;fmf <span class="G">=</span> fc <span class="G">*</span> mf;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">bool</span> FMSound<span class="G">::</span>Get(<span class="G">float</span> <span class="G">*</span>b, <span class="G">int</span> len)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">bool</span> plays <span class="G">=</span> <span class="G">true</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> t;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> 0; i <span class="G">&lt;</span> len; i<span class="G">++</span>) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t <span class="G">=</span> ti <span class="G">*</span> (1<span class="G">.</span>0 <span class="G">/</span> 44200);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> pt <span class="G">=</span> M_2PI <span class="G">*</span> t;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> dword state <span class="G">=</span> 1;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state <span class="G">^=</span> state <span class="G">&lt;&lt;</span> 13;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state <span class="G">^=</span> state <span class="G">&gt;&gt;</span> 17;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state <span class="G">^=</span> state <span class="G">&lt;&lt;</span> 5;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">double</span> white <span class="G">=</span> 2<span class="G">.</span>0 <span class="G">/</span> 4294967295<span class="G">.</span>0 <span class="G">*</span> state <span class="G">-</span> 1;</p>
<p class="F"><span class="G">/*</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;noisedir <span class="G">=</span> clamp(noisedir <span class="G">+</span> 0<span class="G">.</span>0001 <span class="G">*</span> fc <span class="G">*</span> white, <span class="G">-</span>0<span class="G">.</span>08, 0<span class="G">.</span>08);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;noiseval <span class="G">=</span> noisedir;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(noiseval <span class="G">&gt;</span> 1) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;noisedir <span class="G">=</span> <span class="G">-</span>abs(noisedir);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;noiseval <span class="G">=</span> 1;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(noiseval <span class="G">&lt;</span> 0) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;noisedir <span class="G">=</span> abs(noisedir);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;noiseval <span class="G">=</span> <span class="G">-</span>1;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">*</span>b<span class="G">++</span> <span class="G">=</span> tanh(noiseval);</p>
<p class="F"><span class="G">*/</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">*</span>b<span class="G">++</span> <span class="G">=</span> <span class="G">float</span>(volume <span class="G">*</span> adsr<span class="G">.</span>Evaluate(t, duration)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">*</span> sin(pt <span class="G">*</span> fc <span class="G">+</span> adsr1<span class="G">.</span>Evaluate(t, duration)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">*</span> beta1</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">*</span> sin(pt <span class="G">*</span> fm1 <span class="G">+</span> betan <span class="G">*</span> white <span class="G">+</span> betaf <span class="G">*</span> adsrf<span class="G">.</span>Evaluate(t, duration) <span class="G">*</span> sin(pt <span class="G">*</span> fmf))</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">+</span> adsr2<span class="G">.</span>Evaluate(t, duration) <span class="G">*</span> beta2 <span class="G">*</span> sin(pt <span class="G">*</span> fm2)));</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ti<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> t <span class="G">&lt;</span> duration <span class="G">+</span> adsr<span class="G">.</span>release;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">int64 Play(<span class="G">double</span> volume, <span class="G">double</span> frequency, <span class="G">double</span> duration, <span class="G">const</span> FMPatch<span class="G">&amp;</span> patch)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> AddSound(<span class="G">new</span> FMSound(volume, frequency, duration, patch));</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
</TD>
</TR>
</TABLE>
</TD>
</TR>
</TABLE>
<TABLE BORDER="0" WIDTH="100%"><TR><TD></TD>
</TR>
</TABLE>
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="0" BGCOLOR="#FFFFFF" WIDTH="100%" style="border-style: solid; border-width: 1px; border-color: #6E89AE;padding: 10px;;"><TR><TD><TABLE BORDER="0" CELLSPACING="0" CELLPADDING="0" WIDTH="100%"><TR><TD><p class="A"><span class="B"> </span><a href="www$uppweb$contribweb$en-us.html">Do you want to contribute?</a></p>
</TD>
</TR>
</TABLE>
</TD>
</TR>
</TABLE>
</TD>
</TR>
</TABLE>
<script type="text/javascript">var a={'examples$Synth$en-us.html':'English'};var p=window.location.pathname.split("/");p=p[p.length-1];var s='<select id="lang" onchange="window.location=document.getElementById(\'lang\').value;">';for(l in a){if(p==l){d=" selected=1"}else{d=""}s+='<option value="'+l+'"'+d+'>'+a[l]+'</option>'}s+='</select>';var d=document.createElement('div');d.innerHTML=s;var c=document.getElementById('langs');c.replaceChild(d,c.firstChild);document.getElementById('langbox').style.display='block';</script></BODY>
