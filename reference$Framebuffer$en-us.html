<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML lang="en-us">
<HEAD>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="Generator" CONTENT="U++ HTML Package">
<TITLE>Examples / Framebuffer :: U++</TITLE>
<STYLE TYPE="text/css"><!--
.A{margin:0px 0px 0px 0px;text-indent:0px;text-align:left;color:#000000;font-family:sans-serif;font-size:10pt;font-weight:normal;font-style:normal;}
.B{font-size:12pt;}
.C{margin:0px 0px 0px 0px;text-indent:0px;text-align:left;color:#000000;font-family:serif;font-size:24pt;font-weight:bold;font-style:normal;}
.D{margin:0px 0px 0px 0px;text-indent:0px;text-align:left;color:#000000;font-family:sans-serif;font-size:12pt;font-weight:normal;font-style:normal;}
.E{margin:0px 0px 0px 0px;text-indent:0px;text-align:left;color:#000000;font-family:sans-serif;font-size:16pt;font-weight:bold;font-style:normal;}
.F{margin:0px 0px 0px 0px;text-indent:0px;text-align:left;color:#000000;font-family:monospace;font-size:9pt;font-weight:normal;font-style:normal;}
.G{color:#0000ff;}
.H{margin:0px 0px 0px 0px;text-indent:0px;text-align:left;color:#0000ff;font-family:monospace;font-size:9pt;font-weight:normal;font-style:normal;}
.I{color:#000000;}
a.l1         { text-decoration:none; font-size: 8pt; font-family: sans-serif; font-weight: normal; }
a.l1:link    { color:#000000; }
a.l1:visited { color:#000080; }
a.l1:hover   { color:#9933CC; }
a.l1:active  { color:#000000; }
a.l2         { text-decoration:none; font-size: 12pt; font-family: sans-serif; font-variant: small-caps; }
a.l2:link    { color:#0066FF; }
a.l2:visited { color:#FF6600; }
a.l2:hover   { color:#BC0624; }
a.l2:active  { color:#BC0024; }

-->
</STYLE>
<META NAME="keywords" CONTENT="framework, toolkit, widget, c++, visual, studio, dev-cpp, builder, ide, class, component,wxwidgets, qt, rapid, application, development, rad, mfc, linux, macos, gui, sdl, directx, desktop"><META name="robots" content="index,follow">
<LINK rel="alternate" type="application/rss+xml" title="SVN changes" href="svnchanges.xml">
<LINK rel="shortcut icon" type="image/png" href="favicon.png">
</HEAD><BODY BGCOLOR="#D2D9D2" ALINK="#800000" LINK="#000000" VLINK="#000080"><TABLE BORDER="0" CELLSPACING="0" CELLPADDING="0" WIDTH="100%"><TR><TD COLSPAN="3"><TABLE BORDER="0" CELLSPACING="0" CELLPADDING="0" WIDTH="100%" BGCOLOR="#FFFFFF" style="border: 1px solid #6E89AE;padding-left: 10px;padding-right: 0px;padding-top: 0px;padding-bottom: 0px;"><TR><TD><A HREF="index.html"><IMG SRC="0i.png" ALT="" BORDER="0"></A>
</TD>
<TD ALIGN="RIGHT" VALIGN="BOTTOM" STYLE="padding-bottom: 5px; background-image: url('1i.png')"><span style="font-size: 14pt; font-family: sans-serif;"><script type="text/javascript"><!--
google_ad_client = "pub-1082147624384270";
google_ad_width = 468;
google_ad_height = 60;
google_ad_format = "468x60_as";
google_ad_type = "text_image";
google_ad_channel = "";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_text = "000000";
google_color_url = "008000";
//--></script>
<script type="text/javascript"
  src="https://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
&nbsp;&nbsp;</span>
</TD>
</TR>
</TABLE>
</TD>
</TR>
</TABLE>
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="0" WIDTH="100%"><TR><TD COLSPAN="3" BGCOLOR="#D2D9D2" HEIGHT="6"></TD>
</TR>
<TR><TD VALIGN="TOP" ALIGN="CENTER"><TABLE BORDER="0" CELLSPACING="0" CELLPADDING="0" WIDTH="160"><TR><TD ALIGN="CENTER"><TABLE BORDER="0" CELLSPACING="0" CELLPADDING="0" WIDTH="100%" BGCOLOR="#FFFFFF" style="border-style: solid; border-width: 1px; border-color: #6E89AE;padding: 0px"><TR><TD WIDTH="100%" VALIGN="MIDDLE" STYLE="background-image: url('2i.png'); border: 0px solid black; padding-left:12px; padding-right:0px; padding-top:6px; padding-bottom:6px;"><A HREF="www$uppweb$overview$en-us.html" CLASS="l1">Overview</A>
</TD>
</TR>
<TR><TD WIDTH="100%" VALIGN="MIDDLE" STYLE="background-image: url('2i.png'); border: 0px solid black; padding-left:12px; padding-right:0px; padding-top:6px; padding-bottom:6px; border-top: 1px solid #6E89AE;"><A HREF="www$uppweb$examples$en-us.html" CLASS="l1">Examples</A>
</TD>
</TR>
<TR><TD WIDTH="100%" VALIGN="MIDDLE" STYLE="background-image: url('2i.png'); border: 0px solid black; padding-left:12px; padding-right:0px; padding-top:6px; padding-bottom:6px; border-top: 1px solid #6E89AE;"><A HREF="www$uppweb$ss$en-us.html" CLASS="l1">Screenshots</A>
</TD>
</TR>
<TR><TD WIDTH="100%" VALIGN="MIDDLE" STYLE="background-image: url('2i.png'); border: 0px solid black; padding-left:12px; padding-right:0px; padding-top:6px; padding-bottom:6px; border-top: 1px solid #6E89AE;"><A HREF="www$uppweb$comparison$en-us.html" CLASS="l1">Comparisons</A>
</TD>
</TR>
<TR><TD WIDTH="100%" VALIGN="MIDDLE" STYLE="background-image: url('2i.png'); border: 0px solid black; padding-left:12px; padding-right:0px; padding-top:6px; padding-bottom:6px; border-top: 1px solid #6E89AE;"><A HREF="www$uppweb$apps$en-us.html" CLASS="l1">Applications</A>
</TD>
</TR>
<TR><TD WIDTH="100%" VALIGN="MIDDLE" STYLE="background-image: url('2i.png'); border: 0px solid black; padding-left:12px; padding-right:0px; padding-top:6px; padding-bottom:6px; border-top: 1px solid #6E89AE;"><A HREF="www$uppweb$download$en-us.html" CLASS="l1">Download</A>
</TD>
</TR>
<TR><TD WIDTH="100%" VALIGN="MIDDLE" STYLE="background-image: url('2i.png'); border: 0px solid black; padding-left:12px; padding-right:0px; padding-top:6px; padding-bottom:6px; border-top: 1px solid #6E89AE;"><A HREF="www$uppweb$documentation$en-us.html" CLASS="l1">Documentation</A>
</TD>
</TR>
<TR><TD WIDTH="100%" VALIGN="MIDDLE" STYLE="background-image: url('2i.png'); border: 0px solid black; padding-left:12px; padding-right:0px; padding-top:6px; padding-bottom:6px; border-top: 1px solid #6E89AE;"><A HREF="www$uppweb$Tutorials$en-us.html" CLASS="l1">Tutorials</A>
</TD>
</TR>
<TR><TD WIDTH="100%" VALIGN="MIDDLE" STYLE="background-image: url('2i.png'); border: 0px solid black; padding-left:12px; padding-right:0px; padding-top:6px; padding-bottom:6px; border-top: 1px solid #6E89AE;"><A HREF="app$ide$UppHub$en-us.html" CLASS="l1">UppHub</A>
</TD>
</TR>
<TR><TD WIDTH="100%" VALIGN="MIDDLE" STYLE="background-image: url('2i.png'); border: 0px solid black; padding-left:12px; padding-right:0px; padding-top:6px; padding-bottom:6px; border-top: 1px solid #6E89AE;"><A HREF="www$uppweb$Roadmap$en-us.html" CLASS="l1">Status & Roadmap</A>
</TD>
</TR>
<TR><TD WIDTH="100%" VALIGN="MIDDLE" STYLE="background-image: url('2i.png'); border: 0px solid black; padding-left:12px; padding-right:0px; padding-top:6px; padding-bottom:6px; border-top: 1px solid #6E89AE;"><A HREF="www$uppweb$FAQ$en-us.html" CLASS="l1">FAQ</A>
</TD>
</TR>
<TR><TD WIDTH="100%" VALIGN="MIDDLE" STYLE="background-image: url('2i.png'); border: 0px solid black; padding-left:12px; padding-right:0px; padding-top:6px; padding-bottom:6px; border-top: 1px solid #6E89AE;"><A HREF="app$ide$About$en-us.html" CLASS="l1">Authors & License</A>
</TD>
</TR>
<TR><TD WIDTH="100%" VALIGN="MIDDLE" STYLE="background-image: url('2i.png'); border: 0px solid black; padding-left:12px; padding-right:0px; padding-top:6px; padding-bottom:6px; border-top: 1px solid #6E89AE;"><A HREF="https://www.ultimatepp.org/forums" CLASS="l1">Forums</A>
</TD>
</TR>
<TR><TD WIDTH="100%" VALIGN="MIDDLE" STYLE="background-image: url('2i.png'); border: 0px solid black; padding-left:12px; padding-right:0px; padding-top:6px; padding-bottom:6px; border-top: 1px solid #6E89AE;"><A HREF="www$uppweb$Funding$en-us.html" CLASS="l1">Funding U++</A>
</TD>
</TR>
</TABLE>
<TABLE BORDER="0" WIDTH="100%"><TR><TD></TD>
</TR>
</TABLE>
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="0" WIDTH="100%" BGCOLOR="#FFFFFF" style="border-style: solid; border-width: 1px; border-color: #6E89AE;padding: 0px"><TR><TD WIDTH="100%" VALIGN="MIDDLE" STYLE="background-image: url('3i.png'); border: 0px solid black;padding-left:12px; padding-right:0px; padding-top:1px; padding-bottom:1px;color:#FFFFFF;"><B><span style="font-size: 8pt; font-family: sans-serif;">Search on this site</span>
</B>
</TD>
</TR>
<TR><TD WIDTH="100%" VALIGN="MIDDLE" STYLE="background-image: url('2i.png'); border: 0px solid black; padding-left:6px; padding-right:0px; padding-top:4px; padding-bottom:4px;border-top: 1px solid #6E89AE;"><TABLE BORDER="0" CELLSPACING="0" CELLPADDING="0" WIDTH="100%"><TR><TD><IMG SRC="4i.png" ALT="" BORDER="0"></TD>
<TD><FORM ACTION="https://www.google.com/search" METHOD="GET" STYLE="margin:0px;padding:0px;"><INPUT TYPE="HIDDEN" NAME="ie" VALUE="UTF-8"><INPUT TYPE="HIDDEN" NAME="oe" VALUE="UTF-8"><INPUT TYPE="TEXT" NAME="q" SIZE="15" MAXLENGTH="256" placeholder="Site search"><INPUT TYPE="HIDDEN" NAME="sitesearch" VALUE="ultimatepp.org"></FORM>
</TD>
</TR>
</TABLE>
</TD>
</TR>
</TABLE>
<TABLE BORDER="0" WIDTH="100%"><TR><TD></TD>
</TR>
</TABLE>
<br><div id="fb-root"></div>
<script type="text/javascript">(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

<div class="fb-like" data-href="https://www.facebook.com/pages/Upp-Framework/262346610476027?sk=wall" data-send="false" data-layout="button_count" data-width="160" data-show-faces="false" data-font="arial"></div>
<br><br><script type="text/javascript"><!--
google_ad_client = "pub-1082147624384270";
google_ad_width = 160;
google_ad_height = 600;
google_ad_format = "160x600_as";
google_ad_type = "text_image";
google_ad_channel = "";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_text = "000000";
google_color_url = "008000";
//--></script>
<script type="text/javascript"
  src="https://pagead2.googlesyndication.com/pagead/show_ads.js">
</script><br><br><script type="text/javascript"><!--
google_ad_client = "pub-1082147624384270";
google_ad_width = 160;
google_ad_height = 90;
google_ad_format = "160x90_0ads_al_s";
google_ad_channel = "";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_text = "000000";
google_color_url = "008000";
//--></script>
<script type="text/javascript"
  src="https://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<br><br><br><br><br><br><A HREF="https://sourceforge.net/projects/upp/"><IMG SRC="https://sourceforge.net/sflogo.php?group_id=93970&amp;type=2" ALT="SourceForge.net Logo" BORDER="0" WIDTH="125" HEIGHT="37"></A>
<br><br><A HREF="https://flathub.org/en/apps/org.ultimatepp.TheIDE"><IMG SRC="5i.png" ALT="SourceForge.net Logo" BORDER="0" WIDTH="125" HEIGHT="37"></A>
<br><br><div style="background-color:#ffffff;width:125;height:35"><A HREF="https://github.com/ultimatepp"><IMG SRC="6i.png" ALT="GitHub Logo" BORDER="0" WIDTH="125" HEIGHT="35"></A>
</div><br><div style="background-color:#ffffff;width:125;height:35"><div style="height:5"></div><A HREF="https://discord.gg/8XzqQzXZzb"><IMG SRC="https://assets-global.website-files.com/6257adef93867e50d84d30e2/636e0b5061df29d55a92d945_full_logo_blurple_RGB.svg" ALT="Discord Logo" BORDER="0" WIDTH="125" HEIGHT="25"></A>
</div><br></TD>
</TR>
</TABLE>
</TD>
<TD VALIGN="TOP" BGCOLOR="#D2D9D2"><TABLE BORDER="0" CELLSPACING="0" CELLPADDING="0" WIDTH="6"><TR><TD></TD>
</TR>
</TABLE>
</TD>
<TD VALIGN="TOP" WIDTH="100%" BGCOLOR="#D2D9D2"><TABLE BORDER="0" CELLSPACING="0" CELLPADDING="0" BGCOLOR="#FFFFFF" WIDTH="100%" style="border-style: solid; border-width: 1px; border-color: #6E89AE;padding: 10px;;"><TR><TD><TABLE BORDER="0" CELLSPACING="0" CELLPADDING="0" WIDTH="100%"><TR><TD><p class="C">Framebuffer</p>
<p class="D">&nbsp;</p>
<p class="D">Generic framebuffer GUI rainbow</p>
<p class="A">&nbsp;</p>
<p class="A">&nbsp;</p>
<p class="E">Fb.h</p>
<p class="A">&nbsp;</p>
<p class="F"><span class="G">#ifndef</span> _Framebuffer_Fb_h_</p>
<p class="F"><span class="G">#define</span> _Framebuffer_Fb_h_</p>
<p class="F">&nbsp;</p>
<p class="H">#include<span class="I"> </span>&lt;<span class="I">CtrlLib</span>/<span class="I">CtrlLib</span>.<span class="I">h</span>&gt;</p>
<p class="F">&nbsp;</p>
<p class="F">NAMESPACE_UPP</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">class</span> TopWindowFrame <span class="G">:</span> <span class="G">public</span> Ctrl {</p>
<p class="H">public:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">void</span> &nbsp;Layout();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">void</span> &nbsp;Paint(Draw<span class="G">&amp;</span> w);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> Image CursorImage(Point p, dword keyflags);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">void</span> &nbsp;LeftDown(Point p, dword keyflags);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">void</span> &nbsp;LeftHold(Point p, dword keyflags);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">void</span> &nbsp;LeftDouble(Point p, dword keyflags);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">void</span> &nbsp;MouseMove(Point p, dword keyflags);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">void</span> &nbsp;CancelMode();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">void</span> &nbsp;LeftUp(Point p, dword keyflags);</p>
<p class="F">&nbsp;</p>
<p class="H">private:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Point &nbsp;dir;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Point &nbsp;startpos;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Rect &nbsp;&nbsp;startrect;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">bool</span> &nbsp;&nbsp;maximized;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Rect &nbsp;&nbsp;overlapped;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">bool</span> &nbsp;&nbsp;holding;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;TimeCallback hold;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Point GetDragMode(Point p);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Image GetDragImage(Point dragmode);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;StartDrag();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Rect &nbsp;Margins() <span class="G">const</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Rect &nbsp;ComputeClient(Rect r);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;Hold();</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">typedef</span> TopWindowFrame CLASSNAME;</p>
<p class="F">&nbsp;</p>
<p class="H">public:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;String title;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Button close, maximize;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Image &nbsp;icon;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Size &nbsp;&nbsp;minsize;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">bool</span> &nbsp;&nbsp;sizeable;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;TopWindow <span class="G">*</span>window;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> SetTitle(<span class="G">const</span> String<span class="G">&amp;</span> s) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ title <span class="G">=</span> s; Refresh(); }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Rect GetClient() <span class="G">const</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> SetClient(Rect r);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> GripResize();</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;Maximize();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;Overlap();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;ToggleMaximize();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">bool</span> &nbsp;IsMaximized() <span class="G">const</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="G">return</span> maximized; }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;SyncRect();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;TopWindowFrame();</p>
<p class="F">};</p>
<p class="F">&nbsp;</p>
<p class="F">END_UPP_NAMESPACE</p>
<p class="F">&nbsp;</p>
<p class="H">#endif</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="E">After.h</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">class</span> ViewDraw <span class="G">:</span> <span class="G">public</span> SystemDraw {</p>
<p class="H">public:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ViewDraw(Ctrl <span class="G">*</span>ctrl);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">~</span>ViewDraw();</p>
<p class="F">};</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="H">/*</p>
<p class="F"><span class="G">class</span> ViewDraw <span class="G">:</span> <span class="G">public</span> SystemDraw {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Vector<span class="G">&lt;</span>Rect<span class="G">&gt;</span> dummy;</p>
<p class="H">public:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ViewDraw(Ctrl <span class="G">*</span>) <span class="G">:</span> SystemDraw(Ctrl<span class="G">::</span>framebuffer, dummy) { dummy<span class="G">.</span>Add(Rect(10, 10, 100, 100)); }</p>
<p class="F">};</p>
<p class="H">*/</p>
<p class="F"><span class="G">class</span> DHCtrl <span class="G">:</span> Ctrl {};</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#include</span> FRAMEBUFFER_INCLUDE</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="E">Gui.h</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#define</span> GUI_FB</p>
<p class="F">&nbsp;</p>
<p class="F">NAMESPACE_UPP</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">class</span> SystemDraw <span class="G">:</span> <span class="G">public</span> Draw {</p>
<p class="H">public:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> dword GetInfo() <span class="G">const</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> Size &nbsp;GetPageSize() <span class="G">const</span>;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">void</span> BeginOp();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">void</span> EndOp();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">void</span> OffsetOp(Point p);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">bool</span> ClipOp(<span class="G">const</span> Rect<span class="G">&amp;</span> r);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">bool</span> ClipoffOp(<span class="G">const</span> Rect<span class="G">&amp;</span> r);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">bool</span> ExcludeClipOp(<span class="G">const</span> Rect<span class="G">&amp;</span> r);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">bool</span> IntersectClipOp(<span class="G">const</span> Rect<span class="G">&amp;</span> r);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">bool</span> IsPaintingOp(<span class="G">const</span> Rect<span class="G">&amp;</span> r) <span class="G">const</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> Rect GetPaintRect() <span class="G">const</span>;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> DrawRectOp(<span class="G">int</span> x, <span class="G">int</span> y, <span class="G">int</span> cx, <span class="G">int</span> cy, Color color);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">void</span> DrawImageOp(<span class="G">int</span> x, <span class="G">int</span> y, <span class="G">int</span> cx, <span class="G">int</span> cy, <span class="G">const</span> Image<span class="G">&amp;</span> img, <span class="G">const</span> Rect<span class="G">&amp;</span> src, Color color);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">void</span> DrawLineOp(<span class="G">int</span> x1, <span class="G">int</span> y1, <span class="G">int</span> x2, <span class="G">int</span> y2, <span class="G">int</span> width, Color color);</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">void</span> DrawPolyPolylineOp(<span class="G">const</span> Point <span class="G">*</span>vertices, <span class="G">int</span> vertex_count,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">const</span> <span class="G">int</span> <span class="G">*</span>counts, <span class="G">int</span> count_count,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> width, Color color, Color doxor);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">void</span> DrawPolyPolyPolygonOp(<span class="G">const</span> Point <span class="G">*</span>vertices, <span class="G">int</span> vertex_count,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">const</span> <span class="G">int</span> <span class="G">*</span>subpolygon_counts, <span class="G">int</span> scc,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">const</span> <span class="G">int</span> <span class="G">*</span>disjunct_polygon_counts, <span class="G">int</span> dpcc,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Color color, <span class="G">int</span> width, Color outline,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uint64 pattern, Color doxor);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">void</span> DrawArcOp(<span class="G">const</span> Rect<span class="G">&amp;</span> rc, Point start, Point end, <span class="G">int</span> width, Color color);</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">void</span> DrawEllipseOp(<span class="G">const</span> Rect<span class="G">&amp;</span> r, Color color, <span class="G">int</span> pen, Color pencolor);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">void</span> DrawTextOp(<span class="G">int</span> x, <span class="G">int</span> y, <span class="G">int</span> angle, <span class="G">const</span> wchar <span class="G">*</span>text, Font font,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Color ink, <span class="G">int</span> n, <span class="G">const</span> <span class="G">int</span> <span class="G">*</span>dx);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> Size GetNativeDpi() <span class="G">const</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">void</span> BeginNative();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">void</span> EndNative();</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">int</span> &nbsp;GetCloffLevel() <span class="G">const</span>;</p>
<p class="F">&nbsp;</p>
<p class="H">private:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Size &nbsp;pageSize;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Size &nbsp;nativeSize;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Size &nbsp;nativeDpi;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">bool</span> &nbsp;palette<span class="G">:</span>1;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">bool</span> &nbsp;color16<span class="G">:</span>1;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">bool</span> &nbsp;is_mono<span class="G">:</span>1;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> &nbsp;&nbsp;native;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">friend</span> <span class="G">class</span> &nbsp;ImageDraw;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">friend</span> <span class="G">class</span> &nbsp;FontInfo;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">friend</span> <span class="G">class</span> &nbsp;Font;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">friend</span> <span class="G">void</span> StaticExitDraw_();</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Point &nbsp;&nbsp;&nbsp;&nbsp;actual_offset_bak;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">struct</span> Cloff <span class="G">:</span> Moveable<span class="G">&lt;</span>Cloff<span class="G">&gt;</span> {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Point org;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HRGN &nbsp;hrgn;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Rect &nbsp;drawingclip;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;};</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Array<span class="G">&lt;</span>Cloff<span class="G">&gt;</span> cloff;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Rect &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;drawingclip;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;COLORREF &nbsp;lastTextColor;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Color &nbsp;&nbsp;&nbsp;&nbsp;lastColor;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;HBRUSH &nbsp;&nbsp;&nbsp;orgBrush;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;HBRUSH &nbsp;&nbsp;&nbsp;actBrush;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;HPEN &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;orgPen;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;HPEN &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;actPen;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lastPen;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Color &nbsp;&nbsp;&nbsp;&nbsp;lastPenColor;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;&nbsp;Unselect0();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;&nbsp;Cinit();</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;&nbsp;LoadCaps();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;&nbsp;SetPrinterMode();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;&nbsp;Reset();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;&nbsp;SetOrg();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">friend</span> HPALETTE GetQlibPalette();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;&nbsp;DotsMode();</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> <span class="G">void</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InitColors();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">friend</span> <span class="G">class</span> BackDraw;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">friend</span> <span class="G">class</span> ScreenDraw;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">friend</span> <span class="G">class</span> PrintDraw;</p>
<p class="F">&nbsp;</p>
<p class="H">protected:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;dword style;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;HDC &nbsp;&nbsp;handle;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Point actual_offset;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;SystemDraw();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;&nbsp;Init();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;&nbsp;InitClip(<span class="G">const</span> Rect<span class="G">&amp;</span> clip);</p>
<p class="F">&nbsp;</p>
<p class="H">public:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> Rect GetVirtualScreenArea();</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> <span class="G">void</span> SetAutoPalette(<span class="G">bool</span> ap);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> <span class="G">bool</span> AutoPalette();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">bool</span> PaletteMode() &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="G">return</span> palette; }</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> <span class="G">void</span> Flush() &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ GdiFlush(); }</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;COLORREF GetColor(Color color) <span class="G">const</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Point &nbsp;&nbsp;&nbsp;GetOffset() <span class="G">const</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="G">return</span> actual_offset; }</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#ifndef</span> PLATFORM_WINCE</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Point LPtoDP(Point p) <span class="G">const</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Point DPtoLP(Point p) <span class="G">const</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Rect &nbsp;LPtoDP(<span class="G">const</span> Rect<span class="G">&amp;</span> r) <span class="G">const</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Rect &nbsp;DPtoLP(<span class="G">const</span> Rect<span class="G">&amp;</span> r) <span class="G">const</span>;</p>
<p class="H">#endif</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> SetColor(Color color);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> SetDrawPen(<span class="G">int</span> width, Color color);</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Size &nbsp;GetSizeCaps(<span class="G">int</span> i, <span class="G">int</span> j) <span class="G">const</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;HDC &nbsp;&nbsp;BeginGdi();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;EndGdi();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;HDC &nbsp;&nbsp;GetHandle() &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="G">return</span> handle; }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">operator</span> HDC() <span class="G">const</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="G">return</span> handle; }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;Unselect();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;Attach(HDC ahandle) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ handle <span class="G">=</span> ahandle; Init(); }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;HDC &nbsp;&nbsp;Detach() &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ Unselect(); HDC h <span class="G">=</span> handle; handle <span class="G">=</span> NULL; <span class="G">return</span> h; }</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;SystemDraw(HDC hdc);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">~</span>SystemDraw();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">bool</span> CanSetSurface() &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="G">return</span> IsGui() <span class="G">&amp;&amp;</span> IsWinNT(); }</p>
<p class="F">};</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#ifndef</span> PLATFORM_WINCE</p>
<p class="F"><span class="G">class</span> WinMetaFile {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Size size;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;HENHMETAFILE hemf;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;&nbsp;&nbsp;&nbsp;Init();</p>
<p class="F">&nbsp;</p>
<p class="H">public:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Attach(HENHMETAFILE emf);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;HENHMETAFILE Detach();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;&nbsp;&nbsp;&nbsp;Set(<span class="G">const</span> <span class="G">void</span> <span class="G">*</span>data, dword len);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;&nbsp;&nbsp;&nbsp;Set(<span class="G">const</span> String<span class="G">&amp;</span> data) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ Set(<span class="G">~</span>data, data<span class="G">.</span>GetCount()); }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;String &nbsp;&nbsp;Get() <span class="G">const</span>;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">operator</span> <span class="G">bool</span>() <span class="G">const</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="G">return</span> hemf; }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;&nbsp;&nbsp;&nbsp;SetSize(<span class="G">const</span> Size<span class="G">&amp;</span> sz) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ size <span class="G">=</span> sz; }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Size &nbsp;&nbsp;&nbsp;&nbsp;GetSize() <span class="G">const</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="G">return</span> hemf <span class="G">?</span> size <span class="G">:</span> Size(0, 0); }</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;&nbsp;&nbsp;&nbsp;Clear();</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;&nbsp;&nbsp;&nbsp;Paint(Draw<span class="G">&amp;</span> w, <span class="G">const</span> Rect<span class="G">&amp;</span> r) <span class="G">const</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;&nbsp;&nbsp;&nbsp;Paint(Draw<span class="G">&amp;</span> w, <span class="G">int</span> x, <span class="G">int</span> y, <span class="G">int</span> cx, <span class="G">int</span> cy) <span class="G">const</span>;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;&nbsp;&nbsp;&nbsp;Serialize(Stream<span class="G">&amp;</span> s);</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;&nbsp;&nbsp;&nbsp;ReadClipboard();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;&nbsp;&nbsp;&nbsp;WriteClipboard() <span class="G">const</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;&nbsp;&nbsp;&nbsp;Load(<span class="G">const</span> <span class="G">char</span> <span class="G">*</span>file) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ Set(LoadFile(file)); }</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;WinMetaFile() &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ Init(); }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;WinMetaFile(HENHMETAFILE hemf);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;WinMetaFile(HENHMETAFILE hemf, Size sz);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;WinMetaFile(<span class="G">const</span> <span class="G">char</span> <span class="G">*</span>file);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;WinMetaFile(<span class="G">void</span> <span class="G">*</span>data, <span class="G">int</span> len);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;WinMetaFile(<span class="G">const</span> String<span class="G">&amp;</span> data);</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">~</span>WinMetaFile() &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ Clear(); }</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;HENHMETAFILE GetHEMF() <span class="G">const</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="G">return</span> hemf; }</p>
<p class="F">};</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">class</span> WinMetaFileDraw <span class="G">:</span> <span class="G">public</span> SystemDraw {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Size size;</p>
<p class="F">&nbsp;</p>
<p class="H">public:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">bool</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Create(HDC hdc, <span class="G">int</span> cx, <span class="G">int</span> cy, <span class="G">const</span> <span class="G">char</span> <span class="G">*</span>app <span class="G">=</span> NULL, <span class="G">const</span> <span class="G">char</span> <span class="G">*</span>name <span class="G">=</span> NULL, <span class="G">const</span> <span class="G">char</span> <span class="G">*</span>file <span class="G">=</span> NULL);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">bool</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Create(<span class="G">int</span> cx, <span class="G">int</span> cy, <span class="G">const</span> <span class="G">char</span> <span class="G">*</span>app <span class="G">=</span> NULL, <span class="G">const</span> <span class="G">char</span> <span class="G">*</span>name <span class="G">=</span> NULL, <span class="G">const</span> <span class="G">char</span> <span class="G">*</span>file <span class="G">=</span> NULL);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;WinMetaFile Close();</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;WinMetaFileDraw() {}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;WinMetaFileDraw(HDC hdc, <span class="G">int</span> cx, <span class="G">int</span> cy, <span class="G">const</span> <span class="G">char</span> <span class="G">*</span>app <span class="G">=</span> NULL, <span class="G">const</span> <span class="G">char</span> <span class="G">*</span>name <span class="G">=</span> NULL, <span class="G">const</span> <span class="G">char</span> <span class="G">*</span>file <span class="G">=</span> NULL);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;WinMetaFileDraw(<span class="G">int</span> cx, <span class="G">int</span> cy, <span class="G">const</span> <span class="G">char</span> <span class="G">*</span>app <span class="G">=</span> NULL, <span class="G">const</span> <span class="G">char</span> <span class="G">*</span>name <span class="G">=</span> NULL, <span class="G">const</span> <span class="G">char</span> <span class="G">*</span>file <span class="G">=</span> NULL);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">~</span>WinMetaFileDraw();</p>
<p class="F">};</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> DrawWMF(Draw<span class="G">&amp;</span> w, <span class="G">int</span> x, <span class="G">int</span> y, <span class="G">int</span> cx, <span class="G">int</span> cy, <span class="G">const</span> String<span class="G">&amp;</span> wmf);</p>
<p class="F"><span class="G">void</span> DrawWMF(Draw<span class="G">&amp;</span> w, <span class="G">int</span> x, <span class="G">int</span> y, <span class="G">const</span> String<span class="G">&amp;</span> wmf);</p>
<p class="F">Drawing LoadWMF(<span class="G">const</span> <span class="G">char</span> <span class="G">*</span>path, <span class="G">int</span> cx, <span class="G">int</span> cy);</p>
<p class="F">Drawing LoadWMF(<span class="G">const</span> <span class="G">char</span> <span class="G">*</span>path);</p>
<p class="F">&nbsp;</p>
<p class="F">String &nbsp;AsWMF(<span class="G">const</span> Drawing<span class="G">&amp;</span> iw);</p>
<p class="F">&nbsp;</p>
<p class="H">#endif</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">class</span> ScreenDraw <span class="G">:</span> <span class="G">public</span> SystemDraw {</p>
<p class="H">public:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ScreenDraw(<span class="G">bool</span> ic <span class="G">=</span> <span class="G">false</span>);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">~</span>ScreenDraw();</p>
<p class="F">};</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#ifndef</span> PLATFORM_WINCE</p>
<p class="F"><span class="G">class</span> PrintDraw <span class="G">:</span> <span class="G">public</span> SystemDraw {</p>
<p class="H">public:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">void</span> StartPage();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">void</span> EndPage();</p>
<p class="F">&nbsp;</p>
<p class="H">private:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">bool</span> aborted;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;InitPrinter();</p>
<p class="H">public:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;PrintDraw(HDC hdc, <span class="G">const</span> <span class="G">char</span> <span class="G">*</span>jobname);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">~</span>PrintDraw();</p>
<p class="F">};</p>
<p class="H">#endif</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">inline</span> <span class="G">bool</span> &nbsp;&nbsp;&nbsp;&nbsp;BitBlt(HDC ddc, Point d, HDC sdc, <span class="G">const</span> Rect<span class="G">&amp;</span> s, dword rop <span class="G">=</span> SRCCOPY)</p>
<p class="F">{ <span class="G">return</span> BitBlt(ddc, d<span class="G">.</span>x, d<span class="G">.</span>y, s<span class="G">.</span>Width(), s<span class="G">.</span>Height(), sdc, s<span class="G">.</span>left, s<span class="G">.</span>top, rop); }</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">inline</span> <span class="G">bool</span> &nbsp;&nbsp;&nbsp;&nbsp;StretchBlt(HDC ddc, <span class="G">const</span> Rect<span class="G">&amp;</span> r, HDC sdc, <span class="G">const</span> Rect<span class="G">&amp;</span> s, dword rop <span class="G">=</span> SRCCOPY)</p>
<p class="F">{ <span class="G">return</span> StretchBlt(ddc, r<span class="G">.</span>left, r<span class="G">.</span>top, r<span class="G">.</span>Width(), r<span class="G">.</span>Height(), sdc, s<span class="G">.</span>left, s<span class="G">.</span>top, s<span class="G">.</span>Width(), s<span class="G">.</span>Height(), rop); }</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">inline</span> <span class="G">bool</span> &nbsp;&nbsp;&nbsp;&nbsp;PatBlt(HDC dc, <span class="G">const</span> Rect<span class="G">&amp;</span> r, dword rop <span class="G">=</span> PATCOPY)</p>
<p class="F">{ <span class="G">return</span> PatBlt(dc, r<span class="G">.</span>left, r<span class="G">.</span>top, r<span class="G">.</span>Width(), r<span class="G">.</span>Height(), rop); }</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">inline</span> <span class="G">void</span> &nbsp;&nbsp;&nbsp;&nbsp;MoveTo(HDC hdc, Point pt) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ MoveToEx(hdc, pt<span class="G">.</span>x, pt<span class="G">.</span>y, 0); }</p>
<p class="F"><span class="G">inline</span> <span class="G">void</span> &nbsp;&nbsp;&nbsp;&nbsp;LineTo(HDC hdc, Point pt) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ LineTo(hdc, pt<span class="G">.</span>x, pt<span class="G">.</span>y); }</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">inline</span> <span class="G">void</span> &nbsp;&nbsp;&nbsp;&nbsp;DrawLine(HDC hdc, Point p, Point q) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ MoveTo(hdc, p); LineTo(hdc, q); }</p>
<p class="F"><span class="G">inline</span> <span class="G">void</span> &nbsp;&nbsp;&nbsp;&nbsp;DrawLine(HDC hdc, <span class="G">int</span> px, <span class="G">int</span> py, <span class="G">int</span> qx, <span class="G">int</span> qy) { MoveToEx(hdc, px, py, 0); LineTo(hdc, qx, qy); }</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#ifndef</span> PLATFORM_WINCE</p>
<p class="F"><span class="G">inline</span> <span class="G">void</span> &nbsp;&nbsp;&nbsp;&nbsp;DrawArc(HDC hdc, <span class="G">const</span> Rect<span class="G">&amp;</span> rc, Point p, Point q){ Arc(hdc, rc<span class="G">.</span>left, rc<span class="G">.</span>top, rc<span class="G">.</span>right, rc<span class="G">.</span>bottom, p<span class="G">.</span>x, p<span class="G">.</span>y, q<span class="G">.</span>x, q<span class="G">.</span>y); }</p>
<p class="H">#endif</p>
<p class="F"><span class="G">inline</span> <span class="G">void</span> &nbsp;&nbsp;&nbsp;&nbsp;DrawCircle(HDC hdc, <span class="G">int</span> x, <span class="G">int</span> y, <span class="G">int</span> radius) &nbsp;&nbsp;&nbsp;&nbsp;{ Ellipse(hdc, x <span class="G">-</span> radius, y <span class="G">-</span> radius, x <span class="G">+</span> radius <span class="G">+</span> 1, y <span class="G">+</span> radius <span class="G">+</span> 1); }</p>
<p class="F"><span class="G">inline</span> <span class="G">void</span> &nbsp;&nbsp;&nbsp;&nbsp;DrawCircle(HDC hdc, Point centre, <span class="G">int</span> radius) &nbsp;&nbsp;&nbsp;&nbsp;{ DrawCircle(hdc, centre<span class="G">.</span>x, centre<span class="G">.</span>y, radius); }</p>
<p class="F"><span class="G">inline</span> <span class="G">void</span> &nbsp;&nbsp;&nbsp;&nbsp;DrawEllipse(HDC hdc, <span class="G">const</span> Rect<span class="G">&amp;</span> rc) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ Ellipse(hdc, rc<span class="G">.</span>left, rc<span class="G">.</span>top, rc<span class="G">.</span>right, rc<span class="G">.</span>bottom); }</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">inline</span> <span class="G">void</span> &nbsp;&nbsp;&nbsp;&nbsp;DrawRect(HDC hdc, <span class="G">const</span> Rect<span class="G">&amp;</span> rc) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ Rectangle(hdc, rc<span class="G">.</span>left, rc<span class="G">.</span>top, rc<span class="G">.</span>right, rc<span class="G">.</span>bottom); }</p>
<p class="F">&nbsp;</p>
<p class="F">HDC &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ScreenHDC();</p>
<p class="F">HPALETTE GetQlibPalette();</p>
<p class="F">&nbsp;</p>
<p class="F">Image Win32Icon(LPCSTR id, <span class="G">int</span> iconsize <span class="G">=</span> 0);</p>
<p class="F">Image Win32Icon(<span class="G">int</span> id, <span class="G">int</span> iconsize <span class="G">=</span> 0);</p>
<p class="F">Image Win32Cursor(LPCSTR id);</p>
<p class="F">Image Win32Cursor(<span class="G">int</span> id);</p>
<p class="F">HICON IconWin32(<span class="G">const</span> Image<span class="G">&amp;</span> img, <span class="G">bool</span> cursor <span class="G">=</span> <span class="G">false</span>);</p>
<p class="F">Image Win32DllIcon(<span class="G">const</span> <span class="G">char</span> <span class="G">*</span>dll, <span class="G">int</span> ii, <span class="G">bool</span> large);</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">class</span> BackDraw <span class="G">:</span> <span class="G">public</span> SystemDraw {</p>
<p class="H">public:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">bool</span> &nbsp;IsPaintingOp(<span class="G">const</span> Rect<span class="G">&amp;</span> r) <span class="G">const</span>;</p>
<p class="F">&nbsp;</p>
<p class="H">protected:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;HBITMAP hbmpold;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;HBITMAP hbmp;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Size &nbsp;&nbsp;&nbsp;size;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Draw &nbsp;&nbsp;<span class="G">*</span>painting;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Point &nbsp;&nbsp;painting_offset;</p>
<p class="F">&nbsp;</p>
<p class="H">public:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;Put(SystemDraw<span class="G">&amp;</span> w, <span class="G">int</span> x, <span class="G">int</span> y);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;Put(SystemDraw<span class="G">&amp;</span> w, Point p) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ Put(w, p<span class="G">.</span>x, p<span class="G">.</span>y); }</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> Create(SystemDraw<span class="G">&amp;</span> w, <span class="G">int</span> cx, <span class="G">int</span> cy);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> Create(SystemDraw<span class="G">&amp;</span> w, Size sz) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ Create(w, sz<span class="G">.</span>cx, sz<span class="G">.</span>cy); }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> Destroy();</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> SetPaintingDraw(Draw<span class="G">&amp;</span> w, Point off) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ painting <span class="G">=</span> <span class="G">&amp;</span>w; painting_offset <span class="G">=</span> off; }</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;BackDraw();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">~</span>BackDraw();</p>
<p class="F">};</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">class</span> ImageDraw <span class="G">:</span> <span class="G">public</span> SystemDraw {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Size &nbsp;&nbsp;&nbsp;size;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">struct</span> &nbsp;Section {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HDC &nbsp;&nbsp;&nbsp;&nbsp;dc;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HBITMAP hbmp, hbmpOld;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RGBA &nbsp;&nbsp;<span class="G">*</span>pixels;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> Init(<span class="G">int</span> cx, <span class="G">int</span> cy);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">~</span>Section();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;};</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Section &nbsp;&nbsp;&nbsp;&nbsp;rgb;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Section &nbsp;&nbsp;&nbsp;&nbsp;a;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;SystemDraw &nbsp;alpha;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">bool</span> &nbsp;&nbsp;&nbsp;has_alpha;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> Init();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Image Get(<span class="G">bool</span> pm) <span class="G">const</span>;</p>
<p class="F">&nbsp;</p>
<p class="H">public:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Draw<span class="G">&amp;</span> Alpha();</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">operator</span> Image() <span class="G">const</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Image GetStraight() <span class="G">const</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ImageDraw(Size sz);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ImageDraw(<span class="G">int</span> cx, <span class="G">int</span> cy);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">~</span>ImageDraw();</p>
<p class="F">};</p>
<p class="F">&nbsp;</p>
<p class="F">END_UPP_NAMESPACE</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#define</span> GUIPLATFORM_KEYCODES_INCLUDE &quot;Win32Keys<span class="G">.</span>h&quot;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#define</span> GUIPLATFORM_CTRL_TOP_DECLS \</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;HWND &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hwnd; \</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;UDropTarget &nbsp;&nbsp;<span class="G">*</span>dndtgt; \</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#define</span> GUIPLATFORM_CTRL_DECLS_INCLUDE &quot;Win32Ctrl<span class="G">.</span>h&quot;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#define</span> GUIPLATFORM_PASTECLIP_DECLS \</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;UDropTarget <span class="G">*</span>dt; \</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#define</span> GUIPLATFORM_TOPWINDOW_DECLS_INCLUDE &quot;Win32Top<span class="G">.</span>h&quot;</p>
<p class="F">&nbsp;</p>
<p class="F">NAMESPACE_UPP</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">inline</span> <span class="G">unsigned</span> GetHashValue(<span class="G">const</span> HWND<span class="G">&amp;</span> hwnd)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> (<span class="G">unsigned</span>)(intptr_t)hwnd;</p>
<p class="F">}</p>
<p class="F">END_UPP_NAMESPACE</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#ifdef</span> PLATFORM_WIN32</p>
<p class="F"><span class="G">#ifndef</span> PLATFORM_WINCE</p>
<p class="F">&nbsp;</p>
<p class="H">#include<span class="I"> </span>&lt;<span class="I">ShellAPI</span>.<span class="I">h</span>&gt;</p>
<p class="F">&nbsp;</p>
<p class="H">#endif</p>
<p class="H">#endif</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#define</span> GUIPLATFORM_INCLUDE_AFTER &quot;Win32GuiA<span class="G">.</span>h&quot;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="E">Framebuffer.h</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#define</span> GUI_FB</p>
<p class="F">&nbsp;</p>
<p class="H">#include<span class="I"> </span>&lt;<span class="I">Painter</span>/<span class="I">Painter</span>.<span class="I">h</span>&gt;</p>
<p class="F">&nbsp;</p>
<p class="F">NAMESPACE_UPP</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#define</span> IMAGECLASS FBImg</p>
<p class="H">#define<span class="I"> IMAGEFILE </span>&lt;<span class="I">Framebuffer</span>/<span class="I">FB</span>.<span class="I">iml</span>&gt;</p>
<p class="H">#include<span class="I"> </span>&lt;<span class="I">Draw</span>/<span class="I">iml_header</span>.<span class="I">h</span>&gt;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">class</span> SystemDraw <span class="G">:</span> <span class="G">public</span> BufferPainter {</p>
<p class="H">public:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">void</span> BeginOp();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">void</span> EndOp();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">void</span> OffsetOp(Point p);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">bool</span> ClipOp(<span class="G">const</span> Rect<span class="G">&amp;</span> r);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">bool</span> ClipoffOp(<span class="G">const</span> Rect<span class="G">&amp;</span> r);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">bool</span> IsPaintingOp(<span class="G">const</span> Rect<span class="G">&amp;</span> r) <span class="G">const</span>;</p>
<p class="F">&nbsp;</p>
<p class="H">private:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Vector<span class="G">&lt;</span>Point<span class="G">&gt;</span> offset;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> Push();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> Pop();</p>
<p class="F">&nbsp;</p>
<p class="H">public:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Point &nbsp;&nbsp;GetOffset() <span class="G">const</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">bool</span> &nbsp;&nbsp;&nbsp;CanSetSurface() &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="G">return</span> <span class="G">false</span>; }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">bool</span> &nbsp;&nbsp;&nbsp;Clip(<span class="G">const</span> Rect<span class="G">&amp;</span> r) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="G">return</span> Draw<span class="G">::</span>Clip(r); }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">bool</span> &nbsp;&nbsp;&nbsp;Clip(<span class="G">int</span> x, <span class="G">int</span> y, <span class="G">int</span> cx, <span class="G">int</span> cy) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="G">return</span> Draw<span class="G">::</span>Clip(x, y, cx, cy); }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> <span class="G">void</span> Flush() &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{}</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;SystemDraw();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">~</span>SystemDraw();</p>
<p class="F">};</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">struct</span> BackDraw__ <span class="G">:</span> <span class="G">public</span> SystemDraw {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;BackDraw__() <span class="G">:</span> SystemDraw() {}</p>
<p class="F">};</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">class</span> BackDraw <span class="G">:</span> <span class="G">public</span> BackDraw__ { <span class="G">//</span> Dummy only, as we are running in GlobalBackBuffer mode</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Size &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Draw &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">*</span>painting;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Point &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;painting_offset;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ImageBuffer ib;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="H">public:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">bool</span> &nbsp;IsPaintingOp(<span class="G">const</span> Rect<span class="G">&amp;</span> r) <span class="G">const</span>;</p>
<p class="F">&nbsp;</p>
<p class="H">public:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;Put(SystemDraw<span class="G">&amp;</span> w, <span class="G">int</span> x, <span class="G">int</span> y) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;Put(SystemDraw<span class="G">&amp;</span> w, Point p) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ Put(w, p<span class="G">.</span>x, p<span class="G">.</span>y); }</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> Create(SystemDraw<span class="G">&amp;</span> w, <span class="G">int</span> cx, <span class="G">int</span> cy) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> Create(SystemDraw<span class="G">&amp;</span> w, Size sz) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ Create(w, sz<span class="G">.</span>cx, sz<span class="G">.</span>cy); }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> Destroy() &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{}</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> SetPaintingDraw(Draw<span class="G">&amp;</span> w, Point off) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ painting <span class="G">=</span> <span class="G">&amp;</span>w; painting_offset <span class="G">=</span> off; }</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;BackDraw();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">~</span>BackDraw();</p>
<p class="F">};</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">struct</span> ImageDraw__ {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ImageBuffer &nbsp;&nbsp;&nbsp;image;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ImageBuffer &nbsp;&nbsp;&nbsp;alpha;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ImageDraw__(<span class="G">int</span> cx, <span class="G">int</span> cy) <span class="G">:</span> image(cx, cy), alpha(cx, cy) {}</p>
<p class="F">};</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">class</span> ImageDraw <span class="G">:</span> <span class="G">private</span> ImageDraw__, <span class="G">public</span> BufferPainter {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;BufferPainter &nbsp;alpha_painter;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">bool</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;has_alpha;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Image Get(<span class="G">bool</span> pm) <span class="G">const</span>;</p>
<p class="F">&nbsp;</p>
<p class="H">public:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Draw<span class="G">&amp;</span> Alpha();</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">operator</span> Image() <span class="G">const</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="G">return</span> Get(<span class="G">true</span>); }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Image GetStraight() <span class="G">const</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="G">return</span> Get(<span class="G">false</span>); }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ImageDraw(Size sz);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ImageDraw(<span class="G">int</span> cx, <span class="G">int</span> cy);</p>
<p class="F">};</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> DrawDragRect(SystemDraw<span class="G">&amp;</span> w, <span class="G">const</span> Rect<span class="G">&amp;</span> rect1, <span class="G">const</span> Rect<span class="G">&amp;</span> rect2, <span class="G">const</span> Rect<span class="G">&amp;</span> clip, <span class="G">int</span> n,</p>
<p class="F"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Color color, uint64 pattern);</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">class</span> TopWindowFrame;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#define</span> GUIPLATFORM_CTRL_TOP_DECLS &nbsp;&nbsp;Ctrl <span class="G">*</span>owner_window;</p>
<p class="F">&nbsp;</p>
<p class="H">#define<span class="I"> GUIPLATFORM_CTRL_DECLS_INCLUDE </span>&lt;<span class="I">Framebuffer</span>/<span class="I">Ctrl</span>.<span class="I">h</span>&gt;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#define</span> GUIPLATFORM_PASTECLIP_DECLS \</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">bool</span> dnd; \</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">friend</span> <span class="G">struct</span> DnDLoop; \</p>
<p class="F">&nbsp;</p>
<p class="H">#define<span class="I"> GUIPLATFORM_TOPWINDOW_DECLS_INCLUDE </span>&lt;<span class="I">Framebuffer</span>/<span class="I">Top</span>.<span class="I">h</span>&gt;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">//</span> to be implemented by <span class="G">final</span> FB {</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">bool</span> FBIsWaitingEvent();</p>
<p class="F"><span class="G">bool</span> FBProcessEvent(<span class="G">bool</span> <span class="G">*</span>quit);</p>
<p class="F"><span class="G">void</span> FBSleep(<span class="G">int</span> ms);</p>
<p class="F"><span class="G">void</span> FBInitUpdate();</p>
<p class="F"><span class="G">void</span> FBUpdate(<span class="G">const</span> Rect<span class="G">&amp;</span> area);</p>
<p class="F"><span class="G">void</span> FBFlush();</p>
<p class="F"><span class="G">void</span> FBQuitSession();</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">//</span> }</p>
<p class="F">&nbsp;</p>
<p class="H">class<span class="I"> PrinterJob { </span>//<span class="I"> Dummy only</span>...</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;NilDraw &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nil;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Vector<span class="G">&lt;int&gt;</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pages;</p>
<p class="F">&nbsp;</p>
<p class="H">public:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Draw<span class="G">&amp;</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GetDraw() &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="G">return</span> nil; }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">operator</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Draw<span class="G">&amp;</span>() &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="G">return</span> GetDraw(); }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">const</span> Vector<span class="G">&lt;int&gt;&amp;</span> &nbsp;GetPages() <span class="G">const</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="G">return</span> pages; }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">operator[]</span>(<span class="G">int</span> i) <span class="G">const</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="G">return</span> 0; }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GetPageCount() <span class="G">const</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="G">return</span> 0; }</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">bool</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Execute() &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="G">return</span> <span class="G">false</span>; }</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;PrinterJob<span class="G">&amp;</span> Landscape(<span class="G">bool</span> b <span class="G">=</span> <span class="G">true</span>) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="G">return</span> <span class="G">*this</span>; }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;PrinterJob<span class="G">&amp;</span> MinMaxPage(<span class="G">int</span> minpage, <span class="G">int</span> maxpage) &nbsp;&nbsp;&nbsp;{ <span class="G">return</span> <span class="G">*this</span>; }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;PrinterJob<span class="G">&amp;</span> PageCount(<span class="G">int</span> n) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="G">return</span> <span class="G">*this</span>; }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;PrinterJob<span class="G">&amp;</span> CurrentPage(<span class="G">int</span> currentpage) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="G">return</span> <span class="G">*this</span>; }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;PrinterJob<span class="G">&amp;</span> Name(<span class="G">const</span> <span class="G">char</span> <span class="G">*</span>_name) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="G">return</span> <span class="G">*this</span>; }</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;PrinterJob(<span class="G">const</span> <span class="G">char</span> <span class="G">*</span>name <span class="G">=</span> NULL) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">~</span>PrinterJob() &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{}</p>
<p class="F">};</p>
<p class="F">&nbsp;</p>
<p class="F">END_UPP_NAMESPACE</p>
<p class="F">&nbsp;</p>
<p class="H">#define<span class="I"> GUIPLATFORM_INCLUDE_AFTER </span>&lt;<span class="I">Framebuffer</span>/<span class="I">After</span>.<span class="I">h</span>&gt;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="E">Top.h</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">//</span>$ <span class="G">class</span> TopWindow {</p>
<p class="H">public:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">void</span> &nbsp;&nbsp;State(<span class="G">int</span> reason);</p>
<p class="F">&nbsp;</p>
<p class="H">private:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;TopWindowFrame <span class="G">*</span>frame;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> SyncRect();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> SyncFrameRect(<span class="G">const</span> Rect<span class="G">&amp;</span> r);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> DestroyFrame();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">friend</span> <span class="G">class</span> Ctrl;</p>
<p class="F">&nbsp;</p>
<p class="H">public:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> GripResize();</p>
<p class="F"><span class="G">//</span>$ };</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="E">Ctrl.h</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">//</span>$ <span class="G">class</span> Ctrl {</p>
<p class="H">private:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> Ptr<span class="G">&lt;</span>Ctrl<span class="G">&gt;</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;desktop;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> Vector<span class="G">&lt;</span>Ctrl <span class="G">*&gt;</span> topctrl;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> ImageBuffer &nbsp;&nbsp;&nbsp;framebuffer;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> Vector<span class="G">&lt;</span>Rect<span class="G">&gt;</span> &nbsp;&nbsp;invalid, update;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> Point fbCursorPos;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> Image fbCursorImage;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> Point fbCursorBakPos;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> Image fbCursorBak;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> Rect &nbsp;fbCaretRect;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> Image fbCaretBak;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> <span class="G">int</span> &nbsp;&nbsp;fbCaretTm;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> <span class="G">int</span> &nbsp;&nbsp;renderingMode;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> <span class="G">bool</span> &nbsp;fbEndSession;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> int64 fbEventLoop;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> int64 fbEndSessionLoop;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> Image GetBak(Rect<span class="G">&amp;</span> tr);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> <span class="G">void</span> RemoveCursor();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> <span class="G">void</span> RemoveCaret();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> <span class="G">void</span> CursorSync();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> FindTopCtrl() <span class="G">const</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> Rect GetClipBound(<span class="G">const</span> Vector<span class="G">&lt;</span>Rect<span class="G">&gt;&amp;</span> inv, <span class="G">const</span> Rect<span class="G">&amp;</span> r);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> <span class="G">void</span> DoPaint();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> <span class="G">void</span> DoUpdate();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> <span class="G">void</span> SyncTopWindows();</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> <span class="G">void</span> AddInvalid(<span class="G">const</span> Rect<span class="G">&amp;</span> rect);</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> DestroyWnd();</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> NewTop() &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ top <span class="G">=</span> <span class="G">new</span> Top; top<span class="G">-&gt;</span>owner_window <span class="G">=</span> NULL; }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> PutForeground();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> <span class="G">void</span> MouseEventFB(Ptr<span class="G">&lt;</span>Ctrl<span class="G">&gt;</span> t, <span class="G">int</span> event, Point p, <span class="G">int</span> zdelta);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Vector<span class="G">&lt;</span>Rect<span class="G">&gt;</span> GetPaintRects();</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> <span class="G">void</span> DrawLine(<span class="G">const</span> Vector<span class="G">&lt;</span>Rect<span class="G">&gt;&amp;</span> clip, <span class="G">int</span> x, <span class="G">int</span> y, <span class="G">int</span> cx, <span class="G">int</span> cy, <span class="G">bool</span> horz,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">const</span> byte <span class="G">*</span>pattern, <span class="G">int</span> animation);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> <span class="G">void</span> DragRectDraw0(<span class="G">const</span> Vector<span class="G">&lt;</span>Rect<span class="G">&gt;&amp;</span> clip, <span class="G">const</span> Rect<span class="G">&amp;</span> rect, <span class="G">int</span> n,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">const</span> byte <span class="G">*</span>pattern, <span class="G">int</span> animation);</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">friend</span> <span class="G">struct</span> PaintProxy__;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">friend</span> <span class="G">class</span> TopWindowFrame;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">friend</span> <span class="G">class</span> SystemDraw;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">friend</span> <span class="G">struct</span> DnDLoop;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;SetOpen(<span class="G">bool</span> b) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ isopen <span class="G">=</span> b; }</p>
<p class="F">&nbsp;</p>
<p class="H">protected:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> <span class="G">int</span> PaintLock;</p>
<p class="F">&nbsp;</p>
<p class="H">public:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> <span class="G">void</span> DoMouseFB(<span class="G">int</span> event, Point p, <span class="G">int</span> zdelta <span class="G">=</span> 0);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> <span class="G">bool</span> DoKeyFB(dword key, <span class="G">int</span> cnt);</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> <span class="G">void</span> InitFB();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> <span class="G">void</span> ExitFB();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> <span class="G">void</span> EndSession();</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> <span class="G">void</span> &nbsp;SetDesktop(Ctrl<span class="G">&amp;</span> q);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> Ctrl <span class="G">*</span>GetDesktop() &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="G">return</span> desktop; }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> <span class="G">void</span> &nbsp;SetFramebufferSize(Size sz);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> <span class="G">const</span> ImageBuffer<span class="G">&amp;</span> GetFrameBuffer() { <span class="G">return</span> framebuffer; }</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> <span class="G">void</span> SetRenderingMode(<span class="G">int</span> mode);</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> <span class="G">void</span> AddUpdate(<span class="G">const</span> Rect<span class="G">&amp;</span> rect);</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> DragRectDraw(<span class="G">const</span> Rect<span class="G">&amp;</span> rect1, <span class="G">const</span> Rect<span class="G">&amp;</span> rect2, <span class="G">const</span> Rect<span class="G">&amp;</span> clip, <span class="G">int</span> n,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Color color, <span class="G">int</span> type, <span class="G">int</span> animation);</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> Ctrl <span class="G">*</span>FindMouseTopCtrl();</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> <span class="G">bool</span> FullWindowDrag;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">enum</span> { DRAWDRAGRECT_SCREEN <span class="G">=</span> 0x8000 };</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">//</span>$ };</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="E">Draw.cpp</p>
<p class="F">&nbsp;</p>
<p class="H">#include<span class="I"> </span>&lt;<span class="I">CtrlCore</span>/<span class="I">CtrlCore</span>.<span class="I">h</span>&gt;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#ifdef</span> GUI_FB</p>
<p class="F">&nbsp;</p>
<p class="F">NAMESPACE_UPP</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#define</span> LLOG(x) <span class="G">//</span> LOG(x)</p>
<p class="F"><span class="G">#define</span> LTIMING(x) <span class="G">//</span> RTIMING(x)</p>
<p class="F">&nbsp;</p>
<p class="F">SystemDraw<span class="G">::</span>SystemDraw()</p>
<p class="F"><span class="G">:</span>&nbsp;&nbsp;&nbsp;&nbsp;BufferPainter(Ctrl<span class="G">::</span>framebuffer, Ctrl<span class="G">::</span>renderingMode)</p>
<p class="F">{</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">SystemDraw<span class="G">::~</span>SystemDraw()</p>
<p class="F">{</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> SystemDraw<span class="G">::</span>Push()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Point p <span class="G">=</span> GetOffset();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;offset<span class="G">.</span>Add(p);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;BufferPainter<span class="G">::</span>BeginOp();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> SystemDraw<span class="G">::</span>Pop()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(offset<span class="G">.</span>GetCount())</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;offset<span class="G">.</span>Drop();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;BufferPainter<span class="G">::</span>EndOp();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="H"><span class="I">Point SystemDraw</span>::<span class="I">GetOffset() </span>const</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> offset<span class="G">.</span>GetCount() <span class="G">?</span> offset<span class="G">.</span>Top() <span class="G">:</span> Point(0, 0);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> SystemDraw<span class="G">::</span>BeginOp()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Push();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> SystemDraw<span class="G">::</span>EndOp()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Pop();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> SystemDraw<span class="G">::</span>OffsetOp(Point p)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Push();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;offset<span class="G">.</span>Top() <span class="G">+=</span> p;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Translate(p<span class="G">.</span>x, p<span class="G">.</span>y);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">bool</span> SystemDraw<span class="G">::</span>ClipOp(<span class="G">const</span> Rect<span class="G">&amp;</span> r)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Push();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;RectPath(r);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Painter<span class="G">::</span>Clip();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> <span class="G">true</span>;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">bool</span> SystemDraw<span class="G">::</span>ClipoffOp(<span class="G">const</span> Rect<span class="G">&amp;</span> r)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Push();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;offset<span class="G">.</span>Top() <span class="G">+=</span> r<span class="G">.</span>TopLeft();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;RectPath(r);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Painter<span class="G">::</span>Clip();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Translate(r<span class="G">.</span>left, r<span class="G">.</span>top);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> <span class="G">true</span>;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="H">bool<span class="I"> SystemDraw</span>::<span class="I">IsPaintingOp(</span>const<span class="I"> Rect</span>&amp;<span class="I"> r) </span>const</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Rect rr <span class="G">=</span> r <span class="G">+</span> GetOffset();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> 0; i <span class="G">&lt;</span> Ctrl<span class="G">::</span>invalid<span class="G">.</span>GetCount(); i<span class="G">++</span>)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(Ctrl<span class="G">::</span>invalid<span class="G">[</span>i<span class="G">].</span>Intersects(rr))</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> <span class="G">true</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> <span class="G">true</span>;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">/*</span>Rect SystemDraw<span class="G">::</span>GetVirtualScreenArea()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="H"><span class="I">}</span>*/</p>
<p class="F">&nbsp;</p>
<p class="H">/*</p>
<p class="F"><span class="G">void</span> BackDraw<span class="G">::</span>Destroy()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> BackDraw<span class="G">::</span>Create(SystemDraw<span class="G">&amp;</span> w, <span class="G">int</span> cx, <span class="G">int</span> cy) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> BackDraw<span class="G">::</span>Put(SystemDraw<span class="G">&amp;</span> w, <span class="G">int</span> x, <span class="G">int</span> y) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">}</p>
<p class="H">*/</p>
<p class="F">&nbsp;</p>
<p class="F">END_UPP_NAMESPACE</p>
<p class="F">&nbsp;</p>
<p class="H">#endif</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="E">Wnd.cpp</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#include</span> &quot;Fb<span class="G">.</span>h&quot;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#ifdef</span> GUI_FB</p>
<p class="F">&nbsp;</p>
<p class="F">NAMESPACE_UPP</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#define</span> LLOG(x) &nbsp;&nbsp;<span class="G">//</span>DLOG(x)</p>
<p class="F"><span class="G">#define</span> LDUMP(x) &nbsp;<span class="G">//</span>DDUMP(x)</p>
<p class="F"><span class="G">#define</span> LDUMPC(x) <span class="G">//</span>DDUMPC(x)</p>
<p class="F">&nbsp;</p>
<p class="F">ImageBuffer &nbsp;&nbsp;&nbsp;Ctrl<span class="G">::</span>framebuffer;</p>
<p class="F">Vector<span class="G">&lt;</span>Rect<span class="G">&gt;</span> &nbsp;&nbsp;Ctrl<span class="G">::</span>invalid;</p>
<p class="F">Vector<span class="G">&lt;</span>Rect<span class="G">&gt;</span> &nbsp;&nbsp;Ctrl<span class="G">::</span>update;</p>
<p class="F">&nbsp;</p>
<p class="F">Ptr<span class="G">&lt;</span>Ctrl<span class="G">&gt;</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ctrl<span class="G">::</span>desktop;</p>
<p class="F">Vector<span class="G">&lt;</span>Ctrl <span class="G">*&gt;</span> Ctrl<span class="G">::</span>topctrl;</p>
<p class="F">&nbsp;</p>
<p class="F">Point &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ctrl<span class="G">::</span>fbCursorPos <span class="G">=</span> Null;</p>
<p class="F">Image &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ctrl<span class="G">::</span>fbCursorImage;</p>
<p class="F">Point &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ctrl<span class="G">::</span>fbCursorBakPos <span class="G">=</span> Null;</p>
<p class="F">Image &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ctrl<span class="G">::</span>fbCursorBak;</p>
<p class="F">Rect &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ctrl<span class="G">::</span>fbCaretRect;</p>
<p class="F">Image &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ctrl<span class="G">::</span>fbCaretBak;</p>
<p class="F"><span class="G">int</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ctrl<span class="G">::</span>fbCaretTm;</p>
<p class="F"><span class="G">int</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ctrl<span class="G">::</span>renderingMode <span class="G">=</span> MODE_ANTIALIASED;</p>
<p class="F"><span class="G">bool</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ctrl<span class="G">::</span>fbEndSession;</p>
<p class="F"><span class="G">bool</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ctrl<span class="G">::</span>FullWindowDrag;</p>
<p class="F"><span class="G">int</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ctrl<span class="G">::</span>PaintLock;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>SetDesktop(Ctrl<span class="G">&amp;</span> q)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;desktop <span class="G">=</span> <span class="G">&amp;</span>q;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;desktop<span class="G">-&gt;</span>SetRect(framebuffer<span class="G">.</span>GetSize());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;desktop<span class="G">-&gt;</span>SetOpen(<span class="G">true</span>);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;desktop<span class="G">-&gt;</span>NewTop();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;invalid<span class="G">.</span>Add(framebuffer<span class="G">.</span>GetSize());</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>SetRenderingMode(<span class="G">int</span> mode)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;renderingMode <span class="G">=</span> mode;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;invalid<span class="G">.</span>Add(framebuffer<span class="G">.</span>GetSize());</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>InitFB()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Ctrl<span class="G">::</span>GlobalBackBuffer();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Ctrl<span class="G">::</span>InitTimer();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;framebuffer<span class="G">.</span>Create(1, 1);</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#ifdef</span> PLATFORM_POSIX</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;SetStdFont(ScreenSans(12)); <span class="G">//</span>FIXME general handling</p>
<p class="H">#endif</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ChStdSkin();</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> StaticRect x;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;x<span class="G">.</span>Color(Cyan());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;SetDesktop(x);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>EndSession()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;LLOG(&quot;Ctrl<span class="G">::</span>EndSession&quot;);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;fbEndSession <span class="G">=</span> <span class="G">true</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;EndSessionLoopNo <span class="G">=</span> EventLoopNo;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>ExitFB()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;TopWindow<span class="G">::</span>ShutdownWindows();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Ctrl<span class="G">::</span>CloseTopCtrls();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(fbEndSession)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FBQuitSession();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>SetFramebufferSize(Size sz)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;framebuffer<span class="G">.</span>Create(sz);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(desktop)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;desktop<span class="G">-&gt;</span>SetRect(sz);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;invalid<span class="G">.</span>Add(sz);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;SyncTopWindows();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="H">int<span class="I"> Ctrl</span>::<span class="I">FindTopCtrl() </span>const</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> 0; i <span class="G">&lt;</span> topctrl<span class="G">.</span>GetCount(); i<span class="G">++</span>)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">this</span> <span class="G">==</span> topctrl<span class="G">[</span>i<span class="G">]</span>)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> i;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> <span class="G">-</span>1;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">bool</span> Ctrl<span class="G">::</span>IsAlphaSupported()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> <span class="G">false</span>;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">bool</span> Ctrl<span class="G">::</span>IsCompositedGui()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> <span class="G">false</span>;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">Vector<span class="G">&lt;</span>Ctrl <span class="G">*&gt;</span> Ctrl<span class="G">::</span>GetTopCtrls()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Vector<span class="G">&lt;</span>Ctrl <span class="G">*&gt;</span> ctrl;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(desktop)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ctrl<span class="G">.</span>Add(desktop);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> 0; i <span class="G">&lt;</span> topctrl<span class="G">.</span>GetCount(); i<span class="G">++</span>)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">!dynamic_cast&lt;</span>TopWindowFrame <span class="G">*&gt;</span>(topctrl<span class="G">[</span>i<span class="G">]</span>))</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ctrl<span class="G">.</span>Add(topctrl<span class="G">[</span>i<span class="G">]</span>);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> ctrl;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">Ctrl <span class="G">*</span>Ctrl<span class="G">::</span>GetOwner()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> q <span class="G">=</span> FindTopCtrl();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(q <span class="G">&gt;</span> 0 <span class="G">&amp;&amp;</span> topctrl<span class="G">[</span>q<span class="G">]-&gt;</span>top) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ctrl <span class="G">*</span>x <span class="G">=</span> topctrl<span class="G">[</span>q<span class="G">]-&gt;</span>top<span class="G">-&gt;</span>owner_window;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LDUMP(Upp<span class="G">::</span>Name(x));</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> <span class="G">dynamic_cast&lt;</span>TopWindowFrame <span class="G">*&gt;</span>(x) <span class="G">?</span> x<span class="G">-&gt;</span>GetOwner() <span class="G">:</span> x;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> NULL;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">Ctrl <span class="G">*</span>Ctrl<span class="G">::</span>GetActiveCtrl()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> focusCtrl <span class="G">?</span> focusCtrl<span class="G">-&gt;</span>GetTopCtrl() <span class="G">:</span> NULL;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">//</span> Vector<span class="G">&lt;</span>Callback<span class="G">&gt;</span> Ctrl<span class="G">::</span>hotkey;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">int</span> Ctrl<span class="G">::</span>RegisterSystemHotKey(dword key, Callback cb)</p>
<p class="F">{</p>
<p class="F"><span class="G">/*</span>&nbsp;&nbsp;&nbsp;&nbsp;ASSERT(key <span class="G">&gt;=</span> K_DELTA);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> q <span class="G">=</span> hotkey<span class="G">.</span>GetCount();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> 0; i <span class="G">&lt;</span> hotkey<span class="G">.</span>GetCount(); i<span class="G">++</span>)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">!</span>hotkey<span class="G">[</span>i<span class="G">]</span>) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;q <span class="G">=</span> i;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">break</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;hotkey<span class="G">.</span>At(q) <span class="G">=</span> cb;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;dword mod <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(key <span class="G">&amp;</span> K_ALT)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mod <span class="G">|=</span> MOD_ALT;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(key <span class="G">&amp;</span> K_SHIFT)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mod <span class="G">|=</span> MOD_SHIFT;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(key <span class="G">&amp;</span> K_CTRL)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mod <span class="G">|=</span> MOD_CONTROL;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;</span>return<span class="I"> RegisterHotKey(NULL, q, mod, key </span>&amp;<span class="I"> 0xffff) </span>?<span class="I"> q </span>:<span class="I"> </span>-<span class="I">1;</span>*/</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> <span class="G">-</span>1;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>UnregisterSystemHotKey(<span class="G">int</span> id)</p>
<p class="F">{</p>
<p class="F"><span class="G">/*</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(id <span class="G">&gt;=</span> 0 <span class="G">&amp;&amp;</span> id <span class="G">&lt;</span> hotkey<span class="G">.</span>GetCount()) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UnregisterHotKey(NULL, id);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hotkey<span class="G">[</span>id<span class="G">].</span>Clear();</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;}</span>*/</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">bool</span> Ctrl<span class="G">::</span>IsWaitingEvent()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> FBIsWaitingEvent();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>AddUpdate(<span class="G">const</span> Rect<span class="G">&amp;</span> rect)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;LLOG(&quot;@AddUpdate &quot; <span class="G">&lt;&lt;</span> rect);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;AddRefreshRect(update, rect);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>AddInvalid(<span class="G">const</span> Rect<span class="G">&amp;</span> rect)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;LLOG(&quot;@AddInvalid &quot; <span class="G">&lt;&lt;</span> rect);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;AddRefreshRect(invalid, rect);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>SyncTopWindows()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> 0; i <span class="G">&lt;</span> topctrl<span class="G">.</span>GetCount(); i<span class="G">++</span>) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TopWindow <span class="G">*</span>w <span class="G">=</span> <span class="G">dynamic_cast&lt;</span>TopWindow <span class="G">*&gt;</span>(topctrl<span class="G">[</span>i<span class="G">]</span>);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(w)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w<span class="G">-&gt;</span>SyncRect();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">bool</span> Ctrl<span class="G">::</span>ProcessEvent(<span class="G">bool</span> <span class="G">*</span>quit)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;LLOG(&quot;@ ProcessEvent&quot;);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT(IsMainThread());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">!</span>GetMouseLeft() <span class="G">&amp;&amp;</span> <span class="G">!</span>GetMouseRight() <span class="G">&amp;&amp;</span> <span class="G">!</span>GetMouseMiddle())</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReleaseCtrlCapture();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(FBProcessEvent(quit)) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LLOG(&quot;FBProcesEvent returned <span class="G">true</span>&quot;);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SyncTopWindows();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DefferedFocusSync();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SyncCaret();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> <span class="G">true</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> <span class="G">false</span>;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">Rect Ctrl<span class="G">::</span>GetClipBound(<span class="G">const</span> Vector<span class="G">&lt;</span>Rect<span class="G">&gt;&amp;</span> inv, <span class="G">const</span> Rect<span class="G">&amp;</span> r)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Rect ri <span class="G">=</span> Null;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> j <span class="G">=</span> 0; j <span class="G">&lt;</span> inv<span class="G">.</span>GetCount(); j<span class="G">++</span>) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Rect rr <span class="G">=</span> inv<span class="G">[</span>j<span class="G">]</span> <span class="G">&amp;</span> r;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">!</span>rr<span class="G">.</span>IsEmpty())</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ri <span class="G">=</span> IsNull(ri) <span class="G">?</span> rr <span class="G">:</span> rr <span class="G">|</span> ri;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> ri;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F">ViewDraw<span class="G">::</span>ViewDraw(Ctrl <span class="G">*</span>ctrl)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(Ctrl<span class="G">::</span>invalid<span class="G">.</span>GetCount())</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ctrl<span class="G">::</span>DoPaint();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Ctrl<span class="G">::</span>invalid<span class="G">.</span>Clear();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Ctrl<span class="G">::</span>RemoveCursor();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Ctrl<span class="G">::</span>RemoveCaret();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Rect r <span class="G">=</span> ctrl<span class="G">-&gt;</span>GetScreenView();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Ctrl<span class="G">::</span>invalid<span class="G">.</span>Add(r);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Ctrl<span class="G">::</span>AddUpdate(r);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> max(ctrl<span class="G">-&gt;</span>GetTopCtrl()<span class="G">-&gt;</span>FindTopCtrl() <span class="G">+</span> 1, 0); i <span class="G">&lt;</span> Ctrl<span class="G">::</span>topctrl<span class="G">.</span>GetCount(); i<span class="G">++</span>) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Rect rr <span class="G">=</span> Ctrl<span class="G">::</span>topctrl<span class="G">[</span>i<span class="G">]-&gt;</span>GetScreenRect();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ExcludeClip(rr);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subtract(Ctrl<span class="G">::</span>invalid, rr);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Offset(r<span class="G">.</span>TopLeft());</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">ViewDraw<span class="G">::~</span>ViewDraw()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;FBInitUpdate();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Ctrl<span class="G">::</span>DoUpdate();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;FBFlush();</p>
<p class="F"><span class="G">//</span>&nbsp;&nbsp;&nbsp;&nbsp;Ctrl<span class="G">::</span>invalid<span class="G">.</span>Clear();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>DoUpdate()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;LLOG(&quot;DoUpdate&quot;);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;invalid<span class="G">.</span>Clear();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;CursorSync();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;LDUMPC(update);</p>
<p class="F"><span class="G">#if</span> 0</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;FBUpdate(framebuffer<span class="G">.</span>GetSize());</p>
<p class="H">#else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> 0; i <span class="G">&lt;</span> update<span class="G">.</span>GetCount(); i<span class="G">++</span>) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LDUMP(update<span class="G">[</span>i<span class="G">]</span>);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FBUpdate(update<span class="G">[</span>i<span class="G">]</span>);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H">#endif</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;update<span class="G">.</span>Clear();</p>
<p class="F"><span class="G">//</span>&nbsp;&nbsp;&nbsp;&nbsp;Sleep(1000);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">Vector<span class="G">&lt;</span>Rect<span class="G">&gt;</span> Ctrl<span class="G">::</span>GetPaintRects()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Vector<span class="G">&lt;</span>Rect<span class="G">&gt;</span> r;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> q <span class="G">=</span> FindTopCtrl();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;r<span class="G">.</span>Add(GetScreenRect());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> max(FindTopCtrl() <span class="G">+</span> 1, 0); i <span class="G">&lt;</span> topctrl<span class="G">.</span>GetCount(); i<span class="G">++</span>)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subtract(r, topctrl<span class="G">[</span>i<span class="G">]-&gt;</span>GetScreenRect());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> r;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> DDRect(RGBA <span class="G">*</span>t, <span class="G">int</span> dir, <span class="G">const</span> byte <span class="G">*</span>pattern, <span class="G">int</span> pos, <span class="G">int</span> count)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">while</span>(count<span class="G">--</span> <span class="G">&gt;</span> 0) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;byte p <span class="G">=</span> pattern<span class="G">[</span>7 <span class="G">&amp;</span> pos<span class="G">++]</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t<span class="G">-&gt;</span>r <span class="G">^=</span> p;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t<span class="G">-&gt;</span>g <span class="G">^=</span> p;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t<span class="G">-&gt;</span>b <span class="G">^=</span> p;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t <span class="G">+=</span> dir;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>DrawLine(<span class="G">const</span> Vector<span class="G">&lt;</span>Rect<span class="G">&gt;&amp;</span> clip, <span class="G">int</span> x, <span class="G">int</span> y, <span class="G">int</span> cx, <span class="G">int</span> cy, <span class="G">bool</span> horz, <span class="G">const</span> byte <span class="G">*</span>pattern, <span class="G">int</span> animation)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(cx <span class="G">&lt;=</span> 0 <span class="G">||</span> cy <span class="G">&lt;=</span> 0)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Vector<span class="G">&lt;</span>Rect<span class="G">&gt;</span> rr <span class="G">=</span> Intersection(clip, RectC(x, y, cx, cy));</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> 0; i <span class="G">&lt;</span> rr<span class="G">.</span>GetCount(); i<span class="G">++</span>) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Rect r <span class="G">=</span> rr<span class="G">[</span>i<span class="G">]</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AddUpdate(r);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(horz)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> y <span class="G">=</span> r<span class="G">.</span>top; y <span class="G">&lt;</span> r<span class="G">.</span>bottom; y<span class="G">++</span>)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DDRect(framebuffer<span class="G">[</span>y<span class="G">]</span> <span class="G">+</span> r<span class="G">.</span>left, 1, pattern, r<span class="G">.</span>left <span class="G">+</span> animation, r<span class="G">.</span>GetWidth());</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> x <span class="G">=</span> r<span class="G">.</span>left; x <span class="G">&lt;</span> r<span class="G">.</span>right; x<span class="G">++</span>)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DDRect(framebuffer<span class="G">[</span>r<span class="G">.</span>top<span class="G">]</span> <span class="G">+</span> x, framebuffer<span class="G">.</span>GetWidth(), pattern, r<span class="G">.</span>top <span class="G">+</span> animation, r<span class="G">.</span>GetHeight());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>DragRectDraw0(<span class="G">const</span> Vector<span class="G">&lt;</span>Rect<span class="G">&gt;&amp;</span> clip, <span class="G">const</span> Rect<span class="G">&amp;</span> rect, <span class="G">int</span> n, <span class="G">const</span> byte <span class="G">*</span>pattern, <span class="G">int</span> animation)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> hn <span class="G">=</span> min(rect<span class="G">.</span>GetHeight(), n);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> vn <span class="G">=</span> min(rect<span class="G">.</span>GetWidth(), n);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;DrawLine(clip, rect<span class="G">.</span>left, rect<span class="G">.</span>top, rect<span class="G">.</span>GetWidth(), hn, <span class="G">true</span>, pattern, animation);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;DrawLine(clip, rect<span class="G">.</span>left, rect<span class="G">.</span>top <span class="G">+</span> hn, vn, rect<span class="G">.</span>GetHeight() <span class="G">-</span> hn, <span class="G">false</span>, pattern, animation);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;DrawLine(clip, rect<span class="G">.</span>right <span class="G">-</span> vn, rect<span class="G">.</span>top <span class="G">+</span> hn, vn, rect<span class="G">.</span>GetHeight() <span class="G">-</span> hn, <span class="G">false</span>, pattern, animation);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;DrawLine(clip, rect<span class="G">.</span>left <span class="G">+</span> vn, rect<span class="G">.</span>bottom <span class="G">-</span> hn, rect<span class="G">.</span>GetWidth() <span class="G">-</span> 2 <span class="G">*</span> vn, hn, <span class="G">true</span>, pattern, animation);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>DragRectDraw(<span class="G">const</span> Rect<span class="G">&amp;</span> rect1, <span class="G">const</span> Rect<span class="G">&amp;</span> rect2, <span class="G">const</span> Rect<span class="G">&amp;</span> clip, <span class="G">int</span> n,</p>
<p class="F"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Color color, <span class="G">int</span> type, <span class="G">int</span> animation)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> byte solid<span class="G">[]</span> <span class="G">=</span> &nbsp;{ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff };</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> byte normal<span class="G">[]</span> <span class="G">=</span> { 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00 };</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> byte dashed<span class="G">[]</span> <span class="G">=</span> { 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00 };</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Point p <span class="G">=</span> GetScreenView()<span class="G">.</span>TopLeft();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Vector<span class="G">&lt;</span>Rect<span class="G">&gt;</span> pr;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(type <span class="G">&amp;</span> DRAWDRAGRECT_SCREEN) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr<span class="G">.</span>Add(Rect(framebuffer<span class="G">.</span>GetSize()));</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type <span class="G">&amp;=</span> <span class="G">~</span>DRAWDRAGRECT_SCREEN;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p <span class="G">=</span> Point(0, 0);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr <span class="G">=</span> Intersection(GetPaintRects(), clip<span class="G">.</span>Offseted(p));</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;</span>const<span class="I"> byte </span>*<span class="I">pattern </span>=<span class="I"> type </span>==<span class="I"> DRAWDRAGRECT_DASHED </span>?<span class="I"> dashed </span>:</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type <span class="G">==</span> DRAWDRAGRECT_NORMAL <span class="G">?</span> normal <span class="G">:</span> solid;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;RemoveCursor();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;RemoveCaret();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;DragRectDraw0(pr, rect1<span class="G">.</span>Offseted(p), n, pattern, animation);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;DragRectDraw0(pr, rect2<span class="G">.</span>Offseted(p), n, pattern, animation);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>DoPaint()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;LLOG(&quot;@ DoPaint&quot;);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">!</span>PaintLock) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">bool</span> scroll <span class="G">=</span> <span class="G">false</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(desktop)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;desktop<span class="G">-&gt;</span>SyncScroll();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> 0; i <span class="G">&lt;</span> topctrl<span class="G">.</span>GetCount(); i<span class="G">++</span>)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;topctrl<span class="G">[</span>i<span class="G">]-&gt;</span>SyncScroll();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>((invalid<span class="G">.</span>GetCount() <span class="G">||</span> scroll) <span class="G">&amp;&amp;</span> desktop) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RemoveCursor();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RemoveCaret();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> phase <span class="G">=</span> 0; phase <span class="G">&lt;</span> 2; phase<span class="G">++</span>) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LLOG(&quot;DoPaint invalid phase &quot; <span class="G">&lt;&lt;</span> phase);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LDUMPC(invalid);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SystemDraw painter;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;painter<span class="G">.</span>Begin();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> 0; i <span class="G">&lt;</span> invalid<span class="G">.</span>GetCount(); i<span class="G">++</span>) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;painter<span class="G">.</span>RectPath(invalid<span class="G">[</span>i<span class="G">]</span>);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AddUpdate(invalid<span class="G">[</span>i<span class="G">]</span>);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;painter<span class="G">.</span>Painter<span class="G">::</span>Clip();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> topctrl<span class="G">.</span>GetCount() <span class="G">-</span> 1; i <span class="G">&gt;=</span> 0; i<span class="G">--</span>) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Rect r <span class="G">=</span> topctrl<span class="G">[</span>i<span class="G">]-&gt;</span>GetRect();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Rect ri <span class="G">=</span> GetClipBound(invalid, r);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">!</span>IsNull(ri)) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;painter<span class="G">.</span>Clipoff(r);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;topctrl<span class="G">[</span>i<span class="G">]-&gt;</span>UpdateArea(painter, ri <span class="G">-</span> r<span class="G">.</span>TopLeft());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;painter<span class="G">.</span>End();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subtract(invalid, r);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;painter<span class="G">.</span>ExcludeClip(r);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Rect ri <span class="G">=</span> GetClipBound(invalid, framebuffer<span class="G">.</span>GetSize());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">!</span>IsNull(ri))</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;desktop<span class="G">-&gt;</span>UpdateArea(painter, ri);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;DoUpdate();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>WndUpdate0r(<span class="G">const</span> Rect<span class="G">&amp;</span> r)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Rect rr <span class="G">=</span> r <span class="G">+</span> GetRect()<span class="G">.</span>TopLeft();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">bool</span> dummy;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Vector<span class="G">&lt;</span>Rect<span class="G">&gt;</span> h;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;h <span class="G">&lt;&lt;=</span> invalid;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;invalid <span class="G">=</span> Intersect(invalid, rr, dummy);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;FBInitUpdate();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;DoPaint();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;invalid <span class="G">&lt;&lt;=</span> h;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Subtract(invalid, rr);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;FBFlush();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">bool</span> Ctrl<span class="G">::</span>ProcessEvents(<span class="G">bool</span> <span class="G">*</span>quit)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">//</span>LOGBLOCK(&quot;@ ProcessEvents&quot;);</p>
<p class="F"><span class="G">//</span>&nbsp;&nbsp;&nbsp;&nbsp;MemoryCheckDebug();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">!</span>ProcessEvent(quit))</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> <span class="G">false</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">while</span>(ProcessEvent(quit) <span class="G">&amp;&amp;</span> (<span class="G">!</span>LoopCtrl <span class="G">||</span> LoopCtrl<span class="G">-&gt;</span>InLoop()));</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;TimeStop tm;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;TimerProc(GetTickCount());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;LLOG(&quot;TimerProc elapsed<span class="G">:</span> &quot; <span class="G">&lt;&lt;</span> tm);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;SweepMkImageCache();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;FBInitUpdate();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;DoPaint();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;FBFlush();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> <span class="G">true</span>;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>EventLoop0(Ctrl <span class="G">*</span>ctrl)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT(IsMainThread());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT(LoopLevel <span class="G">==</span> 0 <span class="G">||</span> ctrl);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;LoopLevel<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;LLOG(&quot;Entering event loop at level &quot; <span class="G">&lt;&lt;</span> LoopLevel <span class="G">&lt;&lt;</span> LOG_BEGIN);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Ptr<span class="G">&lt;</span>Ctrl<span class="G">&gt;</span> ploop;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(ctrl) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ploop <span class="G">=</span> LoopCtrl;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LoopCtrl <span class="G">=</span> ctrl;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ctrl<span class="G">-&gt;</span>inloop <span class="G">=</span> <span class="G">true</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">bool</span> quit <span class="G">=</span> <span class="G">false</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;int64 loopno <span class="G">=</span> <span class="G">++</span>EventLoopNo;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ProcessEvents(<span class="G">&amp;</span>quit);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">while</span>(loopno <span class="G">&gt;</span> EndSessionLoopNo <span class="G">&amp;&amp;</span> <span class="G">!</span>quit <span class="G">&amp;&amp;</span> (ctrl <span class="G">?</span> ctrl<span class="G">-&gt;</span>IsOpen() <span class="G">&amp;&amp;</span> ctrl<span class="G">-&gt;</span>InLoop() <span class="G">:</span> GetTopCtrls()<span class="G">.</span>GetCount()))</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;{</p>
<p class="F"><span class="G">//</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LLOG(GetSysTime() <span class="G">&lt;&lt;</span> &quot; <span class="G">%</span> &quot; <span class="G">&lt;&lt;</span> (<span class="G">unsigned</span>)msecs() <span class="G">%</span> 10000 <span class="G">&lt;&lt;</span> &quot;<span class="G">:</span> EventLoop <span class="G">/</span> GuiSleep&quot;);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SyncCaret();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GuiSleep(20);</p>
<p class="F"><span class="G">//</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LLOG(GetSysTime() <span class="G">&lt;&lt;</span> &quot; <span class="G">%</span> &quot; <span class="G">&lt;&lt;</span> (<span class="G">unsigned</span>)msecs() <span class="G">%</span> 10000 <span class="G">&lt;&lt;</span> &quot;<span class="G">:</span> EventLoop <span class="G">/</span> ProcessEvents&quot;);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ProcessEvents(<span class="G">&amp;</span>quit);</p>
<p class="F"><span class="G">//</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LLOG(GetSysTime() <span class="G">&lt;&lt;</span> &quot; <span class="G">%</span> &quot; <span class="G">&lt;&lt;</span> (<span class="G">unsigned</span>)msecs() <span class="G">%</span> 10000 <span class="G">&lt;&lt;</span> &quot;<span class="G">:</span> EventLoop <span class="G">/</span> after ProcessEvents&quot;);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LDUMP(loopno);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LDUMP(fbEndSessionLoop);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(ctrl)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LoopCtrl <span class="G">=</span> ploop;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;LoopLevel<span class="G">--</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;LLOG(LOG_END <span class="G">&lt;&lt;</span> &quot;Leaving event loop &quot;);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>GuiSleep0(<span class="G">int</span> ms)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT(IsMainThread());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;LLOG(&quot;GuiSleep&quot;);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> level <span class="G">=</span> LeaveGuiMutexAll();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;FBSleep(ms);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;EnterGuiMutex(level);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="H"><span class="I">Rect Ctrl</span>::<span class="I">GetWndScreenRect() </span>const</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> GetRect();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>WndShow0(<span class="G">bool</span> b)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>WndUpdate0()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">bool</span> Ctrl<span class="G">::</span>IsWndOpen() <span class="G">const</span> {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> FindTopCtrl() <span class="G">&gt;=</span> 0 <span class="G">||</span> <span class="G">this</span> <span class="G">==</span> desktop;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>SetAlpha(byte alpha)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="H"><span class="I">Rect Ctrl</span>::<span class="I">GetWorkArea() </span>const</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> framebuffer<span class="G">.</span>GetSize();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>GetWorkArea(Array<span class="G">&lt;</span>Rect<span class="G">&gt;&amp;</span> rc)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Array<span class="G">&lt;</span>Rect<span class="G">&gt;</span> r;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;r<span class="G">.</span>Add(framebuffer<span class="G">.</span>GetSize());</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">Rect Ctrl<span class="G">::</span>GetVirtualWorkArea()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> framebuffer<span class="G">.</span>GetSize();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">Rect Ctrl<span class="G">::</span>GetWorkArea(Point pt)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> framebuffer<span class="G">.</span>GetSize();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">Rect Ctrl<span class="G">::</span>GetVirtualScreenArea()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> framebuffer<span class="G">.</span>GetSize();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">Rect Ctrl<span class="G">::</span>GetPrimaryWorkArea()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Rect r;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> framebuffer<span class="G">.</span>GetSize();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">Rect Ctrl<span class="G">::</span>GetPrimaryScreenArea()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> framebuffer<span class="G">.</span>GetSize();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">int</span> Ctrl<span class="G">::</span>GetKbdDelay()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> 500;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">int</span> Ctrl<span class="G">::</span>GetKbdSpeed()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> 1000 <span class="G">/</span> 32;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>DestroyWnd()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> 0; i <span class="G">&lt;</span> topctrl<span class="G">.</span>GetCount(); i<span class="G">++</span>)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(topctrl<span class="G">[</span>i<span class="G">]-&gt;</span>top <span class="G">&amp;&amp;</span> topctrl<span class="G">[</span>i<span class="G">]-&gt;</span>top<span class="G">-&gt;</span>owner_window <span class="G">==</span> <span class="G">this</span>)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;topctrl<span class="G">[</span>i<span class="G">]-&gt;</span>WndDestroy0();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> q <span class="G">=</span> FindTopCtrl();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(q <span class="G">&gt;=</span> 0) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AddInvalid(GetRect());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;topctrl<span class="G">.</span>Remove(q);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(top) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">delete</span> top;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;top <span class="G">=</span> NULL;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;isopen <span class="G">=</span> <span class="G">false</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;TopWindow <span class="G">*</span>win <span class="G">=</span> <span class="G">dynamic_cast&lt;</span>TopWindow <span class="G">*&gt;</span>(<span class="G">this</span>);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(win)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;win<span class="G">-&gt;</span>DestroyFrame();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>WndDestroy0()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;DestroyWnd();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(topctrl<span class="G">.</span>GetCount())</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;topctrl<span class="G">.</span>Top()<span class="G">-&gt;</span>ActivateWnd();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>PutForeground()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> q <span class="G">=</span> FindTopCtrl();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(q <span class="G">&gt;=</span> 0) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AddInvalid(GetRect());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;topctrl<span class="G">.</span>Remove(q);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;topctrl<span class="G">.</span>Add(<span class="G">this</span>);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Vector<span class="G">&lt;</span> Ptr<span class="G">&lt;</span>Ctrl<span class="G">&gt;</span> <span class="G">&gt;</span> fw;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> 0; i <span class="G">&lt;</span> topctrl<span class="G">.</span>GetCount(); i<span class="G">++</span>)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(topctrl<span class="G">[</span>i<span class="G">]</span> <span class="G">&amp;&amp;</span> topctrl<span class="G">[</span>i<span class="G">]-&gt;</span>top <span class="G">&amp;&amp;</span> topctrl<span class="G">[</span>i<span class="G">]-&gt;</span>top<span class="G">-&gt;</span>owner_window <span class="G">==</span> <span class="G">this</span> <span class="G">&amp;&amp;</span> topctrl<span class="G">[</span>i<span class="G">]</span> <span class="G">!=</span> <span class="G">this</span>)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fw<span class="G">.</span>Add(topctrl<span class="G">[</span>i<span class="G">]</span>);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> 0; i <span class="G">&lt;</span> fw<span class="G">.</span>GetCount(); i<span class="G">++</span>)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(fw<span class="G">[</span>i<span class="G">]</span>)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fw<span class="G">[</span>i<span class="G">]-&gt;</span>PutForeground();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>SetWndForeground0()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT(IsOpen());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(IsWndForeground())</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Ctrl <span class="G">*</span>to <span class="G">=</span> <span class="G">this</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">while</span>(to<span class="G">-&gt;</span>top <span class="G">&amp;&amp;</span> to<span class="G">-&gt;</span>top<span class="G">-&gt;</span>owner_window)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to <span class="G">=</span> to<span class="G">-&gt;</span>top<span class="G">-&gt;</span>owner_window;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;to<span class="G">-&gt;</span>PutForeground();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">this</span> <span class="G">!=</span> focusCtrl)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ActivateWnd();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="H">bool<span class="I"> Ctrl</span>::<span class="I">IsWndForeground() </span>const</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">bool</span> b <span class="G">=</span> <span class="G">false</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> 0; i <span class="G">&lt;</span> topctrl<span class="G">.</span>GetCount(); i<span class="G">++</span>) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">const</span> TopWindow <span class="G">*</span>tw <span class="G">=</span> <span class="G">dynamic_cast&lt;const</span> TopWindow <span class="G">*&gt;</span>(topctrl<span class="G">[</span>i<span class="G">]</span>);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(tw)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b <span class="G">=</span> tw <span class="G">==</span> <span class="G">this</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> b;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>WndEnable0(<span class="G">bool</span> <span class="G">*</span>b)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">*</span>b <span class="G">=</span> <span class="G">true</span>;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>SetWndFocus0(<span class="G">bool</span> <span class="G">*</span>b)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">*</span>b <span class="G">=</span> <span class="G">true</span>;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="H">bool<span class="I"> Ctrl</span>::<span class="I">HasWndFocus() </span>const</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> focusCtrl <span class="G">&amp;&amp;</span> focusCtrl<span class="G">-&gt;</span>GetTopCtrl() <span class="G">==</span> <span class="G">this</span>;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">bool</span> Ctrl<span class="G">::</span>SetWndCapture()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT(IsMainThread());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> <span class="G">true</span>;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">bool</span> Ctrl<span class="G">::</span>ReleaseWndCapture()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT(IsMainThread());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> <span class="G">true</span>;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="H">bool<span class="I"> Ctrl</span>::<span class="I">HasWndCapture() </span>const</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> captureCtrl <span class="G">&amp;&amp;</span> captureCtrl<span class="G">-&gt;</span>GetTopCtrl() <span class="G">==</span> <span class="G">this</span>;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>WndInvalidateRect(<span class="G">const</span> Rect<span class="G">&amp;</span> r)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> q <span class="G">=</span> FindTopCtrl();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(q <span class="G">&gt;=</span> 0)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AddInvalid(r <span class="G">+</span> topctrl<span class="G">[</span>q<span class="G">]-&gt;</span>GetRect()<span class="G">.</span>TopLeft());</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AddInvalid(r);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>WndSetPos0(<span class="G">const</span> Rect<span class="G">&amp;</span> rect)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;TopWindow <span class="G">*</span>w <span class="G">=</span> <span class="G">dynamic_cast&lt;</span>TopWindow <span class="G">*&gt;</span>(<span class="G">this</span>);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(w)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w<span class="G">-&gt;</span>SyncFrameRect(rect);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;invalid<span class="G">.</span>Add(GetRect());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;SetWndRect(rect);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;invalid<span class="G">.</span>Add(rect);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> &nbsp;Ctrl<span class="G">::</span>WndScrollView0(<span class="G">const</span> Rect<span class="G">&amp;</span> r, <span class="G">int</span> dx, <span class="G">int</span> dy)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(dx <span class="G">==</span> 0 <span class="G">&amp;&amp;</span> dy <span class="G">==</span> 0)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(dx <span class="G">&amp;&amp;</span> dy) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Refresh(r);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;RemoveCursor();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;RemoveCaret();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Rect sr <span class="G">=</span> r<span class="G">.</span>Offseted(GetScreenRect()<span class="G">.</span>TopLeft());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Vector<span class="G">&lt;</span>Rect<span class="G">&gt;</span> pr <span class="G">=</span> Intersection(GetPaintRects(), sr);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> 0; i <span class="G">&lt;</span> pr<span class="G">.</span>GetCount(); i<span class="G">++</span>) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Rect r <span class="G">=</span> pr<span class="G">[</span>i<span class="G">]</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(dx) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> n <span class="G">=</span> r<span class="G">.</span>GetWidth() <span class="G">-</span> abs(dx);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(n <span class="G">&gt;</span> 0) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> to <span class="G">=</span> r<span class="G">.</span>left <span class="G">+</span> dx <span class="G">*</span> (dx <span class="G">&gt;</span> 0);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> from <span class="G">=</span> r<span class="G">.</span>left <span class="G">-</span> dx <span class="G">*</span> (dx <span class="G">&lt;</span> 0);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> y <span class="G">=</span> r<span class="G">.</span>top; y <span class="G">&lt;</span> r<span class="G">.</span>bottom; y<span class="G">++</span>)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memmove(framebuffer<span class="G">[</span>y<span class="G">]</span> <span class="G">+</span> to, framebuffer<span class="G">[</span>y<span class="G">]</span> <span class="G">+</span> from, n <span class="G">*</span> <span class="G">sizeof</span>(RGBA));</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n <span class="G">=</span> min(abs(dx), r<span class="G">.</span>GetWidth());&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Refresh(dx <span class="G">&lt;</span> 0 <span class="G">?</span> r<span class="G">.</span>left <span class="G">:</span> r<span class="G">.</span>right <span class="G">-</span> n, r<span class="G">.</span>top, n, r<span class="G">.</span>GetHeight());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">else</span> {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> n <span class="G">=</span> r<span class="G">.</span>GetHeight() <span class="G">-</span> abs(dy);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> y <span class="G">=</span> 0; y <span class="G">&lt;</span> n; y<span class="G">++</span>)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memmove(framebuffer<span class="G">[</span>dy <span class="G">&lt;</span> 0 <span class="G">?</span> r<span class="G">.</span>top <span class="G">+</span> y <span class="G">:</span> r<span class="G">.</span>bottom <span class="G">-</span> 1 <span class="G">-</span> y<span class="G">]</span> <span class="G">+</span> r<span class="G">.</span>left,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;framebuffer<span class="G">[</span>dy <span class="G">&lt;</span> 0 <span class="G">?</span> r<span class="G">.</span>top <span class="G">+</span> y <span class="G">-</span> dy <span class="G">:</span> r<span class="G">.</span>bottom <span class="G">-</span> 1 <span class="G">-</span> y <span class="G">-</span> dy<span class="G">]</span> <span class="G">+</span> r<span class="G">.</span>left,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r<span class="G">.</span>GetWidth() <span class="G">*</span> <span class="G">sizeof</span>(RGBA));</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n <span class="G">=</span> min(abs(dy), r<span class="G">.</span>GetHeight());&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Refresh(r<span class="G">.</span>left, dy <span class="G">&lt;</span> 0 <span class="G">?</span> r<span class="G">.</span>bottom <span class="G">-</span> n <span class="G">:</span> r<span class="G">.</span>top, r<span class="G">.</span>GetWidth(), n);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Vector<span class="G">&lt;</span>Rect<span class="G">&gt;</span> ur;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> 0; i <span class="G">&lt;</span> invalid<span class="G">.</span>GetCount(); i<span class="G">++</span>)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(invalid<span class="G">[</span>i<span class="G">].</span>Intersects(sr))</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ur<span class="G">.</span>Add(invalid<span class="G">[</span>i<span class="G">]</span>);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> 0; i <span class="G">&lt;</span> ur<span class="G">.</span>GetCount(); i<span class="G">++</span>)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AddInvalid(ur<span class="G">[</span>i<span class="G">].</span>Offseted(dx, dy));</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>PopUp(Ctrl <span class="G">*</span>owner, <span class="G">bool</span> savebits, <span class="G">bool</span> activate, <span class="G">bool</span> dropshadow, <span class="G">bool</span> topmost)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ASSERT(<span class="G">!</span>IsChild() <span class="G">&amp;&amp;</span> <span class="G">!</span>IsOpen() <span class="G">&amp;&amp;</span> FindTopCtrl() <span class="G">&lt;</span> 0);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;NewTop();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(owner) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ctrl <span class="G">*</span>owner_window <span class="G">=</span> owner<span class="G">-&gt;</span>GetTopWindow();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">!</span>owner_window)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;owner_window <span class="G">=</span> owner<span class="G">-&gt;</span>GetTopCtrl();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ASSERT(owner_window<span class="G">-&gt;</span>IsOpen());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(owner_window <span class="G">!=</span> desktop) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;owner_window<span class="G">-&gt;</span>SetForeground();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;top<span class="G">-&gt;</span>owner_window <span class="G">=</span> owner_window;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;topctrl<span class="G">.</span>Add(<span class="G">this</span>);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;popup <span class="G">=</span> isopen <span class="G">=</span> <span class="G">true</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;RefreshLayoutDeep();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(activate) SetFocusWnd();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;AddInvalid(GetRect());</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">Rect Ctrl<span class="G">::</span>GetDefaultWindowRect() {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> <span class="G">int</span> ii <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Size sz <span class="G">=</span> framebuffer<span class="G">.</span>GetSize();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Rect rect <span class="G">=</span> framebuffer<span class="G">.</span>GetSize();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;rect<span class="G">.</span>Deflate(sz <span class="G">/</span> 10);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;rect<span class="G">.</span>Offset(Size(GetStdFontCy(), 2 <span class="G">*</span> GetStdFontCy()) <span class="G">*</span> (<span class="G">++</span>ii <span class="G">%</span> 8));</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> rect;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">Vector<span class="G">&lt;</span>WString<span class="G">&gt;</span> SplitCmdLine__(<span class="G">const</span> <span class="G">char</span> <span class="G">*</span>cmd)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Vector<span class="G">&lt;</span>WString<span class="G">&gt;</span> out;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">while</span>(<span class="G">*</span>cmd)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>((byte)<span class="G">*</span>cmd <span class="G">&lt;=</span> ' ')</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">else</span> <span class="G">if</span>(<span class="G">*</span>cmd <span class="G">==</span> '\&quot;') {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WString quoted;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">while</span>(<span class="G">*++</span>cmd <span class="G">&amp;&amp;</span> (<span class="G">*</span>cmd <span class="G">!=</span> '\&quot;' <span class="G">||</span> <span class="G">*++</span>cmd <span class="G">==</span> '\&quot;'))</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quoted<span class="G">.</span>Cat(FromSystemCharset(String(cmd, 1))<span class="G">.</span>ToWString());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;out<span class="G">.</span>Add(quoted);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">else</span> {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">const</span> <span class="G">char</span> <span class="G">*</span>begin <span class="G">=</span> cmd;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">while</span>((byte)<span class="G">*</span>cmd <span class="G">&gt;</span> ' ')</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;out<span class="G">.</span>Add(String(begin, cmd)<span class="G">.</span>ToWString());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> out;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">END_UPP_NAMESPACE</p>
<p class="F">&nbsp;</p>
<p class="H">#endif</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="E">DnD.cpp</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#include</span> &quot;Fb<span class="G">.</span>h&quot;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#ifdef</span> GUI_FB</p>
<p class="F">&nbsp;</p>
<p class="F">NAMESPACE_UPP</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#define</span> LLOG(x) &nbsp;<span class="G">//</span> DLOG(x)</p>
<p class="F">&nbsp;</p>
<p class="H">//<span class="I"> </span>--------------------------------------------------------------------------------------------</p>
<p class="F">&nbsp;</p>
<p class="F">Ptr<span class="G">&lt;</span>Ctrl<span class="G">&gt;</span> sDnDSource;</p>
<p class="F">&nbsp;</p>
<p class="F">Ctrl <span class="G">*</span> Ctrl<span class="G">::</span>GetDragAndDropSource()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> sDnDSource;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">struct</span> DnDLoop <span class="G">:</span> LocalLoop {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">const</span> VectorMap<span class="G">&lt;</span>String, ClipData<span class="G">&gt;</span> <span class="G">*</span>data;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Vector<span class="G">&lt;</span>String<span class="G">&gt;</span> fmts;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Image move, copy, reject;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Ptr<span class="G">&lt;</span>Ctrl<span class="G">&gt;</span> target;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> &nbsp;&nbsp;&nbsp;action;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;byte &nbsp;&nbsp;actions;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;&nbsp;Sync();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;String GetData(<span class="G">const</span> String<span class="G">&amp;</span> f);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">void</span> &nbsp;&nbsp;DnD(<span class="G">bool</span> paste);</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">void</span> &nbsp;LeftUp(Point, dword);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">bool</span> &nbsp;Key(dword, <span class="G">int</span>);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> <span class="G">void</span> &nbsp;MouseMove(Point p, dword);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">virtual</span> Image CursorImage(Point, dword);</p>
<p class="F">};</p>
<p class="F">&nbsp;</p>
<p class="F">Ptr<span class="G">&lt;</span>DnDLoop<span class="G">&gt;</span> dndloop;</p>
<p class="F">&nbsp;</p>
<p class="H">bool<span class="I"> PasteClip</span>::<span class="I">IsAvailable(</span>const<span class="I"> </span>char<span class="I"> </span>*<span class="I">fmt) </span>const</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> dnd <span class="G">?</span> dndloop <span class="G">&amp;&amp;</span> FindIndex(dndloop<span class="G">-&gt;</span>fmts, fmt) <span class="G">&gt;=</span> 0</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">:</span> IsClipboardAvailable(fmt);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">String DnDLoop<span class="G">::</span>GetData(<span class="G">const</span> String<span class="G">&amp;</span> f)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> i <span class="G">=</span> data<span class="G">-&gt;</span>Find(f);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;String d;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(i <span class="G">&gt;=</span> 0)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d <span class="G">=</span> (<span class="G">*</span>data)<span class="G">[</span>i<span class="G">].</span>Render();</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(sDnDSource)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d <span class="G">=</span> sDnDSource<span class="G">-&gt;</span>GetDropData(f);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> d;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="H"><span class="I">String PasteClip</span>::<span class="I">Get(</span>const<span class="I"> </span>char<span class="I"> </span>*<span class="I">fmt) </span>const</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> dnd <span class="G">?</span> dndloop <span class="G">?</span> dndloop<span class="G">-&gt;</span>GetData(fmt) <span class="G">:</span> String() <span class="G">:</span> ReadClipboard(fmt);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> PasteClip<span class="G">::</span>GuiPlatformConstruct()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;dnd <span class="G">=</span> <span class="G">false</span>;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> DnDLoop<span class="G">::</span>DnD(<span class="G">bool</span> paste)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;PasteClip d;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;d<span class="G">.</span>paste <span class="G">=</span> paste;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;d<span class="G">.</span>accepted <span class="G">=</span> <span class="G">false</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;d<span class="G">.</span>allowed <span class="G">=</span> (byte)actions;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;d<span class="G">.</span>action <span class="G">=</span> GetCtrl() <span class="G">?</span> DND_COPY <span class="G">:</span> DND_MOVE;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;d<span class="G">.</span>dnd <span class="G">=</span> <span class="G">true</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(target)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;target<span class="G">-&gt;</span>DnD(GetMousePos(), d);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;action <span class="G">=</span> d<span class="G">.</span>IsAccepted() <span class="G">?</span> d<span class="G">.</span>GetAction() <span class="G">:</span> DND_NONE;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> DnDLoop<span class="G">::</span>Sync()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Ptr<span class="G">&lt;</span>Ctrl<span class="G">&gt;</span> t <span class="G">=</span> FindMouseTopCtrl();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(t <span class="G">!=</span> target)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(target)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;target<span class="G">-&gt;</span>DnDLeave();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;target <span class="G">=</span> t;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;DnD(<span class="G">false</span>);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> DnDLoop<span class="G">::</span>LeftUp(Point, dword)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __; </p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;LLOG(&quot;DnDLoop<span class="G">::</span>LeftUp&quot;);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;DnD(<span class="G">true</span>);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;EndLoop();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> DnDLoop<span class="G">::</span>MouseMove(Point p, dword)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __; </p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;LLOG(&quot;DnDLoop<span class="G">::</span>MouseMove&quot;);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Sync();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">bool</span> DnDLoop<span class="G">::</span>Key(dword, <span class="G">int</span>)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __; </p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;LLOG(&quot;DnDLoop<span class="G">::</span>Key&quot;);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Sync();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> <span class="G">false</span>;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">Image DnDLoop<span class="G">::</span>CursorImage(Point, dword)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __; </p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> action <span class="G">==</span> DND_MOVE <span class="G">?</span> move <span class="G">:</span> action <span class="G">==</span> DND_COPY <span class="G">?</span> copy <span class="G">:</span> reject;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">int</span> Ctrl<span class="G">::</span>DoDragAndDrop(<span class="G">const</span> <span class="G">char</span> <span class="G">*</span>fmts, <span class="G">const</span> Image<span class="G">&amp;</span> sample, dword actions,</p>
<p class="F"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">const</span> VectorMap<span class="G">&lt;</span>String, ClipData<span class="G">&gt;&amp;</span> data)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __; </p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;DnDLoop d;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;d<span class="G">.</span>actions <span class="G">=</span> (byte)actions;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;d<span class="G">.</span>reject <span class="G">=</span> actions <span class="G">&amp;</span> DND_EXACTIMAGE <span class="G">?</span> CtrlCoreImg<span class="G">::</span>DndNone() <span class="G">:</span> MakeDragImage(CtrlCoreImg<span class="G">::</span>DndNone(), sample);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(actions <span class="G">&amp;</span> DND_COPY)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d<span class="G">.</span>copy <span class="G">=</span> actions <span class="G">&amp;</span> DND_EXACTIMAGE <span class="G">?</span> sample <span class="G">:</span> MakeDragImage(CtrlCoreImg<span class="G">::</span>DndCopy(), sample);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(actions <span class="G">&amp;</span> DND_MOVE)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d<span class="G">.</span>move <span class="G">=</span> actions <span class="G">&amp;</span> DND_EXACTIMAGE <span class="G">?</span> sample <span class="G">:</span> MakeDragImage(CtrlCoreImg<span class="G">::</span>DndMoveX11(), sample);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;d<span class="G">.</span>SetMaster(<span class="G">*this</span>);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;d<span class="G">.</span>data <span class="G">=</span> <span class="G">&amp;</span>data;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;d<span class="G">.</span>action <span class="G">=</span> DND_NONE;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;d<span class="G">.</span>fmts <span class="G">=</span> Split(fmts, ';');</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;dndloop <span class="G">=</span> <span class="G">&amp;</span>d;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;sDnDSource <span class="G">=</span> <span class="G">this</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;d<span class="G">.</span>Run();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;sDnDSource <span class="G">=</span> NULL;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;SyncCaret();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;LLOG(&quot;DoDragAndDrop finished&quot;);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> d<span class="G">.</span>action;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>SetSelectionSource(<span class="G">const</span> <span class="G">char</span> <span class="G">*</span>fmts) {}</p>
<p class="F">&nbsp;</p>
<p class="F">END_UPP_NAMESPACE</p>
<p class="F">&nbsp;</p>
<p class="H">#endif</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="E">Clip.cpp</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#include</span> &quot;Fb<span class="G">.</span>h&quot;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#ifdef</span> GUI_FB</p>
<p class="F">&nbsp;</p>
<p class="F">NAMESPACE_UPP</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#define</span> LLOG(x) &nbsp;<span class="G">//</span> LOG(x)</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">static</span> VectorMap<span class="G">&lt;</span>String, ClipData<span class="G">&gt;</span> fbClipboard;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> ClearClipboard()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;fbClipboard<span class="G">.</span>Clear();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> AppendClipboard(<span class="G">const</span> <span class="G">char</span> <span class="G">*</span>format, <span class="G">const</span> Value<span class="G">&amp;</span> data, String (<span class="G">*</span>render)(<span class="G">const</span> Value<span class="G">&amp;</span>))</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ClipData<span class="G">&amp;</span> cd <span class="G">=</span> fbClipboard<span class="G">.</span>GetAdd(format);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;cd<span class="G">.</span>data <span class="G">=</span> data;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;cd<span class="G">.</span>render <span class="G">=</span> render;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">static</span> String sRawRender(<span class="G">const</span> Value<span class="G">&amp;</span> v)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> v;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> AppendClipboard(<span class="G">const</span> <span class="G">char</span> <span class="G">*</span>format, <span class="G">const</span> String<span class="G">&amp;</span> data)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;AppendClipboard(format, data, sRawRender);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> AppendClipboard(<span class="G">const</span> <span class="G">char</span> <span class="G">*</span>format, <span class="G">const</span> byte <span class="G">*</span>data, <span class="G">int</span> length)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;AppendClipboard(format, String(data, length));</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">String ReadClipboard(<span class="G">const</span> <span class="G">char</span> <span class="G">*</span>format)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> q <span class="G">=</span> fbClipboard<span class="G">.</span>Find(format);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> q <span class="G">&gt;=</span> 0 <span class="G">?</span> (<span class="G">*</span>fbClipboard<span class="G">[</span>q<span class="G">].</span>render)(fbClipboard<span class="G">[</span>q<span class="G">].</span>data) <span class="G">:</span> String();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> AppendClipboardText(<span class="G">const</span> String<span class="G">&amp;</span> s)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;AppendClipboard(&quot;text&quot;, ToSystemCharset(s));</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> AppendClipboardUnicodeText(<span class="G">const</span> WString<span class="G">&amp;</span> s)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;AppendClipboard(&quot;wtext&quot;, (byte <span class="G">*</span>)<span class="G">~</span>s, 2 <span class="G">*</span> s<span class="G">.</span>GetLength());</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">const</span> <span class="G">char</span> <span class="G">*</span>ClipFmtsText()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> &quot;wtext;text&quot;;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">String GetString(PasteClip<span class="G">&amp;</span> clip)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(clip<span class="G">.</span>Accept(&quot;wtext&quot;)) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String s <span class="G">=</span> <span class="G">~</span>clip;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> WString((<span class="G">const</span> wchar <span class="G">*</span>)<span class="G">~</span>s, wstrlen((<span class="G">const</span> wchar <span class="G">*</span>)<span class="G">~</span>s))<span class="G">.</span>ToString();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(clip<span class="G">.</span>IsAvailable(&quot;text&quot;))</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> <span class="G">~</span>clip;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> Null;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">WString GetWString(PasteClip<span class="G">&amp;</span> clip)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(clip<span class="G">.</span>Accept(&quot;wtext&quot;)) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String s <span class="G">=</span> <span class="G">~</span>clip;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> WString((<span class="G">const</span> wchar <span class="G">*</span>)<span class="G">~</span>s, wstrlen((<span class="G">const</span> wchar <span class="G">*</span>)<span class="G">~</span>s));</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(clip<span class="G">.</span>IsAvailable(&quot;text&quot;))</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> (<span class="G">~</span>clip)<span class="G">.</span>ToWString();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> Null;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">bool</span> AcceptText(PasteClip<span class="G">&amp;</span> clip)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> clip<span class="G">.</span>Accept(ClipFmtsText());</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">static</span> String sText(<span class="G">const</span> Value<span class="G">&amp;</span> data)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> data;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">static</span> String sWText(<span class="G">const</span> Value<span class="G">&amp;</span> data)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> Unicode__(WString(data));</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Append(VectorMap<span class="G">&lt;</span>String, ClipData<span class="G">&gt;&amp;</span> data, <span class="G">const</span> String<span class="G">&amp;</span> text)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;data<span class="G">.</span>GetAdd(&quot;text&quot;, ClipData(text, sText));</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;data<span class="G">.</span>GetAdd(&quot;wtext&quot;, ClipData(text, sWText));</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Append(VectorMap<span class="G">&lt;</span>String, ClipData<span class="G">&gt;&amp;</span> data, <span class="G">const</span> WString<span class="G">&amp;</span> text)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;data<span class="G">.</span>GetAdd(&quot;text&quot;, ClipData(text, sText));</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;data<span class="G">.</span>GetAdd(&quot;wtext&quot;, ClipData(text, sWText));</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">String GetTextClip(<span class="G">const</span> WString<span class="G">&amp;</span> text, <span class="G">const</span> String<span class="G">&amp;</span> fmt)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(fmt <span class="G">==</span> &quot;text&quot;)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> text<span class="G">.</span>ToString();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(fmt <span class="G">==</span> &quot;wtext&quot;)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> Unicode__(text);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> Null;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">String GetTextClip(<span class="G">const</span> String<span class="G">&amp;</span> text, <span class="G">const</span> String<span class="G">&amp;</span> fmt)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(fmt <span class="G">==</span> &quot;text&quot;)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> text;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(fmt <span class="G">==</span> &quot;wtext&quot;)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> Unicode__(text<span class="G">.</span>ToWString());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> Null;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">String ReadClipboardText()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;String w <span class="G">=</span> ReadClipboard(&quot;text&quot;);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> w<span class="G">.</span>GetCount() <span class="G">?</span> w <span class="G">:</span> ReadClipboardUnicodeText()<span class="G">.</span>ToString();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">WString ReadClipboardUnicodeText()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;String w <span class="G">=</span> ReadClipboard(&quot;wtext&quot;);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(w<span class="G">.</span>GetCount())</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> WString((<span class="G">const</span> wchar <span class="G">*</span>)<span class="G">~</span>w, w<span class="G">.</span>GetLength() <span class="G">/</span> 2);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> ReadClipboard(&quot;text&quot;)<span class="G">.</span>ToWString();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">bool</span> IsClipboardAvailable(<span class="G">const</span> <span class="G">char</span> <span class="G">*</span>id)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> fbClipboard<span class="G">.</span>Find(id) <span class="G">&gt;=</span> 0;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">bool</span> IsClipboardAvailableText()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> IsClipboardAvailable(&quot;text&quot;) <span class="G">||</span> IsClipboardAvailable(&quot;wtext&quot;);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">const</span> <span class="G">char</span> <span class="G">*</span>ClipFmtsImage()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> <span class="G">const</span> <span class="G">char</span> <span class="G">*</span>q;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ONCELOCK {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> String s <span class="G">=</span> &quot;dib;&quot; <span class="G">+</span> ClipFmt<span class="G">&lt;</span>Image<span class="G">&gt;</span>();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;q <span class="G">=</span> s;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> q;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">bool</span> AcceptImage(PasteClip<span class="G">&amp;</span> clip)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> clip<span class="G">.</span>Accept(ClipFmtsImage());</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">Image GetImage(PasteClip<span class="G">&amp;</span> clip)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Image m;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(Accept<span class="G">&lt;</span>Image<span class="G">&gt;</span>(clip)) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LoadFromString(m, <span class="G">~</span>clip);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">!</span>m<span class="G">.</span>IsEmpty())</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> m;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> Null;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">Image ReadClipboardImage()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;PasteClip d <span class="G">=</span> Ctrl<span class="G">::</span>Clipboard();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> GetImage(d);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">String sImage(<span class="G">const</span> Value<span class="G">&amp;</span> image)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Image img <span class="G">=</span> image;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> StoreAsString(<span class="G">const_cast&lt;</span>Image<span class="G">&amp;&gt;</span>(img));</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">String GetImageClip(<span class="G">const</span> Image<span class="G">&amp;</span> img, <span class="G">const</span> String<span class="G">&amp;</span> fmt)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(img<span class="G">.</span>IsEmpty()) <span class="G">return</span> Null;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(fmt <span class="G">==</span> ClipFmt<span class="G">&lt;</span>Image<span class="G">&gt;</span>())</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> sImage(img);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> Null;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> AppendClipboardImage(<span class="G">const</span> Image<span class="G">&amp;</span> img)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(img<span class="G">.</span>IsEmpty()) <span class="G">return</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;AppendClipboard(ClipFmt<span class="G">&lt;</span>Image<span class="G">&gt;</span>(), img, sImage);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">bool</span> AcceptFiles(PasteClip<span class="G">&amp;</span> clip)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(clip<span class="G">.</span>Accept(&quot;files&quot;)) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clip<span class="G">.</span>SetAction(DND_COPY);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> <span class="G">true</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> <span class="G">false</span>;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">bool</span> IsAvailableFiles(PasteClip<span class="G">&amp;</span> clip)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> clip<span class="G">.</span>IsAvailable(&quot;files&quot;);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">Vector<span class="G">&lt;</span>String<span class="G">&gt;</span> GetFiles(PasteClip<span class="G">&amp;</span> clip)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Vector<span class="G">&lt;</span>String<span class="G">&gt;</span> f;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> f;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">END_UPP_NAMESPACE</p>
<p class="F">&nbsp;</p>
<p class="H">#endif</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="E">Ctrl.cpp</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#include</span> &quot;Fb<span class="G">.</span>h&quot;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#ifdef</span> GUI_FB</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#define</span> LLOG(x) <span class="G">//</span> DLOG(x)</p>
<p class="F">&nbsp;</p>
<p class="F">NAMESPACE_UPP</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>GuiPlatformConstruct()</p>
<p class="F">{</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>GuiPlatformRemove()</p>
<p class="F">{</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="H">void<span class="I"> Ctrl</span>::<span class="I">GuiPlatformGetTopRect(Rect</span>&amp;<span class="I"> r) </span>const</p>
<p class="F">{</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">bool</span> Ctrl<span class="G">::</span>GuiPlatformRefreshFrameSpecial(<span class="G">const</span> Rect<span class="G">&amp;</span> r)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> <span class="G">false</span>;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">bool</span> Ctrl<span class="G">::</span>GuiPlatformSetFullRefreshSpecial()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> <span class="G">false</span>;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>PaintCaret(SystemDraw<span class="G">&amp;</span> w)</p>
<p class="F">{</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">String GuiPlatformGetKeyDesc(dword key)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> Null;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>GuiPlatformSelection(PasteClip<span class="G">&amp;</span>)</p>
<p class="F">{</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> GuiPlatformAdjustDragImage(ImageBuffer<span class="G">&amp;</span>)</p>
<p class="F">{</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">bool</span> GuiPlatformHasSizeGrip()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> <span class="G">true</span>;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> GuiPlatformGripResize(TopWindow <span class="G">*</span>q)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;q<span class="G">-&gt;</span>GripResize();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">Color GuiPlatformGetScreenPixel(<span class="G">int</span> x, <span class="G">int</span> y)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> Ctrl<span class="G">::</span>GetFrameBuffer()<span class="G">[</span>y<span class="G">][</span>x<span class="G">]</span>;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> GuiPlatformAfterMenuPopUp()</p>
<p class="F">{</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">String Ctrl<span class="G">::</span>Name() <span class="G">const</span> {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F"><span class="G">#ifdef</span> CPU_64</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;String s <span class="G">=</span> String(<span class="G">typeid</span>(<span class="G">*this</span>)<span class="G">.</span>name()) <span class="G">+</span> &quot; <span class="G">:</span> 0x&quot; <span class="G">+</span> FormatIntHex(<span class="G">this</span>);</p>
<p class="H">#else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;String s <span class="G">=</span> String(<span class="G">typeid</span>(<span class="G">*this</span>)<span class="G">.</span>name()) <span class="G">+</span> &quot; <span class="G">:</span> &quot; <span class="G">+</span> Format(&quot;0x<span class="G">%</span>x&quot;, (<span class="G">int</span>) <span class="G">this</span>);</p>
<p class="H">#endif</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(IsChild())</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s <span class="G">&lt;&lt;</span> &quot;(parent &quot; <span class="G">&lt;&lt;</span> String(<span class="G">typeid</span>(<span class="G">*</span>parent)<span class="G">.</span>name()) <span class="G">&lt;&lt;</span> &quot;)&quot;;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> s;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>InstallPanicBox()</p>
<p class="F">{</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">END_UPP_NAMESPACE</p>
<p class="F">&nbsp;</p>
<p class="H">#endif</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="E">Util.cpp</p>
<p class="F">&nbsp;</p>
<p class="H">#include<span class="I"> </span>&lt;<span class="I">CtrlCore</span>/<span class="I">CtrlCore</span>.<span class="I">h</span>&gt;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#ifdef</span> GUI_FB</p>
<p class="F">&nbsp;</p>
<p class="F">NAMESPACE_UPP</p>
<p class="F">&nbsp;</p>
<p class="H">/*</p>
<p class="F"><span class="G">static</span> <span class="G">void</span> sRenderLine(SystemDraw<span class="G">&amp;</span> w, <span class="G">int</span> x, <span class="G">int</span> y, <span class="G">int</span> dx, <span class="G">int</span> dy, <span class="G">int</span> cx, <span class="G">int</span> cy, <span class="G">int</span> len, byte pattern)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;DLOG(len);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> 0; i <span class="G">&lt;</span> len; i<span class="G">++</span>)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>((128 <span class="G">&gt;&gt;</span> (i <span class="G">&amp;</span> 7)) <span class="G">&amp;</span> pattern)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w<span class="G">.</span>DrawRect(x <span class="G">+</span> dx <span class="G">*</span> i, y <span class="G">+</span> dy <span class="G">*</span> i, cx, cy, Black);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;DDUMP(&quot;<span class="G">~</span>sRenderLine&quot;);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">static</span> <span class="G">void</span> sRenderRect(SystemDraw<span class="G">&amp;</span> w, <span class="G">const</span> Rect<span class="G">&amp;</span> r, <span class="G">int</span> n, byte pattern)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;sRenderLine(w, r<span class="G">.</span>left, r<span class="G">.</span>top, 1, 0, 1, n, r<span class="G">.</span>GetWidth(), pattern);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;sRenderLine(w, r<span class="G">.</span>left, r<span class="G">.</span>bottom <span class="G">-</span> 1, 1, 0, 1, n, r<span class="G">.</span>GetWidth(), pattern);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;sRenderLine(w, r<span class="G">.</span>left, r<span class="G">.</span>top, 0, 1, n, 1, r<span class="G">.</span>GetHeight(), pattern);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;sRenderLine(w, r<span class="G">.</span>right <span class="G">-</span> 1, r<span class="G">.</span>top, 0, 1, n, 1, r<span class="G">.</span>GetHeight(), pattern);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> DrawDragRect(SystemDraw<span class="G">&amp;</span> w, <span class="G">const</span> Rect<span class="G">&amp;</span> rect1, <span class="G">const</span> Rect<span class="G">&amp;</span> rect2,</p>
<p class="F"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">const</span> Rect<span class="G">&amp;</span> clip, <span class="G">int</span> n, Color color, uint64 pattern)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;DLOG(&quot;@ DrawDragRect &quot; <span class="G">&lt;&lt;</span> rect1 <span class="G">&lt;&lt;</span> &quot; &quot; <span class="G">&lt;&lt;</span> rect2 <span class="G">&lt;&lt;</span> &quot;, clip<span class="G">:</span> &quot; <span class="G">&lt;&lt;</span> clip <span class="G">&lt;&lt;</span> &quot;, pattern<span class="G">:</span> &quot; <span class="G">&lt;&lt;</span> pattern);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;TIMING(&quot;DrawDrawRect&quot;);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;w<span class="G">.</span>Clip(clip);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;w<span class="G">.</span>Invert();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;sRenderRect(w, rect1, n, (byte)pattern);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;sRenderRect(w, rect2, n, (byte)pattern);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Ctrl<span class="G">::</span>AddUpdate((rect1 <span class="G">|</span> rect2)<span class="G">.</span>Offseted(w<span class="G">.</span>GetOffset()));</p>
<p class="F"><span class="G">//</span>&nbsp;&nbsp;&nbsp;&nbsp;MemoryProfile mem;</p>
<p class="F"><span class="G">//</span>&nbsp;&nbsp;&nbsp;&nbsp;DDUMP(mem);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;w<span class="G">.</span>End();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">static</span> uint64 sGetAniPat(uint64 src, <span class="G">int</span> pos)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;uint64 out <span class="G">=</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;pos <span class="G">&amp;=</span> 7;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> 8; <span class="G">--</span>i <span class="G">&gt;=</span> 0;) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;byte sr <span class="G">=</span> (byte)(src <span class="G">&gt;&gt;</span> (8 <span class="G">*</span> ((7 <span class="G">-</span> i <span class="G">-</span> pos) <span class="G">&amp;</span> 7)));</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;out <span class="G">=</span> (out <span class="G">&lt;&lt;</span> 8) <span class="G">|</span> (byte)((sr <span class="G">|</span> (sr <span class="G">&lt;&lt;</span> 8)) <span class="G">&gt;&gt;</span> pos);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> out;</p>
<p class="F">}</p>
<p class="H">*/</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="H">/*</p>
<p class="F">Size GetScreenSize()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> ScreenInfo()<span class="G">.</span>GetPageSize();</p>
<p class="F">}</p>
<p class="H">*/</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> DrawDragRect(Ctrl<span class="G">&amp;</span> q, <span class="G">const</span> Rect<span class="G">&amp;</span> rect1, <span class="G">const</span> Rect<span class="G">&amp;</span> rect2, <span class="G">const</span> Rect<span class="G">&amp;</span> clip, <span class="G">int</span> n,</p>
<p class="F"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Color color, <span class="G">int</span> type, <span class="G">int</span> animation)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;q<span class="G">.</span>DragRectDraw(rect1, rect2, clip, n, color, type, animation);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">END_UPP_NAMESPACE</p>
<p class="F">&nbsp;</p>
<p class="H">#endif</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="E">Top.cpp</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#include</span> &quot;Fb<span class="G">.</span>h&quot;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#ifdef</span> GUI_FB</p>
<p class="F">&nbsp;</p>
<p class="F">NAMESPACE_UPP</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#define</span> LLOG(x) &nbsp;<span class="G">//</span> LOG(x)</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> TopWindow<span class="G">::</span>SyncFrameRect(<span class="G">const</span> Rect<span class="G">&amp;</span> r)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;frame<span class="G">-&gt;</span>SetClient(r);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> TopWindow<span class="G">::</span>DestroyFrame()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(frame<span class="G">-&gt;</span>IsOpen())</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;frame<span class="G">-&gt;</span>DestroyWnd();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> TopWindow<span class="G">::</span>GripResize()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;frame<span class="G">-&gt;</span>GripResize();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> TopWindow<span class="G">::</span>SyncSizeHints()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;SyncCaption0();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> TopWindow<span class="G">::</span>SyncTitle0()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;SyncCaption0();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> TopWindow<span class="G">::</span>SyncCaption0()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;frame<span class="G">-&gt;</span>title <span class="G">=</span> title<span class="G">.</span>ToString();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;frame<span class="G">-&gt;</span>minsize <span class="G">=</span> minsize;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;frame<span class="G">-&gt;</span>close<span class="G">.</span>Show(<span class="G">!</span>noclosebox);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;frame<span class="G">-&gt;</span>maximize<span class="G">.</span>Show(maximizebox);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;frame<span class="G">-&gt;</span>sizeable <span class="G">=</span> sizeable;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;frame<span class="G">-&gt;</span>RefreshLayout();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;frame<span class="G">-&gt;</span>Refresh();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;frame<span class="G">-&gt;</span>close <span class="G">&lt;&lt;=</span> Proxy(WhenClose);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;frame<span class="G">-&gt;</span>icon <span class="G">=</span> icon;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;frame<span class="G">-&gt;</span>Enable(IsEnabled());</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> TopWindow<span class="G">::</span>State(<span class="G">int</span> reason)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;SyncCaption0();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> TopWindow<span class="G">::</span>SyncRect()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;frame<span class="G">-&gt;</span>SyncRect();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Rect r <span class="G">=</span> frame<span class="G">-&gt;</span>GetClient();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(r <span class="G">!=</span> GetRect()) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetRect(r);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> TopWindow<span class="G">::</span>Open(Ctrl <span class="G">*</span>owner)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;LLOG(&quot;Open &quot; <span class="G">&lt;&lt;</span> Upp<span class="G">::</span>Name(owner));</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Rect r <span class="G">=</span> GetRect();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(r<span class="G">.</span>IsEmpty())</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetRect(GetDefaultWindowRect());</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(r<span class="G">.</span>left <span class="G">==</span> 0 <span class="G">&amp;&amp;</span> r<span class="G">.</span>top <span class="G">==</span> 0)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(owner <span class="G">&amp;&amp;</span> center <span class="G">==</span> 1)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetRect(owner<span class="G">-&gt;</span>GetRect()<span class="G">.</span>CenterRect(r<span class="G">.</span>GetSize()));</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(center)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetRect(GetWorkArea()<span class="G">.</span>CenterRect(r<span class="G">.</span>GetSize()));</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;frame<span class="G">-&gt;</span>SetClient(GetRect());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;frame<span class="G">-&gt;</span>window <span class="G">=</span> <span class="G">this</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;frame<span class="G">-&gt;</span>PopUp(owner, <span class="G">false</span>, <span class="G">true</span>);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;PopUp(frame, <span class="G">false</span>, <span class="G">true</span>);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;popup <span class="G">=</span> <span class="G">false</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;SetRect(frame<span class="G">-&gt;</span>GetClient());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;SyncCaption0();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(state <span class="G">==</span> MAXIMIZED)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;frame<span class="G">-&gt;</span>Maximize();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> TopWindow<span class="G">::</span>Open()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Open(GetActiveCtrl());</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> TopWindow<span class="G">::</span>OpenMain()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Open(NULL);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> TopWindow<span class="G">::</span>Minimize(<span class="G">bool</span> effect)</p>
<p class="F">{</p>
<p class="F"><span class="G">//</span>&nbsp;&nbsp;&nbsp;&nbsp;state <span class="G">=</span> MINIMIZED;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">TopWindow<span class="G">&amp;</span> TopWindow<span class="G">::</span>FullScreen(<span class="G">bool</span> b)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> <span class="G">*this</span>;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> TopWindow<span class="G">::</span>Maximize(<span class="G">bool</span> effect)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;state <span class="G">=</span> MAXIMIZED;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;frame<span class="G">-&gt;</span>Maximize();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> TopWindow<span class="G">::</span>Overlap(<span class="G">bool</span> effect)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;state <span class="G">=</span> OVERLAPPED;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;frame<span class="G">-&gt;</span>Overlap();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">TopWindow<span class="G">&amp;</span> TopWindow<span class="G">::</span>TopMost(<span class="G">bool</span> b, <span class="G">bool</span> stay_top)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> <span class="G">*this</span>;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="H">bool<span class="I"> TopWindow</span>::<span class="I">IsTopMost() </span>const</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> <span class="G">true</span>;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> TopWindow<span class="G">::</span>GuiPlatformConstruct()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;frame <span class="G">=</span> <span class="G">new</span> TopWindowFrame;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> TopWindow<span class="G">::</span>GuiPlatformDestruct()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">delete</span> frame;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> TopWindow<span class="G">::</span>SerializePlacement(Stream<span class="G">&amp;</span> s, <span class="G">bool</span> reminimize)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">END_UPP_NAMESPACE</p>
<p class="F">&nbsp;</p>
<p class="H">#endif</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="E">TopFrame.cpp</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#include</span> &quot;Fb<span class="G">.</span>h&quot;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#ifdef</span> GUI_FB</p>
<p class="F">&nbsp;</p>
<p class="F">NAMESPACE_UPP</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#define</span> LLOG(x) &nbsp;<span class="G">//</span> LOG(x)</p>
<p class="F"><span class="G">#define</span> LDUMP(x) <span class="G">//</span>DDUMP(x)</p>
<p class="F">&nbsp;</p>
<p class="F">TopWindowFrame<span class="G">::</span>TopWindowFrame()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;close<span class="G">.</span>SetImage(FBImg<span class="G">::</span>close());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;close<span class="G">.</span>EdgeStyle();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Add(close);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;maximize<span class="G">.</span>SetImage(FBImg<span class="G">::</span>maximize());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;maximize<span class="G">.</span>EdgeStyle();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Add(maximize);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;maximize <span class="G">&lt;&lt;=</span> THISBACK(ToggleMaximize);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;maximized <span class="G">=</span> <span class="G">false</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;sizeable <span class="G">=</span> <span class="G">false</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;holding <span class="G">=</span> <span class="G">false</span>;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> TopWindowFrame<span class="G">::</span>SyncRect()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(maximized) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Size sz <span class="G">=</span> framebuffer<span class="G">.</span>GetSize();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(GetRect()<span class="G">.</span>GetSize() <span class="G">!=</span> sz)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetRect(sz);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> TopWindowFrame<span class="G">::</span>Maximize()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">!</span>maximized <span class="G">&amp;&amp;</span> maximize<span class="G">.</span>IsShown()) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;maximized <span class="G">=</span> <span class="G">true</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;overlapped <span class="G">=</span> GetRect();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetRect(framebuffer<span class="G">.</span>GetSize());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;maximize<span class="G">.</span>SetImage(FBImg<span class="G">::</span>overlap());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> TopWindowFrame<span class="G">::</span>Overlap()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(maximized <span class="G">&amp;&amp;</span> maximize<span class="G">.</span>IsShown()) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;maximized <span class="G">=</span> <span class="G">false</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetRect(overlapped);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;maximize<span class="G">.</span>SetImage(FBImg<span class="G">::</span>maximize());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> TopWindowFrame<span class="G">::</span>ToggleMaximize()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(maximized)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Overlap();</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Maximize();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="H"><span class="I">Rect TopWindowFrame</span>::<span class="I">Margins() </span>const</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> maximized <span class="G">?</span> Rect(0, 0, 0, 0) <span class="G">:</span> ChMargins(FBImg<span class="G">::</span>border());</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> TopWindowFrame<span class="G">::</span>Paint(Draw<span class="G">&amp;</span> w)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Size sz <span class="G">=</span> GetSize();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Rect m <span class="G">=</span> Margins();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> c <span class="G">=</span> GetStdFontCy() <span class="G">+</span> 4;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ChPaintEdge(w, sz, FBImg<span class="G">::</span>border());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ChPaint(w, m<span class="G">.</span>left, m<span class="G">.</span>top, sz<span class="G">.</span>cx <span class="G">-</span> m<span class="G">.</span>left <span class="G">-</span> m<span class="G">.</span>right, GetStdFontCy() <span class="G">+</span> 4,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;window<span class="G">-&gt;</span>IsForeground() <span class="G">?</span> FBImg<span class="G">::</span>title() <span class="G">:</span> FBImg<span class="G">::</span>bgtitle());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> tx <span class="G">=</span> m<span class="G">.</span>left <span class="G">+</span> 2;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> tcx <span class="G">=</span> sz<span class="G">.</span>cx <span class="G">-</span> m<span class="G">.</span>left <span class="G">-</span> m<span class="G">.</span>right <span class="G">-</span> 4 <span class="G">-</span> c <span class="G">*</span> (close<span class="G">.</span>IsShown() <span class="G">+</span> maximize<span class="G">.</span>IsShown());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">!</span>IsNull(icon)) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Image h <span class="G">=</span> icon;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(h<span class="G">.</span>GetWidth() <span class="G">&gt;</span> c <span class="G">||</span> h<span class="G">.</span>GetHeight() <span class="G">&gt;</span> c)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;h <span class="G">=</span> Rescale(h, GetFitSize(h<span class="G">.</span>GetSize(), Size(c)));</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w<span class="G">.</span>DrawImage(tx, m<span class="G">.</span>top <span class="G">+</span> 2, h);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tx <span class="G">+=</span> c;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tcx <span class="G">-=</span> c;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;DrawTextEllipsis(w, tx, m<span class="G">.</span>top <span class="G">+</span> 2, tcx, title, &quot;<span class="G">..</span>&quot;, StdFont(), SColorHighlightText());</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> TopWindowFrame<span class="G">::</span>Layout()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Size sz <span class="G">=</span> GetSize();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Rect m <span class="G">=</span> Margins();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> c <span class="G">=</span> GetStdFontCy() <span class="G">+</span> 4;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> x <span class="G">=</span> sz<span class="G">.</span>cx <span class="G">-</span> m<span class="G">.</span>right;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(close<span class="G">.</span>IsShown())</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;close<span class="G">.</span>SetRect(x <span class="G">-=</span> c, m<span class="G">.</span>top, c, c);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(maximize<span class="G">.</span>IsShown())</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;maximize<span class="G">.</span>SetRect(x <span class="G">-=</span> c, m<span class="G">.</span>top, c, c);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="H"><span class="I">Rect TopWindowFrame</span>::<span class="I">GetClient() </span>const</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Rect r <span class="G">=</span> GetRect();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Rect m <span class="G">=</span> Margins();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;r<span class="G">.</span>left <span class="G">+=</span> m<span class="G">.</span>left;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;r<span class="G">.</span>right <span class="G">-=</span> m<span class="G">.</span>right;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;r<span class="G">.</span>top <span class="G">+=</span> m<span class="G">.</span>top;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;r<span class="G">.</span>bottom <span class="G">-=</span> m<span class="G">.</span>bottom;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;r<span class="G">.</span>top <span class="G">+=</span> GetStdFontCy() <span class="G">+</span> 4;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> r;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">Rect TopWindowFrame<span class="G">::</span>ComputeClient(Rect r)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Rect m <span class="G">=</span> Margins();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;r<span class="G">.</span>left <span class="G">-=</span> m<span class="G">.</span>left;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;r<span class="G">.</span>right <span class="G">+=</span> m<span class="G">.</span>right;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;r<span class="G">.</span>top <span class="G">-=</span> m<span class="G">.</span>top;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;r<span class="G">.</span>bottom <span class="G">+=</span> m<span class="G">.</span>bottom;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;r<span class="G">.</span>top <span class="G">-=</span> GetStdFontCy() <span class="G">+</span> 4;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> r;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> TopWindowFrame<span class="G">::</span>SetClient(Rect r)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;SetRect(ComputeClient(r));&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">Point TopWindowFrame<span class="G">::</span>GetDragMode(Point p)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Size sz <span class="G">=</span> GetSize();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Rect m <span class="G">=</span> ChMargins(FBImg<span class="G">::</span>border());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Point dir;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;dir<span class="G">.</span>y <span class="G">=</span> p<span class="G">.</span>y <span class="G">&lt;</span> m<span class="G">.</span>top <span class="G">?</span> <span class="G">-</span>1 <span class="G">:</span> p<span class="G">.</span>y <span class="G">&gt;</span> sz<span class="G">.</span>cy <span class="G">-</span> m<span class="G">.</span>top <span class="G">?</span> 1 <span class="G">:</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;dir<span class="G">.</span>x <span class="G">=</span> p<span class="G">.</span>x <span class="G">&lt;</span> m<span class="G">.</span>left <span class="G">?</span> <span class="G">-</span>1 <span class="G">:</span> p<span class="G">.</span>x <span class="G">&gt;</span> sz<span class="G">.</span>cx <span class="G">-</span> m<span class="G">.</span>right <span class="G">?</span> 1 <span class="G">:</span> 0;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> dir;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> TopWindowFrame<span class="G">::</span>StartDrag()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(maximized)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">!</span>sizeable <span class="G">&amp;&amp;</span> (dir<span class="G">.</span>x <span class="G">||</span> dir<span class="G">.</span>y))</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(FullWindowDrag) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetCapture();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;startrect <span class="G">=</span> GetRect();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;startpos <span class="G">=</span> GetMousePos();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">else</span> {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Rect r <span class="G">=</span> GetScreenRect();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RectTracker tr(<span class="G">*this</span>);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tr<span class="G">.</span>SetCursorImage(GetDragImage(dir))</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<span class="G">.</span>MaxRect(framebuffer<span class="G">.</span>GetSize())</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<span class="G">.</span>MinSize(ComputeClient(minsize)<span class="G">.</span>GetSize())</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<span class="G">.</span>Pattern(DRAWDRAGRECT_DASHED <span class="G">|</span> DRAWDRAGRECT_SCREEN)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<span class="G">.</span>Width(2)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<span class="G">.</span>Animation();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PaintLock<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r <span class="G">=</span> tr<span class="G">.</span>Track(r, dir<span class="G">.</span>x <span class="G">&lt;</span> 0 <span class="G">?</span> ALIGN_LEFT <span class="G">:</span> dir<span class="G">.</span>x <span class="G">&gt;</span> 0 <span class="G">?</span> ALIGN_RIGHT <span class="G">:</span> ALIGN_CENTER,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dir<span class="G">.</span>y <span class="G">&lt;</span> 0 <span class="G">?</span> ALIGN_TOP <span class="G">:</span> dir<span class="G">.</span>y <span class="G">&gt;</span> 0 <span class="G">?</span> ALIGN_BOTTOM <span class="G">:</span> ALIGN_CENTER);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PaintLock<span class="G">--</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetRect(r);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;LLOG(&quot;START DRAG <span class="G">---------------</span>&quot;);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> TopWindowFrame<span class="G">::</span>GripResize()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;dir <span class="G">=</span> Point(1, 1);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;StartDrag();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> TopWindowFrame<span class="G">::</span>LeftDown(Point p, dword keyflags)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;dir <span class="G">=</span> GetDragMode(p);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(dir<span class="G">.</span>x <span class="G">||</span> dir<span class="G">.</span>y <span class="G">||</span> FullWindowDrag)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StartDrag();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">else</span> {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetCapture();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;holding <span class="G">=</span> <span class="G">true</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hold<span class="G">.</span>Set(GetKbdDelay() <span class="G">/</span> 3, THISBACK(Hold));</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> TopWindowFrame<span class="G">::</span>CancelMode()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;holding <span class="G">=</span> <span class="G">false</span>;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> TopWindowFrame<span class="G">::</span>LeftUp(Point p, dword keyflags)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;holding <span class="G">=</span> <span class="G">false</span>;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> TopWindowFrame<span class="G">::</span>Hold()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(HasCapture()) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(HasMouse() <span class="G">&amp;&amp;</span> GetMouseLeft() <span class="G">&amp;&amp;</span> holding)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StartDrag();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReleaseCapture();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;holding <span class="G">=</span> <span class="G">false</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> TopWindowFrame<span class="G">::</span>LeftHold(Point p, dword keyflags)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(HasCapture() <span class="G">||</span> FullWindowDrag)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;dir <span class="G">=</span> GetDragMode(p);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">!</span>dir<span class="G">.</span>x <span class="G">&amp;&amp;</span> <span class="G">!</span>dir<span class="G">.</span>y)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StartDrag();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> TopWindowFrame<span class="G">::</span>LeftDouble(Point p, dword keyflags)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ToggleMaximize();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;IgnoreMouseUp();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> TopWindowFrame<span class="G">::</span>MouseMove(Point, dword)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;LDUMP(HasWndCapture());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;LDUMP(HasCapture());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">!</span>HasCapture() <span class="G">||</span> holding)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Size msz <span class="G">=</span> ComputeClient(minsize)<span class="G">.</span>GetSize();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Point p <span class="G">=</span> GetMousePos() <span class="G">-</span> startpos;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Rect r <span class="G">=</span> startrect;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(dir<span class="G">.</span>x <span class="G">==</span> <span class="G">-</span>1)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r<span class="G">.</span>left <span class="G">=</span> min(r<span class="G">.</span>left <span class="G">+</span> p<span class="G">.</span>x, startrect<span class="G">.</span>right <span class="G">-</span> msz<span class="G">.</span>cx);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(dir<span class="G">.</span>x <span class="G">==</span> 1)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r<span class="G">.</span>right <span class="G">=</span> max(r<span class="G">.</span>right <span class="G">+</span> p<span class="G">.</span>x, startrect<span class="G">.</span>left <span class="G">+</span> msz<span class="G">.</span>cx);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(dir<span class="G">.</span>y <span class="G">==</span> <span class="G">-</span>1)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r<span class="G">.</span>top <span class="G">=</span> min(r<span class="G">.</span>top <span class="G">+</span> p<span class="G">.</span>y, startrect<span class="G">.</span>bottom <span class="G">-</span> msz<span class="G">.</span>cy);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(dir<span class="G">.</span>y <span class="G">==</span> 1)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r<span class="G">.</span>bottom <span class="G">=</span> max(r<span class="G">.</span>bottom <span class="G">+</span> p<span class="G">.</span>y, startrect<span class="G">.</span>top <span class="G">+</span> msz<span class="G">.</span>cy);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(dir<span class="G">.</span>y <span class="G">==</span> 0 <span class="G">&amp;&amp;</span> dir<span class="G">.</span>x <span class="G">==</span> 0)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r<span class="G">.</span>Offset(p);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;SetRect(r);</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">Image TopWindowFrame<span class="G">::</span>GetDragImage(Point dir)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">static</span> Image (<span class="G">*</span>im<span class="G">[</span>9<span class="G">]</span>)() <span class="G">=</span> {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Image<span class="G">::</span>SizeTopLeft, Image<span class="G">::</span>SizeLeft, Image<span class="G">::</span>SizeBottomLeft,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Image<span class="G">::</span>SizeTop, Image<span class="G">::</span>Arrow, Image<span class="G">::</span>SizeBottom,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Image<span class="G">::</span>SizeTopRight, Image<span class="G">::</span>SizeRight, Image<span class="G">::</span>SizeBottomRight,</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;};</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> (<span class="G">*</span>im<span class="G">[</span>(dir<span class="G">.</span>x <span class="G">+</span> 1) <span class="G">*</span> 3 <span class="G">+</span> (dir<span class="G">.</span>y <span class="G">+</span> 1)<span class="G">]</span>)();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">Image TopWindowFrame<span class="G">::</span>CursorImage(Point p, dword)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">!</span>sizeable)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> Image<span class="G">::</span>Arrow();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> GetDragImage(HasCapture() <span class="G">?</span> dir <span class="G">:</span> GetDragMode(p));</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">END_UPP_NAMESPACE</p>
<p class="F">&nbsp;</p>
<p class="H">#endif</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="E">Event.cpp</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#include</span> &quot;Fb<span class="G">.</span>h&quot;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#ifdef</span> GUI_FB</p>
<p class="F">&nbsp;</p>
<p class="F">NAMESPACE_UPP</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#define</span> LLOG(x) <span class="G">//</span>DLOG(x)</p>
<p class="F"><span class="G">#define</span> LDUMP(x) <span class="G">//</span>DDUMP(x)</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">static</span> Point fbmousepos;</p>
<p class="F">&nbsp;</p>
<p class="F">Point GetMousePos() {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> fbmousepos;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>MouseEventFB(Ptr<span class="G">&lt;</span>Ctrl<span class="G">&gt;</span> t, <span class="G">int</span> event, Point p, <span class="G">int</span> zdelta)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">!</span>t<span class="G">-&gt;</span>IsEnabled())</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Rect rr <span class="G">=</span> t<span class="G">-&gt;</span>GetRect();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>((event <span class="G">&amp;</span> Ctrl<span class="G">::</span>ACTION) <span class="G">==</span> DOWN) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ptr<span class="G">&lt;</span>Ctrl<span class="G">&gt;</span> q <span class="G">=</span> t;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TopWindowFrame <span class="G">*</span>wf <span class="G">=</span> <span class="G">dynamic_cast&lt;</span>TopWindowFrame <span class="G">*&gt;</span>(<span class="G">~</span>t);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(wf)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;q <span class="G">=</span> wf<span class="G">-&gt;</span>window;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(q) q<span class="G">-&gt;</span>ClickActivateWnd();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(q) q<span class="G">-&gt;</span>SetForeground();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(ignoreclick)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(t)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t<span class="G">-&gt;</span>DispatchMouse(event, p <span class="G">-</span> rr<span class="G">.</span>TopLeft(), zdelta);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(t)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t<span class="G">-&gt;</span>PostInput();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">Ctrl <span class="G">*</span>Ctrl<span class="G">::</span>FindMouseTopCtrl()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> topctrl<span class="G">.</span>GetCount() <span class="G">-</span> 1; i <span class="G">&gt;=</span> 0; i<span class="G">--</span>) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ctrl <span class="G">*</span>t <span class="G">=</span> topctrl<span class="G">[</span>i<span class="G">]</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(t<span class="G">-&gt;</span>GetRect()<span class="G">.</span>Contains(fbmousepos))</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> t<span class="G">-&gt;</span>IsEnabled() <span class="G">?</span> t <span class="G">:</span> NULL;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> desktop<span class="G">-&gt;</span>IsEnabled() <span class="G">?</span> desktop <span class="G">:</span> NULL;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>DoMouseFB(<span class="G">int</span> event, Point p, <span class="G">int</span> zdelta)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;fbmousepos <span class="G">=</span> p;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">int</span> a <span class="G">=</span> event <span class="G">&amp;</span> Ctrl<span class="G">::</span>ACTION;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(a <span class="G">==</span> Ctrl<span class="G">::</span>UP <span class="G">&amp;&amp;</span> Ctrl<span class="G">::</span>ignoreclick) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EndIgnore();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(a <span class="G">==</span> Ctrl<span class="G">::</span>DOWN <span class="G">&amp;&amp;</span> ignoreclick)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;LLOG(&quot;<span class="G">###</span> Mouse event<span class="G">:</span> &quot; <span class="G">&lt;&lt;</span> event <span class="G">&lt;&lt;</span> &quot; position &quot; <span class="G">&lt;&lt;</span> p <span class="G">&lt;&lt;</span> &quot; zdelta &quot; <span class="G">&lt;&lt;</span> zdelta <span class="G">&lt;&lt;</span> &quot;, capture &quot; <span class="G">&lt;&lt;</span> Upp<span class="G">::</span>Name(captureCtrl));</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(captureCtrl)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MouseEventFB(captureCtrl<span class="G">-&gt;</span>GetTopCtrl(), event, p, zdelta);</p>
<p class="H"><span class="I">&nbsp;&nbsp;&nbsp;&nbsp;</span>else</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> i <span class="G">=</span> topctrl<span class="G">.</span>GetCount() <span class="G">-</span> 1; i <span class="G">&gt;=</span> 0; i<span class="G">--</span>) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ptr<span class="G">&lt;</span>Ctrl<span class="G">&gt;</span> t <span class="G">=</span> topctrl<span class="G">[</span>i<span class="G">]</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Rect rr <span class="G">=</span> t<span class="G">-&gt;</span>GetRect();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(rr<span class="G">.</span>Contains(p)) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MouseEventFB(t, event, p, zdelta);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Ctrl <span class="G">*</span>desktop <span class="G">=</span> GetDesktop();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(desktop) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;desktop<span class="G">-&gt;</span>DispatchMouse(event, p, zdelta);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;desktop<span class="G">-&gt;</span>PostInput();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">bool</span> Ctrl<span class="G">::</span>DoKeyFB(dword key, <span class="G">int</span> cnt)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">bool</span> b <span class="G">=</span> DispatchKey(key, cnt);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;SyncCaret();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Ctrl <span class="G">*</span>desktop <span class="G">=</span> GetDesktop();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(desktop)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;desktop<span class="G">-&gt;</span>PostInput();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> b;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">Image Ctrl<span class="G">::</span>GetBak(Rect<span class="G">&amp;</span> tr)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Image bak;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;tr<span class="G">.</span>Intersect(framebuffer<span class="G">.</span>GetSize());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">!</span>tr<span class="G">.</span>IsEmpty()) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Image h <span class="G">=</span> framebuffer;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bak <span class="G">=</span> CreateImage(tr<span class="G">.</span>GetSize(), Black);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Copy(bak, Point(0, 0), h, tr);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;framebuffer <span class="G">=</span> h;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> bak;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>RemoveCursor()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">!</span>IsNull(fbCursorBakPos)) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Copy(framebuffer, fbCursorBakPos, fbCursorBak, fbCursorBak<span class="G">.</span>GetSize());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AddUpdate(Rect(fbCursorBakPos, fbCursorBak<span class="G">.</span>GetSize()));</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;fbCursorPos <span class="G">=</span> fbCursorBakPos <span class="G">=</span> Null;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;fbCursorBak <span class="G">=</span> Null;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>RemoveCaret()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">!</span>IsNull(fbCaretRect)) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Copy(framebuffer, fbCaretRect<span class="G">.</span>TopLeft(), fbCaretBak, fbCaretBak<span class="G">.</span>GetSize());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AddUpdate(fbCaretRect);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;fbCaretRect <span class="G">=</span> Null;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;fbCaretBak <span class="G">=</span> Null;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>SetCaret(<span class="G">int</span> x, <span class="G">int</span> y, <span class="G">int</span> cx, <span class="G">int</span> cy)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;caretx <span class="G">=</span> x;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;carety <span class="G">=</span> y;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;caretcx <span class="G">=</span> cx;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;caretcy <span class="G">=</span> cy;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;fbCaretTm <span class="G">=</span> GetTickCount();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;SyncCaret();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>SyncCaret()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> Ctrl<span class="G">::</span>CursorSync()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;LLOG(&quot;@ CursorSync&quot;);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Point p <span class="G">=</span> GetMousePos() <span class="G">-</span> fbCursorImage<span class="G">.</span>GetHotSpot();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;Rect cr <span class="G">=</span> Null;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(focusCtrl <span class="G">&amp;&amp;</span> (((GetTickCount() <span class="G">-</span> fbCaretTm) <span class="G">/</span> 500) <span class="G">&amp;</span> 1) <span class="G">==</span> 0)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cr <span class="G">=</span> (RectC(focusCtrl<span class="G">-&gt;</span>caretx, focusCtrl<span class="G">-&gt;</span>carety, focusCtrl<span class="G">-&gt;</span>caretcx, focusCtrl<span class="G">-&gt;</span>caretcy)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">+</span> focusCtrl<span class="G">-&gt;</span>GetScreenView()<span class="G">.</span>TopLeft()) <span class="G">&amp;</span> focusCtrl<span class="G">-&gt;</span>GetScreenView();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;LDUMP(GetTickCount());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(fbCursorPos <span class="G">!=</span> p <span class="G">||</span> cr <span class="G">!=</span> fbCaretRect) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LDUMP(fbCaretRect);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RemoveCursor();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RemoveCaret();</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fbCursorPos <span class="G">=</span> p;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Size sz <span class="G">=</span> fbCursorImage<span class="G">.</span>GetSize();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Rect tr(p, sz);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fbCursorBak <span class="G">=</span> GetBak(tr);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fbCursorBakPos <span class="G">=</span> tr<span class="G">.</span>TopLeft();</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fbCaretRect <span class="G">=</span> cr;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(<span class="G">!</span>cr<span class="G">.</span>IsEmpty()) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fbCaretBak <span class="G">=</span> GetBak(cr);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">for</span>(<span class="G">int</span> y <span class="G">=</span> cr<span class="G">.</span>top; y <span class="G">&lt;</span> cr<span class="G">.</span>bottom; y<span class="G">++</span>) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RGBA <span class="G">*</span>s <span class="G">=</span> framebuffer<span class="G">[</span>y<span class="G">]</span> <span class="G">+</span> cr<span class="G">.</span>left;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">const</span> RGBA <span class="G">*</span>e <span class="G">=</span> framebuffer<span class="G">[</span>y<span class="G">]</span> <span class="G">+</span> cr<span class="G">.</span>right;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">while</span>(s <span class="G">&lt;</span> e) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span class="G">-&gt;</span>r <span class="G">=</span> <span class="G">~</span>s<span class="G">-&gt;</span>r;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span class="G">-&gt;</span>g <span class="G">=</span> <span class="G">~</span>s<span class="G">-&gt;</span>g;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span class="G">-&gt;</span>b <span class="G">=</span> <span class="G">~</span>s<span class="G">-&gt;</span>b;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AddUpdate(fbCaretRect);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Over(framebuffer, p, fbCursorImage, sz);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LLOG(&quot;Cursor<span class="G">:</span> &quot; <span class="G">&lt;&lt;</span> p <span class="G">&lt;&lt;</span> &quot;, rect &quot; <span class="G">&lt;&lt;</span> tr);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AddUpdate(tr);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> &nbsp;Ctrl<span class="G">::</span>SetMouseCursor(<span class="G">const</span> Image<span class="G">&amp;</span> image)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(image<span class="G">.</span>GetSerialId() <span class="G">!=</span> fbCursorImage<span class="G">.</span>GetSerialId()) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fbCursorImage <span class="G">=</span> image;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fbCursorPos <span class="G">=</span> Null;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">END_UPP_NAMESPACE</p>
<p class="F">&nbsp;</p>
<p class="H">#endif</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="E">ChSysInit.cpp</p>
<p class="F">&nbsp;</p>
<p class="H">#include<span class="I"> </span>&lt;<span class="I">CtrlLib</span>/<span class="I">CtrlLib</span>.<span class="I">h</span>&gt;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#ifdef</span> GUI_FB</p>
<p class="F">&nbsp;</p>
<p class="F">NAMESPACE_UPP</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> ChSysInit()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;CtrlImg<span class="G">::</span>Reset();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;CtrlsImg<span class="G">::</span>Reset();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ChReset();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> ChHostSkin()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ChSysInit();</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">END_UPP_NAMESPACE</p>
<p class="F">&nbsp;</p>
<p class="H">#endif</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="E">Image.cpp</p>
<p class="F">&nbsp;</p>
<p class="H">#include<span class="I"> </span>&lt;<span class="I">CtrlCore</span>/<span class="I">CtrlCore</span>.<span class="I">h</span>&gt;</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#ifdef</span> GUI_FB</p>
<p class="F">&nbsp;</p>
<p class="F">NAMESPACE_UPP</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#define</span> LTIMING(x) <span class="G">//</span> RTIMING(x)</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> SetSurface(SystemDraw<span class="G">&amp;</span> w, <span class="G">int</span> x, <span class="G">int</span> y, <span class="G">int</span> cx, <span class="G">int</span> cy, <span class="G">const</span> RGBA <span class="G">*</span>pixels)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">void</span> SetSurface(SystemDraw<span class="G">&amp;</span> w, <span class="G">const</span> Rect<span class="G">&amp;</span> dest, <span class="G">const</span> RGBA <span class="G">*</span>pixels, Size psz, Point poff)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;GuiLock __;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="H"><span class="I">Image ImageDraw</span>::<span class="I">Get(</span>bool<span class="I"> pm) </span>const</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;ImageBuffer result(image<span class="G">.</span>GetSize());</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">const</span> RGBA <span class="G">*</span>e <span class="G">=</span> image<span class="G">.</span>End();</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">const</span> RGBA <span class="G">*</span>p <span class="G">=</span> <span class="G">~</span>image;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;RGBA <span class="G">*</span>t <span class="G">=</span> <span class="G">~</span>result;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(has_alpha) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">const</span> RGBA <span class="G">*</span>a <span class="G">=</span> <span class="G">~</span>alpha;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">while</span>(p <span class="G">&lt;</span> e) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">*</span>t <span class="G">=</span> <span class="G">*</span>p<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(t<span class="G">++</span>)<span class="G">-&gt;</span>a <span class="G">=</span> (a<span class="G">++</span>)<span class="G">-&gt;</span>r;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">if</span>(pm)</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Premultiply(result);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result<span class="G">.</span>SetKind(IMAGE_ALPHA);</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">else</span> {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">while</span>(p <span class="G">&lt;</span> e) {</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">*</span>t <span class="G">=</span> <span class="G">*</span>p<span class="G">++</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(t<span class="G">++</span>)<span class="G">-&gt;</span>a <span class="G">=</span> 255;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> result;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">Draw<span class="G">&amp;</span> ImageDraw<span class="G">::</span>Alpha()</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;has_alpha <span class="G">=</span> <span class="G">true</span>;</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;<span class="G">return</span> alpha_painter;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F">ImageDraw<span class="G">::</span>ImageDraw(Size sz)</p>
<p class="F"><span class="G">:</span>&nbsp;&nbsp;&nbsp;&nbsp;ImageDraw__(sz<span class="G">.</span>cx, sz<span class="G">.</span>cy),</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;BufferPainter(image),</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;alpha_painter(alpha)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;has_alpha <span class="G">=</span> <span class="G">false</span>;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F">ImageDraw<span class="G">::</span>ImageDraw(<span class="G">int</span> cx, <span class="G">int</span> cy)</p>
<p class="F"><span class="G">:</span>&nbsp;&nbsp;&nbsp;&nbsp;ImageDraw__(cx, cy),</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;BufferPainter(image),</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;alpha_painter(alpha)</p>
<p class="F">{</p>
<p class="F">&nbsp;&nbsp;&nbsp;&nbsp;has_alpha <span class="G">=</span> <span class="G">false</span>;</p>
<p class="F">}</p>
<p class="F">&nbsp;</p>
<p class="F"><span class="G">#define</span> IMAGECLASS FBImg</p>
<p class="H">#define<span class="I"> IMAGEFILE </span>&lt;<span class="I">Framebuffer</span>/<span class="I">FB</span>.<span class="I">iml</span>&gt;</p>
<p class="H">#include<span class="I"> </span>&lt;<span class="I">Draw</span>/<span class="I">iml_source</span>.<span class="I">h</span>&gt;</p>
<p class="F">&nbsp;</p>
<p class="F">Image Image<span class="G">::</span>Arrow() { <span class="G">return</span> FBImg<span class="G">::</span>arrow(); }</p>
<p class="F">Image Image<span class="G">::</span>Wait() { <span class="G">return</span> FBImg<span class="G">::</span>wait(); }</p>
<p class="F">Image Image<span class="G">::</span>IBeam() { <span class="G">return</span> FBImg<span class="G">::</span>ibeam(); }</p>
<p class="F">Image Image<span class="G">::</span>No() { <span class="G">return</span> FBImg<span class="G">::</span>no(); }</p>
<p class="F">Image Image<span class="G">::</span>SizeAll() { <span class="G">return</span> FBImg<span class="G">::</span>sizeall(); }</p>
<p class="F">Image Image<span class="G">::</span>SizeHorz() { <span class="G">return</span> FBImg<span class="G">::</span>sizehorz(); }</p>
<p class="F">Image Image<span class="G">::</span>SizeVert() { <span class="G">return</span> FBImg<span class="G">::</span>sizevert(); }</p>
<p class="F">Image Image<span class="G">::</span>SizeTopLeft() { <span class="G">return</span> FBImg<span class="G">::</span>sizetopleft(); }</p>
<p class="F">Image Image<span class="G">::</span>SizeTop() { <span class="G">return</span> FBImg<span class="G">::</span>sizetop(); }</p>
<p class="F">Image Image<span class="G">::</span>SizeTopRight() { <span class="G">return</span> FBImg<span class="G">::</span>sizetopright(); }</p>
<p class="F">Image Image<span class="G">::</span>SizeLeft() { <span class="G">return</span> FBImg<span class="G">::</span>sizeleft(); }</p>
<p class="F">Image Image<span class="G">::</span>SizeRight() { <span class="G">return</span> FBImg<span class="G">::</span>sizeright(); }</p>
<p class="F">Image Image<span class="G">::</span>SizeBottomLeft() { <span class="G">return</span> FBImg<span class="G">::</span>sizebottomleft(); }</p>
<p class="F">Image Image<span class="G">::</span>SizeBottom() { <span class="G">return</span> FBImg<span class="G">::</span>sizebottom(); }</p>
<p class="F">Image Image<span class="G">::</span>SizeBottomRight() { <span class="G">return</span> FBImg<span class="G">::</span>sizebottomright(); }</p>
<p class="F">Image Image<span class="G">::</span>Hand() { <span class="G">return</span> FBImg<span class="G">::</span>hand(); }</p>
<p class="F">&nbsp;</p>
<p class="F">END_UPP_NAMESPACE</p>
<p class="F">&nbsp;</p>
<p class="H">#endif</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
<p class="F">&nbsp;</p>
</TD>
</TR>
</TABLE>
</TD>
</TR>
</TABLE>
<TABLE BORDER="0" WIDTH="100%"><TR><TD></TD>
</TR>
</TABLE>
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="0" BGCOLOR="#FFFFFF" WIDTH="100%" style="border-style: solid; border-width: 1px; border-color: #6E89AE;padding: 10px;;"><TR><TD><TABLE BORDER="0" CELLSPACING="0" CELLPADDING="0" WIDTH="100%"><TR><TD><p class="A"><span class="B"> </span><a href="www$uppweb$contribweb$en-us.html">Do you want to contribute?</a></p>
</TD>
</TR>
</TABLE>
</TD>
</TR>
</TABLE>
</TD>
</TR>
</TABLE>
<script type="text/javascript">var a={'reference$Framebuffer$en-us.html':'English'};var p=window.location.pathname.split("/");p=p[p.length-1];var s='<select id="lang" onchange="window.location=document.getElementById(\'lang\').value;">';for(l in a){if(p==l){d=" selected=1"}else{d=""}s+='<option value="'+l+'"'+d+'>'+a[l]+'</option>'}s+='</select>';var d=document.createElement('div');d.innerHTML=s;var c=document.getElementById('langs');c.replaceChild(d,c.firstChild);document.getElementById('langbox').style.display='block';</script></BODY>
